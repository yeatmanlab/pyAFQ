
.. DO NOT EDIT.
.. THIS FILE WAS AUTOMATICALLY GENERATED BY SPHINX-GALLERY.
.. TO MAKE CHANGES, EDIT THE SOURCE PYTHON FILE:
.. "auto_examples/plot_bids_layout.py"
.. LINE NUMBERS ARE GIVEN BELOW.

.. only:: html

    .. note::
        :class: sphx-glr-download-link-note

        Click :ref:`here <sphx_glr_download_auto_examples_plot_bids_layout.py>`
        to download the full example code

.. rst-class:: sphx-glr-example-title

.. _sphx_glr_auto_examples_plot_bids_layout.py:


====================
How pyAFQ uses BIDS
====================

The pyAFQ API relies heavily on the
`Brain Imaging Data Standard (BIDS) <https://bids-specification.readthedocs.io/en/stable/>`_. This means that the software assumes that its inputs are organized
according to the BIDS spec and its outputs conform where possible with the
BIDS spec.

.. note::

    Derivatives of processing diffusion MRI are not currently fully
    described in the existing BIDS specification, but describing these
    is part of an ongoing effort. Wherever possible, we conform with
    the draft implementation of the BIDS DWI derivatives available
    `here <https://bids-specification.readthedocs.io/en/wip-derivatives/05-derivatives/05-diffusion-derivatives.html>`_

In this example, we will explore the use of BIDS in pyAFQ and see
how BIDS allows us to extend and provide flexibility to the users
of the software.

.. GENERATED FROM PYTHON SOURCE LINES 24-35

.. code-block:: default


    import os
    import os.path as op

    import matplotlib.pyplot as plt
    import nibabel as nib

    from AFQ import api
    import AFQ.data as afd









.. GENERATED FROM PYTHON SOURCE LINES 36-38

To interact with and query BIDS datasets, we use
 `pyBIDS <https://bids-standard.github.io/pybids/>`_.

.. GENERATED FROM PYTHON SOURCE LINES 38-42

.. code-block:: default


    import bids









.. GENERATED FROM PYTHON SOURCE LINES 43-49

We start with some example data. The data we will use here is
generated from the
`Stanford HARDI dataset <https://purl.stanford.edu/ng782rw8378>`_.
The call below fetches
this dataset and organized it within the `~/AFQ_data` folder in the BIDS
format.

.. GENERATED FROM PYTHON SOURCE LINES 49-52

.. code-block:: default


    afd.organize_stanford_data(clear_previous_afq=True)








.. GENERATED FROM PYTHON SOURCE LINES 53-89

After doing that, we should have a folder that looks like this:

| stanford_hardi
| ├── dataset_description.json
| └── derivatives
|     ├── freesurfer
|     │   ├── dataset_description.json
|     │   └── sub-01
|     │       └── ses-01
|     │           └── anat
|     │               ├── sub-01_ses-01_T1w.nii.gz
|     │               └── sub-01_ses-01_seg.nii.gz
|     └── vistasoft
|         ├── dataset_description.json
|         └── sub-01
|             └── ses-01
|                 └── dwi
|                     ├── sub-01_ses-01_dwi.bvals
|                     ├── sub-01_ses-01_dwi.bvecs
|                     └── sub-01_ses-01_dwi.nii.gz

The top level directory is our overall bids dataset folder. In most
cases, this folder will include a `raw` folder that will contain the
raw data. In this case, we do not include the raw folder and only have
the pipelines that contains the outputs of preprocessing the data.
In general, only the preprocessed diffusion data is required.
See the "Organizing your data" section of "Using pyAFQ" for more details.
In this case, one folder containing Freesurfer derivatives and another
folder containing the DWI data that has been preprocessed with Vistasoft.
pyAFQ provides facilities to segment tractography results obtained
using other software. For example, we often use
`qsiprep <https://qsiprep.readthedocs.io/en/latest/>`_ to preprocess
our data and reconstruct tractographies with software such as
`MRTRIX <https://www.mrtrix.org/>`_. Here, we will demonstrate how to use
these reconstructions in the pyAFQ segmentation and tractometry pipeline
We fetch this data and add it as a separate pipeline

.. GENERATED FROM PYTHON SOURCE LINES 89-113

.. code-block:: default


    afd.fetch_stanford_hardi_tractography()

    bids_path = op.join(op.expanduser('~'), 'AFQ_data', 'stanford_hardi')
    tractography_path = op.join(bids_path, 'derivatives', 'my_tractography')
    sub_path = op.join(tractography_path, 'sub-01', 'ses-01', 'dwi')

    os.makedirs(sub_path, exist_ok=True)
    os.rename(
        op.join(
            op.expanduser('~'),
            'AFQ_data',
            'stanford_hardi_tractography',
            'full_segmented_cleaned_tractography.trk'),
        op.join(
            sub_path,
            'sub-01_ses-01-dwi_tractography.trk'))

    afd.to_bids_description(
        tractography_path,
        **{"Name": "my_tractography",
            "PipelineDescription": {"Name": "my_tractography"}})






.. rst-class:: sphx-glr-script-out

 Out:

 .. code-block:: none

      0%|          | 0/11337 [00:00<?, ? MB/s]      0%|          | 4/11337 [00:00<08:13, 22.96 MB/s]      0%|          | 10/11337 [00:00<06:23, 29.57 MB/s]      0%|          | 34/11337 [00:00<02:23, 78.52 MB/s]      1%|1         | 135/11337 [00:00<00:40, 274.87 MB/s]      4%|3         | 431/11337 [00:00<00:11, 928.13 MB/s]      5%|5         | 618/11337 [00:00<00:10, 1008.81 MB/s]      8%|8         | 927/11337 [00:01<00:06, 1510.14 MB/s]     10%|#         | 1165/11337 [00:01<00:06, 1492.26 MB/s]     13%|#2        | 1446/11337 [00:01<00:05, 1807.79 MB/s]     15%|#5        | 1714/11337 [00:01<00:05, 1748.37 MB/s]     18%|#7        | 2000/11337 [00:01<00:04, 2010.85 MB/s]     20%|##        | 2268/11337 [00:01<00:04, 1882.72 MB/s]     22%|##2       | 2536/11337 [00:01<00:04, 2071.27 MB/s]     25%|##4       | 2834/11337 [00:02<00:04, 1986.75 MB/s]     27%|##7       | 3092/11337 [00:02<00:03, 2127.18 MB/s]     30%|##9       | 3376/11337 [00:02<00:03, 1990.89 MB/s]     32%|###2      | 3653/11337 [00:02<00:03, 2174.00 MB/s]     35%|###4      | 3941/11337 [00:02<00:03, 2027.01 MB/s]     37%|###6      | 4179/11337 [00:02<00:03, 2110.14 MB/s]     40%|###9      | 4479/11337 [00:02<00:02, 2335.66 MB/s]     42%|####1     | 4724/11337 [00:02<00:03, 2045.37 MB/s]     44%|####3     | 4976/11337 [00:03<00:02, 2161.25 MB/s]     46%|####6     | 5230/11337 [00:03<00:03, 1979.45 MB/s]     48%|####8     | 5471/11337 [00:03<00:02, 2085.21 MB/s]     51%|#####     | 5730/11337 [00:03<00:02, 2216.37 MB/s]     53%|#####2    | 5969/11337 [00:03<00:02, 1992.04 MB/s]     55%|#####4    | 6206/11337 [00:03<00:02, 2087.47 MB/s]     57%|#####7    | 6488/11337 [00:03<00:02, 2276.82 MB/s]     59%|#####9    | 6724/11337 [00:03<00:02, 2013.70 MB/s]     62%|######1   | 6978/11337 [00:03<00:02, 2148.33 MB/s]     64%|######3   | 7247/11337 [00:04<00:01, 2292.76 MB/s]     66%|######6   | 7485/11337 [00:04<00:01, 2014.93 MB/s]     68%|######8   | 7736/11337 [00:04<00:01, 2141.49 MB/s]     71%|#######   | 8013/11337 [00:04<00:01, 2309.43 MB/s]     73%|#######2  | 8254/11337 [00:04<00:01, 2028.29 MB/s]     75%|#######4  | 8502/11337 [00:04<00:01, 2143.51 MB/s]     77%|#######7  | 8784/11337 [00:04<00:01, 2044.91 MB/s]     79%|#######9  | 9001/11337 [00:04<00:01, 2072.21 MB/s]     82%|########1 | 9260/11337 [00:05<00:00, 2204.91 MB/s]     84%|########3 | 9522/11337 [00:05<00:00, 2047.37 MB/s]     86%|########5 | 9747/11337 [00:05<00:00, 2077.71 MB/s]     88%|########8 | 10006/11337 [00:05<00:00, 2204.05 MB/s]     91%|######### | 10271/11337 [00:05<00:00, 2072.22 MB/s]     93%|#########2| 10497/11337 [00:05<00:00, 2101.67 MB/s]     95%|#########4| 10756/11337 [00:05<00:00, 2218.96 MB/s]     97%|#########7| 11021/11337 [00:05<00:00, 2082.46 MB/s]     99%|#########9| 11247/11337 [00:05<00:00, 2111.29 MB/s]    100%|##########| 11337/11337 [00:05<00:00, 1892.34 MB/s]
      0%|          | 0/14 [00:00<?, ? MB/s]     29%|##8       | 4/14 [00:00<00:00, 22.95 MB/s]     71%|#######1  | 10/14 [00:00<00:00, 29.64 MB/s]    100%|##########| 14/14 [00:00<00:00, 39.99 MB/s]
      0%|          | 0/1037 [00:00<?, ? MB/s]      0%|          | 4/1037 [00:00<00:45, 22.95 MB/s]      1%|1         | 12/1037 [00:00<00:28, 36.38 MB/s]      5%|4         | 48/1037 [00:00<00:08, 113.57 MB/s]     19%|#8        | 193/1037 [00:00<00:02, 394.95 MB/s]     42%|####2     | 437/1037 [00:00<00:00, 892.45 MB/s]     70%|#######   | 730/1037 [00:00<00:00, 1218.97 MB/s]     94%|#########4| 975/1037 [00:01<00:00, 1514.92 MB/s]    100%|##########| 1037/1037 [00:01<00:00, 963.22 MB/s]




.. GENERATED FROM PYTHON SOURCE LINES 114-143

After we do that, our dataset folder should look like this:

| stanford_hardi
| ├── dataset_description.json
| └── derivatives
|     ├── freesurfer
|     │   ├── dataset_description.json
|     │   └── sub-01
|     │       └── ses-01
|     │           └── anat
|     │               ├── sub-01_ses-01_T1w.nii.gz
|     │               └── sub-01_ses-01_seg.nii.gz
|     ├── my_tractography
|     |   ├── dataset_description.json
|     │   └── sub-01
|     │       └── ses-01
|     │           └── dwi
|     │               └── sub-01_ses-01-dwi_tractography.trk
|     └── vistasoft
|         ├── dataset_description.json
|         └── sub-01
|             └── ses-01
|                 └── dwi
|                     ├── sub-01_ses-01_dwi.bvals
|                     ├── sub-01_ses-01_dwi.bvecs
|                     └── sub-01_ses-01_dwi.nii.gz

To explore the layout of these derivatives, we will initialize a
:class:`BIDSLayout` class instance to help us see what is in this dataset

.. GENERATED FROM PYTHON SOURCE LINES 143-146

.. code-block:: default


    layout = bids.BIDSLayout(bids_path, derivatives=True)








.. GENERATED FROM PYTHON SOURCE LINES 147-149

Because there is no raw data in this BIDS layout (only derivatives),
pybids will report that there are no subjects and sessions:

.. GENERATED FROM PYTHON SOURCE LINES 149-152

.. code-block:: default


    print(layout)





.. rst-class:: sphx-glr-script-out

 Out:

 .. code-block:: none

    BIDS Layout: ...runner/AFQ_data/stanford_hardi | Subjects: 0 | Sessions: 0 | Runs: 0




.. GENERATED FROM PYTHON SOURCE LINES 153-155

But a query on the derivatives will reveal the different derivatives that
are stored here:

.. GENERATED FROM PYTHON SOURCE LINES 155-158

.. code-block:: default


    print(layout.derivatives)





.. rst-class:: sphx-glr-script-out

 Out:

 .. code-block:: none

    {'freesurfer': BIDS Layout: ...d_hardi/derivatives/freesurfer | Subjects: 1 | Sessions: 1 | Runs: 0, 'my_tractography': BIDS Layout: ...di/derivatives/my_tractography | Subjects: 1 | Sessions: 1 | Runs: 0, 'vistasoft': BIDS Layout: ...rd_hardi/derivatives/vistasoft | Subjects: 1 | Sessions: 1 | Runs: 0}




.. GENERATED FROM PYTHON SOURCE LINES 159-162

We can use a :class:`bids.BIDSValidator` object to make sure that the
files within our data set are BIDS-compliant. For example, we can
extract the tractography derivatives part of our layout using:

.. GENERATED FROM PYTHON SOURCE LINES 162-165

.. code-block:: default


    my_tractography = layout.derivatives["my_tractography"]








.. GENERATED FROM PYTHON SOURCE LINES 166-170

This variable is also a BIDS layout object. This object has a ``get``
method, which allows us to query and find specific items within the
layout. For example, we can ask for files that have a suffix consistent
with tractography results:

.. GENERATED FROM PYTHON SOURCE LINES 170-173

.. code-block:: default


    tractography_files = my_tractography.get(suffix='tractography')








.. GENERATED FROM PYTHON SOURCE LINES 174-175

Or ask for files that have a ``.trk`` extension:

.. GENERATED FROM PYTHON SOURCE LINES 175-178

.. code-block:: default


    tractography_files = my_tractography.get(extension='.trk')








.. GENERATED FROM PYTHON SOURCE LINES 179-180

In this case, both of these would produce the same result.

.. GENERATED FROM PYTHON SOURCE LINES 180-184

.. code-block:: default


    tractography_file = tractography_files[0]
    print(tractography_file)





.. rst-class:: sphx-glr-script-out

 Out:

 .. code-block:: none

    <BIDSFile filename='/home/runner/AFQ_data/stanford_hardi/derivatives/my_tractography/sub-01/ses-01/dwi/sub-01_ses-01-dwi_tractography.trk'>




.. GENERATED FROM PYTHON SOURCE LINES 185-186

We can also get some more structured information about this file:

.. GENERATED FROM PYTHON SOURCE LINES 186-190

.. code-block:: default


    print(tractography_file.get_entities())






.. rst-class:: sphx-glr-script-out

 Out:

 .. code-block:: none

    {'datatype': 'dwi', 'extension': '.trk', 'session': '01', 'subject': '01', 'suffix': 'tractography'}




.. GENERATED FROM PYTHON SOURCE LINES 191-197

We can use a :class:`bids.BIDSValidator` class instance to validate that
this file is compliant with the specification. Note that the validator
requires that the filename be provided relative to the root of the BIDS
dataset, so we have to split the string that contains the full path
of the tractography to extract only the part that is relative to the
root of the entire BIDS ``layout`` object:

.. GENERATED FROM PYTHON SOURCE LINES 197-204

.. code-block:: default


    tractography_full_path = tractography_file.path
    tractography_relative_path = tractography_full_path.split(layout.root)[-1]

    validator = bids.BIDSValidator()
    print(validator.is_bids(tractography_relative_path))





.. rst-class:: sphx-glr-script-out

 Out:

 .. code-block:: none

    True




.. GENERATED FROM PYTHON SOURCE LINES 205-212

Next, we specify the information we need to define the bundles that we are
interested in segmenting. In this case, we are going to use a list of
bundle names for the bundle info. These names refer to bundles for
which we already have clear definitions of the information
needed to segment them (e.g., waypoint ROIs and probability maps).
For an example that includes custom definition of bundle info, see the
`plot_callosal_tract_profile example <http://yeatmanlab.github.io/pyAFQ/auto_examples/plot_callosal_tract_profile.html>`_.

.. GENERATED FROM PYTHON SOURCE LINES 212-215

.. code-block:: default


    bundle_info = ["SLF", "ARC", "CST", "FP"]








.. GENERATED FROM PYTHON SOURCE LINES 216-232

Now, we can define our AFQ object, pointing to the derivatives of the
`'my_tractography'` pipeline as inputs. This is done by setting the
`custom_tractography_bids_filters` key-word argument. We pass the
`bundle_info` defined above. We also point to the preprocessed
data that is in a `'dmriprep'` pipeline. Note that the pipeline name
is not necessarily the name of the folder it is in; the pipeline name is
defined in each pipeline's `dataset_description.json`. These data were
preprocessed with 'vistasoft', so this is the pipeline we'll point to
If we were using `'qsiprep'`, this is where we would pass that
string instead. If we did that, AFQ would look for a derivatives
folder called `'stanford_hardi/derivatives/qsiprep'` and find the
preprocessed DWI data within it. Finally, to speed things up
a bit, we also sub-sample the provided tractography. This is
done by defining the segmentation_params dictionary input.
To sub-sample to 10,000 streamlines, we define
`'nb_streamlines' = 10000`.

.. GENERATED FROM PYTHON SOURCE LINES 232-243

.. code-block:: default


    my_afq = api.AFQ(
        bids_path,
        preproc_pipeline='vistasoft',
        bundle_info=bundle_info,
        custom_tractography_bids_filters={
            "suffix": "tractography",
            "scope": "my_tractography"
        },
        segmentation_params={'nb_streamlines': 10000})








.. GENERATED FROM PYTHON SOURCE LINES 244-247

Finally, to run the segmentation and extract tract profiles, we call
The `export_all` method. This creates all of the derivative outputs of
AFQ within the 'stanford_hardi/derivatives/afq' folder.

.. GENERATED FROM PYTHON SOURCE LINES 247-251

.. code-block:: default


    my_afq.export_all()






.. rst-class:: sphx-glr-script-out

 Out:

 .. code-block:: none

    Optimizing level 2 [max iter: 10000]
    Optimizing level 1 [max iter: 1000]
    Optimizing level 0 [max iter: 100]
    Optimizing level 2 [max iter: 10000]
    Optimizing level 1 [max iter: 1000]
    Optimizing level 0 [max iter: 100]
    Optimizing level 2 [max iter: 10000]
    Optimizing level 1 [max iter: 1000]
    Optimizing level 0 [max iter: 100]
      0%|          | 0/2840 [00:00<?, ?it/s]      0%|          | 1/2840 [00:00<06:35,  7.18it/s]      0%|          | 2/2840 [00:00<06:55,  6.84it/s]      0%|          | 4/2840 [00:06<1:40:23,  2.12s/it]      0%|          | 6/2840 [00:07<54:25,  1.15s/it]       14%|#4        | 400/2840 [00:07<00:21, 112.10it/s]     37%|###6      | 1040/2840 [00:07<00:05, 349.20it/s]     73%|#######2  | 2064/2840 [00:07<00:00, 781.03it/s]     91%|######### | 2576/2840 [00:07<00:00, 937.63it/s]    100%|##########| 2840/2840 [00:07<00:00, 359.72it/s]
      0%|          | 0/1912 [00:00<?, ?it/s]     13%|#2        | 244/1912 [00:00<00:00, 2254.52it/s]     40%|###9      | 756/1912 [00:00<00:00, 3720.45it/s]     80%|#######9  | 1524/1912 [00:00<00:00, 3269.98it/s]    100%|##########| 1912/1912 [00:00<00:00, 4075.75it/s]
      0%|          | 0/2375 [00:00<?, ?it/s]     16%|#6        | 380/2375 [00:00<00:00, 3269.99it/s]     32%|###2      | 764/2375 [00:00<00:00, 3468.21it/s]     47%|####6     | 1112/2375 [00:00<00:00, 2630.44it/s]     65%|######4   | 1532/2375 [00:00<00:00, 2675.76it/s]     97%|#########6| 2300/2375 [00:00<00:00, 3197.51it/s]    100%|##########| 2375/2375 [00:00<00:00, 3173.62it/s]
      0%|          | 0/1845 [00:00<?, ?it/s]      0%|          | 8/1845 [00:00<00:29, 63.30it/s]     28%|##7       | 508/1845 [00:00<00:00, 2411.17it/s]     55%|#####5    | 1020/1845 [00:00<00:00, 3364.77it/s]    100%|##########| 1845/1845 [00:00<00:00, 4492.48it/s]
      0%|          | 0/1432 [00:00<?, ?it/s]      2%|1         | 28/1432 [00:00<00:07, 180.88it/s]     71%|#######1  | 1020/1432 [00:00<00:00, 4124.89it/s]    100%|##########| 1432/1432 [00:00<00:00, 4901.92it/s]
      0%|          | 0/1054 [00:00<?, ?it/s]     48%|####8     | 508/1054 [00:00<00:00, 4657.77it/s]     92%|#########2| 974/1054 [00:00<00:00, 3938.15it/s]    100%|##########| 1054/1054 [00:00<00:00, 3943.82it/s]
      0%|          | 0/1137 [00:00<?, ?it/s]      1%|          | 8/1137 [00:00<00:17, 64.39it/s]     33%|###3      | 380/1137 [00:00<00:00, 1859.64it/s]     90%|########9 | 1020/1137 [00:00<00:00, 2876.59it/s]    100%|##########| 1137/1137 [00:00<00:00, 2753.45it/s]
      0%|          | 0/7 [00:00<?, ?it/s]     14%|#4        | 1/7 [00:00<00:00,  6.81it/s]     57%|#####7    | 4/7 [00:00<00:00, 16.76it/s]    100%|##########| 7/7 [00:00<00:00, 20.00it/s]    100%|##########| 7/7 [00:00<00:00, 17.95it/s]
      0%|          | 0/7 [00:00<?, ?it/s]     43%|####2     | 3/7 [00:00<00:00, 23.07it/s]     86%|########5 | 6/7 [00:00<00:00, 23.82it/s]    100%|##########| 7/7 [00:00<00:00, 23.92it/s]




.. GENERATED FROM PYTHON SOURCE LINES 252-258

A few common issues that can hinder BIDS from working properly are:

1. Faulty `dataset_description.json` file. You need to make sure that the
   file contains the right names for the pipeline. See above for an example
   of that.
2. File naming convention doesn't uniquely identify file with bids filters.


.. rst-class:: sphx-glr-timing

   **Total running time of the script:** ( 14 minutes  52.663 seconds)


.. _sphx_glr_download_auto_examples_plot_bids_layout.py:


.. only :: html

 .. container:: sphx-glr-footer
    :class: sphx-glr-footer-example



  .. container:: sphx-glr-download sphx-glr-download-python

     :download:`Download Python source code: plot_bids_layout.py <plot_bids_layout.py>`



  .. container:: sphx-glr-download sphx-glr-download-jupyter

     :download:`Download Jupyter notebook: plot_bids_layout.ipynb <plot_bids_layout.ipynb>`


.. only:: html

 .. rst-class:: sphx-glr-signature

    `Gallery generated by Sphinx-Gallery <https://sphinx-gallery.github.io>`_
