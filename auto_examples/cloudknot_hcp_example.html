
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AFQ with HCP data &#8212; AFQ 1.0 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=796348d33e8b1d947c94" rel="stylesheet">
<link href="../_static/styles/bootstrap.css?digest=796348d33e8b1d947c94" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=796348d33e8b1d947c94" rel="stylesheet">

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=796348d33e8b1d947c94" rel="stylesheet">
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2">
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2">
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-rendered-html.css" />
    <link rel="stylesheet" type="text/css" href="../_static/css/custom.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=796348d33e8b1d947c94">
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=796348d33e8b1d947c94">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'auto_examples/cloudknot_hcp_example';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Plotting tract profiles" href="plot_tract_profile.html" />
    <link rel="prev" title="Free water DTI" href="plot_afq_fwdti.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="docsearch:language" content="en">
  </head>
  
  
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="180" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>

  
  <input type="checkbox" class="sidebar-toggle" name="__primary" id="__primary">
  <label class="overlay overlay-primary" for="__primary"></label>

  
  <input type="checkbox" class="sidebar-toggle" name="__secondary" id="__secondary">
  <label class="overlay overlay-secondary" for="__secondary"></label>

  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
      
<form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
    </div>
  </div>

  
  <nav class="bd-header navbar navbar-expand-lg bd-navbar" id="navbar-main"><div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
      <span class="fa-solid fa-bars"></span>
  </label>
  <div id="navbar-start">
    
    
  


<a class="navbar-brand logo" href="../index.html">

  
  
  
  
  
  
  

  
    <img src="../_static/logo.png" class="logo__image only-light" alt="Logo image">
    <img src="../_static/logo.png" class="logo__image only-dark" alt="Logo image">
  
  
</a>
    
  </div>

  
  <div class="col-lg-9 navbar-header-items">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <nav class="navbar-nav">
    <p class="sidebar-header-items__title" role="heading" aria-level="1" aria-label="Site Navigation">
        Site Navigation
    </p>
    <ul id="navbar-main-elements" class="navbar-nav">
        
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../installation_guide.html">
                        Installing pyAFQ
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../usage/index.html">
                        Using pyAFQ
                      </a>
                    </li>
                

                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="index.html">
                        Examples
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../getting_help.html">
                        Getting help using pyAFQ
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../contributing.html">
                        Contributing to pyAFQ
                      </a>
                    </li>
                
            <div class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    More
                </button>
                <div class="dropdown-menu">
                    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../autoapi/index.html">
                        API Reference
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../developing/index.html">
                        Developing pyAFQ
                      </a>
                    </li>
                
                </div>
            </div>
            
    </ul>
</nav>
      </div>
      
    </div>

    <div id="navbar-end">
      
        <div class="navbar-end-item navbar-persistent--container">
          
<button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-toggle="tooltip">
  <i class="fa-solid fa-magnifying-glass"></i>
</button>
        </div>
      
      
      <div class="navbar-end-item">
        <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
</button>
      </div>
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          <a href="https://github.com/yeatmanlab/pyAFQ" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-toggle="tooltip"><span><i class="fab fa-github-square"></i></span>
            <label class="sr-only">GitHub</label></a>
        </li>
      </ul>
      </div>
      
    </div>
  </div>


  
  
    <div class="navbar-persistent--mobile">
<button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-toggle="tooltip">
  <i class="fa-solid fa-magnifying-glass"></i>
</button>
    </div>
  

  
  <label class="sidebar-toggle secondary-toggle" for="__secondary">
      <span class="fa-solid fa-outdent"></span>
  </label>
  

</div>
  </nav>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        
  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
      
      <div class="navbar-center-item">
        <nav class="navbar-nav">
    <p class="sidebar-header-items__title" role="heading" aria-level="1" aria-label="Site Navigation">
        Site Navigation
    </p>
    <ul id="navbar-main-elements" class="navbar-nav">
        
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../installation_guide.html">
                        Installing pyAFQ
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../usage/index.html">
                        Using pyAFQ
                      </a>
                    </li>
                

                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="index.html">
                        Examples
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../getting_help.html">
                        Getting help using pyAFQ
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../contributing.html">
                        Contributing to pyAFQ
                      </a>
                    </li>
                
            <div class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    More
                </button>
                <div class="dropdown-menu">
                    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../autoapi/index.html">
                        API Reference
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../developing/index.html">
                        Developing pyAFQ
                      </a>
                    </li>
                
                </div>
            </div>
            
    </ul>
</nav>
      </div>
      
      </div>
    

    
    
    <div class="sidebar-header-items__end">
      
      <div class="navbar-end-item">
        <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
</button>
      </div>
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          <a href="https://github.com/yeatmanlab/pyAFQ" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-toggle="tooltip"><span><i class="fab fa-github-square"></i></span>
            <label class="sr-only">GitHub</label></a>
        </li>
      </ul>
      </div>
      
    </div>
    
  </div>

  
  <div class="sidebar-start-items sidebar-primary__section">
    <div class="sidebar-start-items__item">
<form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
    </div>
    <div class="sidebar-start-items__item"><nav class="bd-links" id="bd-docs-nav" aria-label="Section navigation">
  <p class="bd-links__title" role="heading" aria-level="1">
    Section Navigation
  </p>
  <div class="bd-toc-item navbar-nav">
    <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="plot_afq_reco80.html">RecoBundles80 using AFQ API</a></li>
<li class="toctree-l1"><a class="reference internal" href="vof_example.html">Finding only the ARC, pARC, VOF</a></li>
<li class="toctree-l1"><a class="reference internal" href="plot_afq_api.html">AFQ API</a></li>
<li class="toctree-l1"><a class="reference internal" href="plot_afq_callosal.html">Callosal bundles using AFQ API</a></li>
<li class="toctree-l1"><a class="reference internal" href="plot_bids_layout.html">How pyAFQ uses BIDS</a></li>
<li class="toctree-l1"><a class="reference internal" href="plot_optic_radiations.html">Plotting the Optic Radiations</a></li>
<li class="toctree-l1"><a class="reference internal" href="cloudknot_example.html">Using cloudknot to run pyAFQ on AWS batch:</a></li>
<li class="toctree-l1"><a class="reference internal" href="plot_afq_fwdti.html">Free water DTI</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">AFQ with HCP data</a></li>
<li class="toctree-l1"><a class="reference internal" href="plot_tract_profile.html">Plotting tract profiles</a></li>
<li class="toctree-l1"><a class="reference internal" href="plot_recobundles.html">Plotting tract profiles using RecoBundles</a></li>
<li class="toctree-l1"><a class="reference internal" href="plot_viz.html">Visualizing AFQ derivatives</a></li>
<li class="toctree-l1"><a class="reference internal" href="plot_callosal_tract_profile.html">Plotting Novel Tract Profiles:</a></li>
</ul>

  </div>
</nav>
    </div>
  </div>
  

  
  <div class="sidebar-end-items sidebar-primary__section">
    <div class="sidebar-end-items__item">
    </div>
  </div>

  
  <div id="rtd-footer-container"></div>

      </div>
      <main id="main-content" class="bd-main">
        
        
        <div class="bd-content">
          <div class="bd-article-container">
            
            <div class="bd-header-article">
                
            </div>
            
            
            <article class="bd-article" role="main">
              
  <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p>Click <a class="reference internal" href="#sphx-glr-download-auto-examples-cloudknot-hcp-example-py"><span class="std std-ref">here</span></a>
to download the full example code</p>
</div>
<div class="sphx-glr-example-title section" id="afq-with-hcp-data">
<span id="sphx-glr-auto-examples-cloudknot-hcp-example-py"></span><h1>AFQ with HCP data<a class="headerlink" href="#afq-with-hcp-data" title="Permalink to this heading">#</a></h1>
<p>This example demonstrates how to use the AFQ API to analyze HCP data.
For this example to run properly, you will need to gain access to the HCP data.
This can be done by following this instructions on the webpage
<a class="reference external" href="https://wiki.humanconnectome.org/display/PublicData/How+To+Connect+to+Connectome+Data+via+AWS">here</a>.
We will use the <code class="docutils literal notranslate"><span class="pre">Cloudknot</span></code> library to run our AFQ analysis in the AWS
Batch service (see also
<a class="reference external" href="http://yeatmanlab.github.io/pyAFQ/auto_examples/cloudknot_example.html">this example</a>).
In the following we will use <code class="docutils literal notranslate"><span class="pre">Cloudknot</span></code> to run multiple
configurations of pyAFQ on the HCP dataset. Specifically, here we will run
pyAFQ with different tractography seeding strategies.</p>
<p>Import cloudknot and set the correct region. The HCP data is stored in <cite>us-east-1</cite>, so itâ€™s best
to analyze it there.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">configparser</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">cloudknot</span> <span class="k">as</span> <span class="nn">ck</span>
<span class="kn">import</span> <span class="nn">os.path</span> <span class="k">as</span> <span class="nn">op</span>

<span class="n">ck</span><span class="o">.</span><span class="n">set_region</span><span class="p">(</span><span class="s1">&#39;us-east-1&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Define a function to run. This function allows us to pass in the subject ID for the subjects we would
like to analyze , as well as strategies for seeding tractography (different masks and/or different
numbers of seeds per voxel).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">afq_process_subject</span><span class="p">(</span><span class="n">subject</span><span class="p">,</span> <span class="n">seed_mask</span><span class="p">,</span> <span class="n">n_seeds</span><span class="p">,</span>
                        <span class="n">aws_access_key</span><span class="p">,</span> <span class="n">aws_secret_key</span><span class="p">):</span>
    <span class="c1"># define a function that each job will run</span>
    <span class="c1"># In this case, each process does a single subject</span>
    <span class="kn">import</span> <span class="nn">logging</span>
    <span class="kn">import</span> <span class="nn">s3fs</span>
    <span class="c1"># all imports must be at the top of the function</span>
    <span class="c1"># cloudknot installs the appropriate packages from pip</span>
    <span class="kn">from</span> <span class="nn">AFQ.data.fetch</span> <span class="kn">import</span> <span class="n">fetch_hcp</span>
    <span class="kn">from</span> <span class="nn">AFQ.api.group</span> <span class="kn">import</span> <span class="n">GroupAFQ</span>
    <span class="kn">import</span> <span class="nn">AFQ.definitions.image</span> <span class="k">as</span> <span class="nn">afm</span>

    <span class="c1"># set logging level to your choice</span>
    <a href="https://docs.python.org/3/library/logging.html#logging.basicConfig" title="logging.basicConfig" class="sphx-glr-backref-module-logging sphx-glr-backref-type-py-function"><span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span></a><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
    <span class="n">log</span> <span class="o">=</span> <a href="https://docs.python.org/3/library/logging.html#logging.getLogger" title="logging.getLogger" class="sphx-glr-backref-module-logging sphx-glr-backref-type-py-function"><span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span></a><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="c1"># Download the given subject to the AWS Batch machine from s3</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">hcp_bids</span> <span class="o">=</span> <span class="n">fetch_hcp</span><span class="p">(</span>
        <span class="p">[</span><span class="n">subject</span><span class="p">],</span>
        <span class="n">profile_name</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">study</span><span class="o">=</span><span class="s2">&quot;HCP_1200&quot;</span><span class="p">,</span>
        <span class="n">aws_access_key_id</span><span class="o">=</span><span class="n">aws_access_key</span><span class="p">,</span>
        <span class="n">aws_secret_access_key</span><span class="o">=</span><span class="n">aws_secret_key</span><span class="p">)</span>

    <span class="c1"># We make a new seed mask for each process based off of the</span>
    <span class="c1"># seed_mask argument, which is a string.</span>
    <span class="c1"># This is to avoid any complications with pickling the masks.</span>
    <span class="k">if</span> <span class="n">seed_mask</span> <span class="o">==</span> <span class="s2">&quot;roi&quot;</span><span class="p">:</span>
        <span class="n">seed_mask_obj</span> <span class="o">=</span> <span class="n">afm</span><span class="o">.</span><span class="n">RoiImage</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">seed_mask</span> <span class="o">==</span> <span class="s2">&quot;fa&quot;</span><span class="p">:</span>
        <span class="n">seed_mask_obj</span> <span class="o">=</span> <span class="n">afm</span><span class="o">.</span><span class="n">ScalarImage</span><span class="p">(</span><span class="s2">&quot;dti_fa&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">seed_mask_obj</span> <span class="o">=</span> <span class="n">afm</span><span class="o">.</span><span class="n">FullImage</span><span class="p">()</span>

    <span class="c1"># Determined if n_seeds is per voxel or not</span>
    <span class="k">if</span> <span class="n">n_seeds</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">random_seeds</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">random_seeds</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># set the tracking_params based off our inputs</span>
    <span class="n">tracking_params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;seed_mask&quot;</span><span class="p">:</span> <span class="n">seed_mask_obj</span><span class="p">,</span>
        <span class="s2">&quot;n_seeds&quot;</span><span class="p">:</span> <span class="n">n_seeds</span><span class="p">,</span>
        <span class="s2">&quot;random_seeds&quot;</span><span class="p">:</span> <span class="n">random_seeds</span><span class="p">}</span>

    <span class="c1"># use segmentation file from HCP to get a brain mask,</span>
    <span class="c1"># where everything not labelled 0 is considered a part of the brain</span>
    <span class="n">brain_mask_definition</span> <span class="o">=</span> <span class="n">afm</span><span class="o">.</span><span class="n">LabelledImageFile</span><span class="p">(</span>
        <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;seg&#39;</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;scope&#39;</span><span class="p">:</span> <span class="s1">&#39;dmriprep&#39;</span><span class="p">},</span>
        <span class="n">exclusive_labels</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># define the api GroupAFQ object</span>
    <span class="n">myafq</span> <span class="o">=</span> <span class="n">GroupAFQ</span><span class="p">(</span>
        <span class="n">hcp_bids</span><span class="p">,</span>
        <span class="n">brain_mask_definition</span><span class="o">=</span><span class="n">brain_mask_definition</span><span class="p">,</span>
        <span class="n">tracking_params</span><span class="o">=</span><span class="n">tracking_params</span><span class="p">)</span>

    <span class="c1"># export_all runs the entire pipeline and creates many useful derivates</span>
    <span class="n">myafq</span><span class="o">.</span><span class="n">export_all</span><span class="p">()</span>

    <span class="c1"># upload the results to some location on s3</span>
    <span class="n">myafq</span><span class="o">.</span><span class="n">upload_to_s3</span><span class="p">(</span>
        <span class="n">s3fs</span><span class="o">.</span><span class="n">S3FileSystem</span><span class="p">(),</span>
        <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;my_study_bucket/my_study_prefix_</span><span class="si">{</span><span class="n">seed_mask</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">n_seeds</span><span class="si">}</span><span class="s2">&quot;</span>
         <span class="sa">f</span><span class="s2">&quot;/derivatives/afq&quot;</span><span class="p">))</span>
</pre></div>
</div>
<p>In this example, we will process the data from the following subjects</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">subjects</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;103818&quot;</span><span class="p">,</span> <span class="s2">&quot;105923&quot;</span><span class="p">,</span> <span class="s2">&quot;111312&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>We will test combinations of different conditions:
subjects, seed masks, and number of seeds</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">seed_mask</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;fa&quot;</span><span class="p">,</span> <span class="s2">&quot;roi&quot;</span><span class="p">]</span>
<span class="n">n_seeds</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1000000</span><span class="p">,</span> <span class="mi">2000000</span><span class="p">]</span>
</pre></div>
</div>
<p>The following function creates all the combinations of the above lists, such that every subject is
run with every mask and every number of seeds.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><a href="https://docs.python.org/3/library/itertools.html#itertools.product" title="itertools.product" class="sphx-glr-backref-module-itertools sphx-glr-backref-type-py-function"><span class="n">itertools</span><span class="o">.</span><span class="n">product</span></a><span class="p">(</span><span class="n">subjects</span><span class="p">,</span> <span class="n">seed_mask</span><span class="p">,</span> <span class="n">n_seeds</span><span class="p">))</span>
</pre></div>
</div>
<p>We assume that the credentials for HCP usage are stored in the home directory in a
<cite>~/.aws/credentials</cite> file. This is where these credentials are stored if the AWS CLI is used to
configure the profile. We use the standard lib <code class="docutils literal notranslate"><span class="pre">configparser</span></code> library
to get the relevant hcp keys from there.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CP</span> <span class="o">=</span> <a href="https://docs.python.org/3/library/configparser.html#configparser.ConfigParser" title="configparser.ConfigParser" class="sphx-glr-backref-module-configparser sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">configparser</span><span class="o">.</span><span class="n">ConfigParser</span></a><span class="p">()</span>
<span class="n">CP</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><a href="https://docs.python.org/3/library/os.path.html#os.path.join" title="os.path.join" class="sphx-glr-backref-module-os-path sphx-glr-backref-type-py-function"><span class="n">op</span><span class="o">.</span><span class="n">join</span></a><span class="p">(</span><a href="https://docs.python.org/3/library/os.path.html#os.path.expanduser" title="os.path.expanduser" class="sphx-glr-backref-module-os-path sphx-glr-backref-type-py-function"><span class="n">op</span><span class="o">.</span><span class="n">expanduser</span></a><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">),</span> <span class="s1">&#39;.aws&#39;</span><span class="p">,</span> <span class="s1">&#39;credentials&#39;</span><span class="p">)))</span>
<span class="n">CP</span><span class="o">.</span><span class="n">sections</span><span class="p">()</span>
<span class="n">aws_access_key</span> <span class="o">=</span> <span class="n">CP</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;hcp&#39;</span><span class="p">,</span> <span class="s1">&#39;AWS_ACCESS_KEY_ID&#39;</span><span class="p">)</span>
<span class="n">aws_secret_key</span> <span class="o">=</span> <span class="n">CP</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;hcp&#39;</span><span class="p">,</span> <span class="s1">&#39;AWS_SECRET_ACCESS_KEY&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The following function will attach your AWS keys to each list in a list of lists
We use this with each list being a list of arguments,
and we append the AWS keys to each list of arguments, so that we can pass
them into the function to be used on AWS Batch to download the data into the
AWS Batch machines.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">attach_keys</span><span class="p">(</span><span class="n">list_of_arg_lists</span><span class="p">):</span>
    <span class="n">new_list_of_arg_lists</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">args</span> <span class="ow">in</span> <span class="n">list_of_arg_lists</span><span class="p">:</span>
        <span class="n">arg_ls</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="n">arg_ls</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">aws_access_key</span><span class="p">,</span> <span class="n">aws_secret_key</span><span class="p">])</span>
        <span class="n">new_list_of_arg_lists</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg_ls</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">new_list_of_arg_lists</span>
</pre></div>
</div>
<p>This calls the function to attach the access keys to the argument list</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">args</span> <span class="o">=</span> <span class="n">attach_keys</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
</pre></div>
</div>
<p>Define the <code class="xref py py-meth docutils literal notranslate"><span class="pre">Knot()</span></code> object to run your jobs on. See
<a class="reference external" href="http://yeatmanlab.github.io/pyAFQ/auto_examples/cloudknot_example.html">this example</a> for more
details about the arguments to the object.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">knot</span> <span class="o">=</span> <span class="n">ck</span><span class="o">.</span><span class="n">Knot</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;afq-hcp-tractography-201110-0&#39;</span><span class="p">,</span>
    <span class="n">func</span><span class="o">=</span><span class="n">afq_process_subject</span><span class="p">,</span>
    <span class="n">base_image</span><span class="o">=</span><span class="s1">&#39;python:3.8&#39;</span><span class="p">,</span>
    <span class="n">image_github_installs</span><span class="o">=</span><span class="s2">&quot;https://github.com/yeatmanlab/pyAFQ.git&quot;</span><span class="p">,</span>
    <span class="n">pars_policies</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;AmazonS3FullAccess&#39;</span><span class="p">,),</span>
    <span class="n">bid_percentage</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</pre></div>
</div>
<p>This launches a process for each combination.
Because <cite>starmap</cite> is <cite>True</cite>, each list in <cite>args</cite> will be unfolded
and passed into <cite>afq_process_subject</cite> as arguments.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">result_futures</span> <span class="o">=</span> <span class="n">knot</span><span class="o">.</span><a href="https://docs.python.org/3/library/functions.html#map" title="builtins.map" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-function"><span class="n">map</span></a><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">starmap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>The following function can be called repeatedly in a jupyter notebook
to view the progress of jobs:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">knot</span><span class="o">.</span><span class="n">view_jobs</span><span class="p">()</span>
</pre></div>
</div>
<p>You can also view the status of a specific job:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">knot</span><span class="o">.</span><span class="n">jobs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">status</span>
</pre></div>
</div>
<p>When all jobs are finished, remember to clobber the knot to destroy all the resources that were
created in AWS.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">result_futures</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>  <span class="c1"># waits for futures to resolve, not needed in notebook</span>
<span class="n">knot</span><span class="o">.</span><span class="n">clobber</span><span class="p">(</span><span class="n">clobber_pars</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">clobber_repo</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">clobber_image</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>We continue processing to create another knot which takes the resulting profiles of each
combination and combines them all into one csv file</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">afq_combine_profiles</span><span class="p">(</span><span class="n">seed_mask</span><span class="p">,</span> <span class="n">n_seeds</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">AFQ.api</span> <span class="kn">import</span> <span class="n">download_and_combine_afq_profiles</span>
    <span class="n">download_and_combine_afq_profiles</span><span class="p">(</span>
        <span class="s2">&quot;my_study_bucket&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;my_study_prefix_</span><span class="si">{</span><span class="n">seed_mask</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">n_seeds</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="n">knot2</span> <span class="o">=</span> <span class="n">ck</span><span class="o">.</span><span class="n">Knot</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;afq_combine_subjects-201110-0&#39;</span><span class="p">,</span>
    <span class="n">func</span><span class="o">=</span><span class="n">afq_combine_profiles</span><span class="p">,</span>
    <span class="n">base_image</span><span class="o">=</span><span class="s1">&#39;python:3.8&#39;</span><span class="p">,</span>
    <span class="n">image_github_installs</span><span class="o">=</span><span class="s2">&quot;https://github.com/yeatmanlab/pyAFQ.git&quot;</span><span class="p">,</span>
    <span class="n">pars_policies</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;AmazonS3FullAccess&#39;</span><span class="p">,),</span>
    <span class="n">bid_percentage</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</pre></div>
</div>
<p>the arguments to this call to <code class="xref py py-meth docutils literal notranslate"><span class="pre">map()</span></code> are all the different configurations of pyAFQ that we ran</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">seed_mask</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;fa&quot;</span><span class="p">,</span> <span class="s2">&quot;roi&quot;</span><span class="p">]</span>
<span class="n">n_seeds</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1000000</span><span class="p">,</span> <span class="mi">2000000</span><span class="p">]</span>
<span class="n">args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><a href="https://docs.python.org/3/library/itertools.html#itertools.product" title="itertools.product" class="sphx-glr-backref-module-itertools sphx-glr-backref-type-py-function"><span class="n">itertools</span><span class="o">.</span><span class="n">product</span></a><span class="p">(</span><span class="n">seed_mask</span><span class="p">,</span> <span class="n">n_seeds</span><span class="p">))</span>

<span class="n">result_futures2</span> <span class="o">=</span> <span class="n">knot2</span><span class="o">.</span><a href="https://docs.python.org/3/library/functions.html#map" title="builtins.map" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-function"><span class="n">map</span></a><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">starmap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">result_futures2</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
<span class="n">knot2</span><span class="o">.</span><span class="n">clobber</span><span class="p">(</span><span class="n">clobber_pars</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">clobber_repo</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">clobber_image</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p class="sphx-glr-timing"><strong>Total running time of the script:</strong> ( 0 minutes  0.000 seconds)</p>
<div class="sphx-glr-footer sphx-glr-footer-example docutils container" id="sphx-glr-download-auto-examples-cloudknot-hcp-example-py">
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../_downloads/1fa9d23e0b91e893d59c98b17144a6a2/cloudknot_hcp_example.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">cloudknot_hcp_example.py</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../_downloads/0b5020f6d55ab9dec8de544d67467741/cloudknot_hcp_example.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">cloudknot_hcp_example.ipynb</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</div>


            </article>
            
            
            
            <footer class="bd-footer-article">
                <!-- Previous / next buttons -->
<div class='prev-next-area'>
  <a class='left-prev' id="prev-link" href="plot_afq_fwdti.html" title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
          <p class="prev-next-subtitle">previous</p>
          <p class="prev-next-title">Free water DTI</p>
      </div>
  </a>
  <a class='right-next' id="next-link" href="plot_tract_profile.html" title="next page">
  <div class="prev-next-info">
      <p class="prev-next-subtitle">next</p>
      <p class="prev-next-title">Plotting tract profiles</p>
  </div>
  <i class="fa-solid fa-angle-right"></i>
  </a>
</div>
            </footer>
            
          </div>
          
          
          
            <div class="bd-sidebar-secondary bd-toc">
              
<div class="toc-item">
  
<div id="searchbox"></div>
</div>

<div class="toc-item">
  

<div class="tocsection editthispage">
    <a href="https://github.com/yeatmanlab/pyAFQ/edit/master/docs/source/auto_examples/cloudknot_hcp_example.rst">
        <i class="fa-solid fa-pencil"></i> Edit this page
    </a>
</div>

</div>

<div class="toc-item">
  
<div class="tocsection sourcelink">
    <a href="../_sources/auto_examples/cloudknot_hcp_example.rst.txt">
        <i class="fa-solid fa-file-lines"></i> Show Source
    </a>
</div>

</div>

            </div>
          
          
        </div>
        <footer class="bd-footer-content">
          <div class="bd-footer-content__inner">
            
          </div>
        </footer>
        
      </main>
    </div>
  </div>

  
    
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=796348d33e8b1d947c94"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=796348d33e8b1d947c94"></script>


  <footer class="bd-footer"><div class="bd-footer__inner container">
  
  <div class="footer-item">
    
<p class="copyright">

    &copy; Copyright 2018--, The pyAFQ Contributors.<br>

</p>

  </div>
  
  <div class="footer-item">
    <p class="theme-version">
    Built with the
    <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">
        PyData Sphinx Theme
    </a>
    0.12.0.
</p>
  </div>
  
  <div class="footer-item">
    
<p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 5.3.0.<br>
</p>

  </div>
  
</div>
  </footer>
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
var pageTracker = _gat._getTracker("UA-156363454-2");
pageTracker._trackPageview();
} catch(err) {}</script>

  </body>
</html>