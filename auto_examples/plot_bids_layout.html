
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>How pyAFQ uses BIDS &#8212; AFQ 0.11 documentation</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-rendered-html.css" />
    <link rel="stylesheet" type="text/css" href="../_static/css/custom.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Using cloudknot to run pyAFQ on AWS batch:" href="cloudknot_example.html" />
    <link rel="prev" title="Plotting the Optic Radiations" href="plot_optic_radiations.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    

<a class="navbar-brand" href="../index.html">
  <img src="../_static/logo.png" class="logo" alt="logo">
</a>


    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../installation_guide.html">
  Installing
  <code class="docutils literal notranslate">
   <span class="pre">
    pyAFQ
   </span>
  </code>
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../usage/index.html">
  Using pyAFQ
 </a>
</li>

<li class="toctree-l1 current active nav-item">
 <a class="reference internal nav-link" href="index.html">
  Examples
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../getting_help.html">
  Getting help using pyAFQ
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../contributing.html">
  Contributing to pyAFQ
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../autoapi/index.html">
  API Reference
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../developing/index.html">
  Developing
  <cite>
   pyAFQ
  </cite>
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          <a class="nav-link" href="https://github.com/yeatmanlab/pyAFQ" rel="noopener" target="_blank" title="GitHub"><span><i class="fab fa-github-square"></i></span>
            <label class="sr-only">GitHub</label></a>
        </li>
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar">
              <div class="sidebar-start-items"><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_afq_reco80.html">
   RecoBundles80 using AFQ API
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_afq_api.html">
   AFQ API
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_afq_callosal.html">
   Callosal bundles using AFQ API
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_optic_radiations.html">
   Plotting the Optic Radiations
  </a>
 </li>
</ul>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   How pyAFQ uses BIDS
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="cloudknot_example.html">
   Using cloudknot to run pyAFQ on AWS batch:
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="cloudknot_hcp_example.html">
   AFQ with HCP data
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_tract_profile.html">
   Plotting tract profiles
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_recobundles.html">
   Plotting tract profiles using RecoBundles
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="plot_callosal_tract_profile.html">
   Plotting Novel Tract Profiles:
  </a>
 </li>
</ul>

  </div>
</nav>
              </div>
              <div class="sidebar-end-items">
              </div>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                

<nav id="bd-toc-nav">
    
</nav>
              </div>
              
              <div class="toc-item">
                

<div class="tocsection editthispage">
    <a href="https://github.com/yeatmanlab/pyAFQ/edit/master/docs/source/auto_examples/plot_bids_layout.rst">
        <i class="fas fa-pencil-alt"></i> Edit this page
    </a>
</div>

              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p>Click <a class="reference internal" href="#sphx-glr-download-auto-examples-plot-bids-layout-py"><span class="std std-ref">here</span></a>
to download the full example code</p>
</div>
<div class="sphx-glr-example-title section" id="how-pyafq-uses-bids">
<span id="sphx-glr-auto-examples-plot-bids-layout-py"></span><h1>How pyAFQ uses BIDS<a class="headerlink" href="#how-pyafq-uses-bids" title="Permalink to this headline">#</a></h1>
<p>The pyAFQ API relies heavily on the
<a class="reference external" href="https://bids-specification.readthedocs.io/en/stable/">Brain Imaging Data Standard (BIDS)</a>. This means that the software assumes that its inputs are organized
according to the BIDS spec and its outputs conform where possible with the
BIDS spec.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Derivatives of processing diffusion MRI are not currently fully
described in the existing BIDS specification, but describing these
is part of an ongoing effort. Wherever possible, we conform with
the draft implementation of the BIDS DWI derivatives available
<a class="reference external" href="https://bids-specification.readthedocs.io/en/wip-derivatives/05-derivatives/05-diffusion-derivatives.html">here</a></p>
</div>
<p>In this example, we will explore the use of BIDS in pyAFQ and see
how BIDS allows us to extend and provide flexibility to the users
of the software.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">os.path</span> <span class="k">as</span> <span class="nn">op</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">nibabel</span> <span class="k">as</span> <span class="nn">nib</span>

<span class="kn">from</span> <span class="nn">AFQ.api.group</span> <span class="kn">import</span> <span class="n">GroupAFQ</span>
<span class="kn">import</span> <span class="nn">AFQ.data.fetch</span> <span class="k">as</span> <span class="nn">afd</span>
</pre></div>
</div>
<dl class="simple">
<dt>To interact with and query BIDS datasets, we use</dt><dd><p><a class="reference external" href="https://bids-standard.github.io/pybids/">pyBIDS</a>.</p>
</dd>
</dl>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">bids</span>
</pre></div>
</div>
<p>We start with some example data. The data we will use here is
generated from the
<a class="reference external" href="https://purl.stanford.edu/ng782rw8378">Stanford HARDI dataset</a>.
The call below fetches
this dataset and organized it within the <cite>~/AFQ_data</cite> folder in the BIDS
format.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">afd</span><span class="o">.</span><span class="n">organize_stanford_data</span><span class="p">(</span><span class="n">clear_previous_afq</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>After doing that, we should have a folder that looks like this:</p>
<div class="line-block">
<div class="line">stanford_hardi</div>
<div class="line">├── dataset_description.json</div>
<div class="line">└── derivatives</div>
<div class="line-block">
<div class="line">├── freesurfer</div>
<div class="line">│   ├── dataset_description.json</div>
<div class="line">│   └── sub-01</div>
<div class="line">│       └── ses-01</div>
<div class="line">│           └── anat</div>
<div class="line">│               ├── sub-01_ses-01_T1w.nii.gz</div>
<div class="line">│               └── sub-01_ses-01_seg.nii.gz</div>
<div class="line">└── vistasoft</div>
<div class="line-block">
<div class="line">├── dataset_description.json</div>
<div class="line">└── sub-01</div>
<div class="line-block">
<div class="line">└── ses-01</div>
<div class="line-block">
<div class="line">└── dwi</div>
<div class="line-block">
<div class="line">├── sub-01_ses-01_dwi.bvals</div>
<div class="line">├── sub-01_ses-01_dwi.bvecs</div>
<div class="line">└── sub-01_ses-01_dwi.nii.gz</div>
</div>
</div>
</div>
</div>
</div>
</div>
<p>The top level directory is our overall bids dataset folder. In most
cases, this folder will include a <cite>raw</cite> folder that will contain the
raw data. In this case, we do not include the raw folder and only have
the pipelines that contains the outputs of preprocessing the data.
In general, only the preprocessed diffusion data is required.
See the “Organizing your data” section of “Using pyAFQ” for more details.
In this case, one folder containing Freesurfer derivatives and another
folder containing the DWI data that has been preprocessed with Vistasoft.
pyAFQ provides facilities to segment tractography results obtained
using other software. For example, we often use
<a class="reference external" href="https://qsiprep.readthedocs.io/en/latest/">qsiprep</a> to preprocess
our data and reconstruct tractographies with software such as
<a class="reference external" href="https://www.mrtrix.org/">MRTRIX</a>. Here, we will demonstrate how to use
these reconstructions in the pyAFQ segmentation and tractometry pipeline
We fetch this data and add it as a separate pipeline</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">afd</span><span class="o">.</span><span class="n">fetch_stanford_hardi_tractography</span><span class="p">()</span>

<a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">bids_path</span></a> <span class="o">=</span> <a href="https://docs.python.org/3/library/os.path.html#os.path.join" title="os.path.join" class="sphx-glr-backref-module-os-path sphx-glr-backref-type-py-function"><span class="n">op</span><span class="o">.</span><span class="n">join</span></a><span class="p">(</span><a href="https://docs.python.org/3/library/os.path.html#os.path.expanduser" title="os.path.expanduser" class="sphx-glr-backref-module-os-path sphx-glr-backref-type-py-function"><span class="n">op</span><span class="o">.</span><span class="n">expanduser</span></a><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">),</span> <span class="s1">&#39;AFQ_data&#39;</span><span class="p">,</span> <span class="s1">&#39;stanford_hardi&#39;</span><span class="p">)</span>
<a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">tractography_path</span></a> <span class="o">=</span> <a href="https://docs.python.org/3/library/os.path.html#os.path.join" title="os.path.join" class="sphx-glr-backref-module-os-path sphx-glr-backref-type-py-function"><span class="n">op</span><span class="o">.</span><span class="n">join</span></a><span class="p">(</span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">bids_path</span></a><span class="p">,</span> <span class="s1">&#39;derivatives&#39;</span><span class="p">,</span> <span class="s1">&#39;my_tractography&#39;</span><span class="p">)</span>
<a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">sub_path</span></a> <span class="o">=</span> <a href="https://docs.python.org/3/library/os.path.html#os.path.join" title="os.path.join" class="sphx-glr-backref-module-os-path sphx-glr-backref-type-py-function"><span class="n">op</span><span class="o">.</span><span class="n">join</span></a><span class="p">(</span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">tractography_path</span></a><span class="p">,</span> <span class="s1">&#39;sub-01&#39;</span><span class="p">,</span> <span class="s1">&#39;ses-01&#39;</span><span class="p">,</span> <span class="s1">&#39;dwi&#39;</span><span class="p">)</span>

<a href="https://docs.python.org/3/library/os.html#os.makedirs" title="os.makedirs" class="sphx-glr-backref-module-os sphx-glr-backref-type-py-function"><span class="n">os</span><span class="o">.</span><span class="n">makedirs</span></a><span class="p">(</span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">sub_path</span></a><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a href="https://docs.python.org/3/library/os.html#os.rename" title="os.rename" class="sphx-glr-backref-module-os sphx-glr-backref-type-py-function"><span class="n">os</span><span class="o">.</span><span class="n">rename</span></a><span class="p">(</span>
    <a href="https://docs.python.org/3/library/os.path.html#os.path.join" title="os.path.join" class="sphx-glr-backref-module-os-path sphx-glr-backref-type-py-function"><span class="n">op</span><span class="o">.</span><span class="n">join</span></a><span class="p">(</span>
        <a href="https://docs.python.org/3/library/os.path.html#os.path.expanduser" title="os.path.expanduser" class="sphx-glr-backref-module-os-path sphx-glr-backref-type-py-function"><span class="n">op</span><span class="o">.</span><span class="n">expanduser</span></a><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">),</span>
        <span class="s1">&#39;AFQ_data&#39;</span><span class="p">,</span>
        <span class="s1">&#39;stanford_hardi_tractography&#39;</span><span class="p">,</span>
        <span class="s1">&#39;full_segmented_cleaned_tractography.trk&#39;</span><span class="p">),</span>
    <a href="https://docs.python.org/3/library/os.path.html#os.path.join" title="os.path.join" class="sphx-glr-backref-module-os-path sphx-glr-backref-type-py-function"><span class="n">op</span><span class="o">.</span><span class="n">join</span></a><span class="p">(</span>
        <a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">sub_path</span></a><span class="p">,</span>
        <span class="s1">&#39;sub-01_ses-01-dwi_tractography.trk&#39;</span><span class="p">))</span>

<span class="n">afd</span><span class="o">.</span><span class="n">to_bids_description</span><span class="p">(</span>
    <a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">tractography_path</span></a><span class="p">,</span>
    <span class="o">**</span><span class="p">{</span><span class="s2">&quot;Name&quot;</span><span class="p">:</span> <span class="s2">&quot;my_tractography&quot;</span><span class="p">,</span>
        <span class="s2">&quot;PipelineDescription&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;Name&quot;</span><span class="p">:</span> <span class="s2">&quot;my_tractography&quot;</span><span class="p">}})</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>  0%|          | 0/11337 [00:00&lt;?, ? MB/s]
  0%|          | 4/11337 [00:00&lt;06:40, 28.29 MB/s]
  0%|          | 11/11337 [00:00&lt;04:39, 40.47 MB/s]
  0%|          | 46/11337 [00:00&lt;01:24, 133.52 MB/s]
  2%|1         | 184/11337 [00:00&lt;00:24, 462.39 MB/s]
  5%|4         | 548/11337 [00:00&lt;00:08, 1212.41 MB/s]
  8%|8         | 916/11337 [00:00&lt;00:06, 1673.88 MB/s]
 11%|#1        | 1289/11337 [00:01&lt;00:05, 1979.71 MB/s]
 15%|#4        | 1651/11337 [00:01&lt;00:04, 2157.65 MB/s]
 18%|#7        | 2027/11337 [00:01&lt;00:04, 2302.92 MB/s]
 21%|##1       | 2392/11337 [00:01&lt;00:03, 2377.12 MB/s]
 24%|##4       | 2766/11337 [00:01&lt;00:03, 2451.54 MB/s]
 28%|##7       | 3140/11337 [00:01&lt;00:03, 2498.81 MB/s]
 31%|###       | 3501/11337 [00:01&lt;00:03, 2506.37 MB/s]
 34%|###4      | 3871/11337 [00:02&lt;00:02, 2526.65 MB/s]
 37%|###7      | 4240/11337 [00:02&lt;00:02, 2545.70 MB/s]
 41%|####      | 4611/11337 [00:02&lt;00:02, 2563.05 MB/s]
 44%|####3     | 4983/11337 [00:02&lt;00:02, 2574.37 MB/s]
 47%|####7     | 5356/11337 [00:02&lt;00:02, 2578.68 MB/s]
 50%|#####     | 5713/11337 [00:02&lt;00:02, 2547.01 MB/s]
 54%|#####3    | 6081/11337 [00:02&lt;00:02, 2557.68 MB/s]
 57%|#####6    | 6456/11337 [00:03&lt;00:01, 2578.13 MB/s]
 60%|######    | 6829/11337 [00:03&lt;00:01, 2582.72 MB/s]
 64%|######3   | 7200/11337 [00:03&lt;00:01, 2586.92 MB/s]
 67%|######6   | 7573/11337 [00:03&lt;00:01, 2591.98 MB/s]
 70%|#######   | 7947/11337 [00:03&lt;00:01, 2599.81 MB/s]
 73%|#######2  | 8240/11337 [00:03&lt;00:01, 2660.26 MB/s]
 75%|#######5  | 8508/11337 [00:03&lt;00:01, 2570.04 MB/s]
 78%|#######7  | 8813/11337 [00:03&lt;00:00, 2684.88 MB/s]
 80%|########  | 9084/11337 [00:04&lt;00:00, 2585.05 MB/s]
 83%|########2 | 9375/11337 [00:04&lt;00:00, 2671.66 MB/s]
 85%|########5 | 9645/11337 [00:04&lt;00:00, 2575.13 MB/s]
 88%|########7 | 9922/11337 [00:04&lt;00:00, 2627.97 MB/s]
 90%|########9 | 10187/11337 [00:04&lt;00:00, 2549.91 MB/s]
 92%|#########2| 10457/11337 [00:04&lt;00:00, 2587.54 MB/s]
 95%|#########4| 10717/11337 [00:04&lt;00:00, 2485.11 MB/s]
 97%|#########7| 11027/11337 [00:04&lt;00:00, 2657.24 MB/s]
100%|#########9| 11295/11337 [00:04&lt;00:00, 2548.46 MB/s]
100%|##########| 11337/11337 [00:04&lt;00:00, 2325.58 MB/s]

  0%|          | 0/14 [00:00&lt;?, ? MB/s]
 29%|##8       | 4/14 [00:00&lt;00:00, 28.23 MB/s]
 71%|#######1  | 10/14 [00:00&lt;00:00, 36.21 MB/s]
100%|##########| 14/14 [00:00&lt;00:00, 48.87 MB/s]

  0%|          | 0/1037 [00:00&lt;?, ? MB/s]
  0%|          | 4/1037 [00:00&lt;00:36, 28.09 MB/s]
  2%|1         | 16/1037 [00:00&lt;00:16, 60.92 MB/s]
  6%|6         | 67/1037 [00:00&lt;00:04, 196.06 MB/s]
 27%|##6       | 275/1037 [00:00&lt;00:01, 692.98 MB/s]
 61%|######1   | 636/1037 [00:00&lt;00:00, 1473.09 MB/s]
 80%|#######9  | 829/1037 [00:00&lt;00:00, 1585.26 MB/s]
100%|##########| 1037/1037 [00:00&lt;00:00, 1202.60 MB/s]
</pre></div>
</div>
<p>After we do that, our dataset folder should look like this:</p>
<div class="line-block">
<div class="line">stanford_hardi</div>
<div class="line">├── dataset_description.json</div>
<div class="line">└── derivatives</div>
<div class="line-block">
<div class="line">├── freesurfer</div>
<div class="line">│   ├── dataset_description.json</div>
<div class="line">│   └── sub-01</div>
<div class="line">│       └── ses-01</div>
<div class="line">│           └── anat</div>
<div class="line">│               ├── sub-01_ses-01_T1w.nii.gz</div>
<div class="line">│               └── sub-01_ses-01_seg.nii.gz</div>
<div class="line">├── my_tractography</div>
<div class="line">|   ├── dataset_description.json</div>
<div class="line">│   └── sub-01</div>
<div class="line">│       └── ses-01</div>
<div class="line">│           └── dwi</div>
<div class="line">│               └── sub-01_ses-01-dwi_tractography.trk</div>
<div class="line">└── vistasoft</div>
<div class="line-block">
<div class="line">├── dataset_description.json</div>
<div class="line">└── sub-01</div>
<div class="line-block">
<div class="line">└── ses-01</div>
<div class="line-block">
<div class="line">└── dwi</div>
<div class="line-block">
<div class="line">├── sub-01_ses-01_dwi.bvals</div>
<div class="line">├── sub-01_ses-01_dwi.bvecs</div>
<div class="line">└── sub-01_ses-01_dwi.nii.gz</div>
</div>
</div>
</div>
</div>
</div>
</div>
<p>To explore the layout of these derivatives, we will initialize a
<code class="xref py py-class docutils literal notranslate"><span class="pre">BIDSLayout</span></code> class instance to help us see what is in this dataset</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">layout</span> <span class="o">=</span> <span class="n">bids</span><span class="o">.</span><span class="n">BIDSLayout</span><span class="p">(</span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">bids_path</span></a><span class="p">,</span> <span class="n">derivatives</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>Because there is no raw data in this BIDS layout (only derivatives),
pybids will report that there are no subjects and sessions:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">layout</span><span class="p">)</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>BIDS Layout: ...runner/AFQ_data/stanford_hardi | Subjects: 0 | Sessions: 0 | Runs: 0
</pre></div>
</div>
<p>But a query on the derivatives will reveal the different derivatives that
are stored here:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><a href="https://docs.python.org/3/library/stdtypes.html#dict" title="builtins.dict" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">layout</span><span class="o">.</span><span class="n">derivatives</span></a><span class="p">)</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>{&#39;vistasoft&#39;: BIDS Layout: ...rd_hardi/derivatives/vistasoft | Subjects: 1 | Sessions: 1 | Runs: 0, &#39;my_tractography&#39;: BIDS Layout: ...di/derivatives/my_tractography | Subjects: 1 | Sessions: 1 | Runs: 0, &#39;freesurfer&#39;: BIDS Layout: ...d_hardi/derivatives/freesurfer | Subjects: 1 | Sessions: 1 | Runs: 0}
</pre></div>
</div>
<p>We can use a <code class="xref py py-class docutils literal notranslate"><span class="pre">bids.BIDSValidator</span></code> object to make sure that the
files within our data set are BIDS-compliant. For example, we can
extract the tractography derivatives part of our layout using:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">my_tractography</span> <span class="o">=</span> <a href="https://docs.python.org/3/library/stdtypes.html#dict" title="builtins.dict" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">layout</span><span class="o">.</span><span class="n">derivatives</span></a><span class="p">[</span><span class="s2">&quot;my_tractography&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>This variable is also a BIDS layout object. This object has a <code class="docutils literal notranslate"><span class="pre">get</span></code>
method, which allows us to query and find specific items within the
layout. For example, we can ask for files that have a suffix consistent
with tractography results:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">tractography_files</span></a> <span class="o">=</span> <span class="n">my_tractography</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;tractography&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Or ask for files that have a <code class="docutils literal notranslate"><span class="pre">.trk</span></code> extension:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">tractography_files</span></a> <span class="o">=</span> <span class="n">my_tractography</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">extension</span><span class="o">=</span><span class="s1">&#39;.trk&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>In this case, both of these would produce the same result.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tractography_file</span> <span class="o">=</span> <a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">tractography_files</span></a><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tractography_file</span><span class="p">)</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>&lt;BIDSFile filename=&#39;/home/runner/AFQ_data/stanford_hardi/derivatives/my_tractography/sub-01/ses-01/dwi/sub-01_ses-01-dwi_tractography.trk&#39;&gt;
</pre></div>
</div>
<p>We can also get some more structured information about this file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">tractography_file</span><span class="o">.</span><span class="n">get_entities</span><span class="p">())</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>{&#39;datatype&#39;: &#39;dwi&#39;, &#39;extension&#39;: &#39;.trk&#39;, &#39;session&#39;: &#39;01&#39;, &#39;subject&#39;: &#39;01&#39;, &#39;suffix&#39;: &#39;tractography&#39;}
</pre></div>
</div>
<p>We can use a <code class="xref py py-class docutils literal notranslate"><span class="pre">bids.BIDSValidator</span></code> class instance to validate that
this file is compliant with the specification. Note that the validator
requires that the filename be provided relative to the root of the BIDS
dataset, so we have to split the string that contains the full path
of the tractography to extract only the part that is relative to the
root of the entire BIDS <code class="docutils literal notranslate"><span class="pre">layout</span></code> object:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">tractography_full_path</span></a> <span class="o">=</span> <a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">tractography_file</span><span class="o">.</span><span class="n">path</span></a>
<a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">tractography_relative_path</span></a> <span class="o">=</span> <a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">tractography_full_path</span></a><span class="o">.</span><span class="n">split</span><span class="p">(</span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">layout</span><span class="o">.</span><span class="n">root</span></a><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<span class="n">validator</span> <span class="o">=</span> <span class="n">bids</span><span class="o">.</span><span class="n">BIDSValidator</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">validator</span><span class="o">.</span><span class="n">is_bids</span><span class="p">(</span><a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">tractography_relative_path</span></a><span class="p">))</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
<p>Next, we specify the information we need to define the bundles that we are
interested in segmenting. In this case, we are going to use a list of
bundle names for the bundle info. These names refer to bundles for
which we already have clear definitions of the information
needed to segment them (e.g., waypoint ROIs and probability maps).
For an example that includes custom definition of bundle info, see the
<a class="reference external" href="http://yeatmanlab.github.io/pyAFQ/auto_examples/plot_callosal_tract_profile.html">plot_callosal_tract_profile example</a>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">bundle_info</span></a> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;SLF_L&quot;</span><span class="p">,</span> <span class="s2">&quot;SLF_R&quot;</span><span class="p">,</span> <span class="s2">&quot;ARC_L&quot;</span><span class="p">,</span> <span class="s2">&quot;ARC_R&quot;</span><span class="p">,</span>
    <span class="s2">&quot;CST_L&quot;</span><span class="p">,</span> <span class="s2">&quot;CST_R&quot;</span><span class="p">,</span> <span class="s2">&quot;FP&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>Now, we can define our AFQ object, pointing to the derivatives of the
<cite>‘my_tractography’</cite> pipeline as inputs. This is done by setting the
<cite>custom_tractography_bids_filters</cite> key-word argument. We pass the
<cite>bundle_info</cite> defined above. We also point to the preprocessed
data that is in a <cite>‘dmriprep’</cite> pipeline. Note that the pipeline name
is not necessarily the name of the folder it is in; the pipeline name is
defined in each pipeline’s <cite>dataset_description.json</cite>. These data were
preprocessed with ‘vistasoft’, so this is the pipeline we’ll point to
If we were using <cite>‘qsiprep’</cite>, this is where we would pass that
string instead. If we did that, AFQ would look for a derivatives
folder called <cite>‘stanford_hardi/derivatives/qsiprep’</cite> and find the
preprocessed DWI data within it. Finally, to speed things up
a bit, we also sub-sample the provided tractography. This is
done by defining the segmentation_params dictionary input.
To sub-sample to 10,000 streamlines, we define
<cite>‘nb_streamlines’ = 10000</cite>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">my_afq</span> <span class="o">=</span> <span class="n">GroupAFQ</span><span class="p">(</span>
    <a href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">bids_path</span></a><span class="p">,</span>
    <span class="n">preproc_pipeline</span><span class="o">=</span><span class="s1">&#39;vistasoft&#39;</span><span class="p">,</span>
    <a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">bundle_info</span></a><span class="o">=</span><a href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">bundle_info</span></a><span class="p">,</span>
    <span class="n">custom_tractography_bids_filters</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;suffix&quot;</span><span class="p">:</span> <span class="s2">&quot;tractography&quot;</span><span class="p">,</span>
        <span class="s2">&quot;scope&quot;</span><span class="p">:</span> <span class="s2">&quot;my_tractography&quot;</span>
    <span class="p">},</span>
    <span class="n">segmentation_params</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;nb_streamlines&#39;</span><span class="p">:</span> <span class="mi">10000</span><span class="p">})</span>
</pre></div>
</div>
<p>Finally, to run the segmentation and extract tract profiles, we call
The <cite>export_all</cite> method. This creates all of the derivative outputs of
AFQ within the ‘stanford_hardi/derivatives/afq’ folder.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">my_afq</span><span class="o">.</span><span class="n">export_all</span><span class="p">()</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>Optimizing level 2 [max iter: 10000]
Optimizing level 1 [max iter: 1000]
Optimizing level 0 [max iter: 100]
Optimizing level 2 [max iter: 10000]
Optimizing level 1 [max iter: 1000]
Optimizing level 0 [max iter: 100]
Optimizing level 2 [max iter: 10000]
Optimizing level 1 [max iter: 1000]
Optimizing level 0 [max iter: 100]

  0%|          | 0/2565 [00:00&lt;?, ?it/s]
  0%|          | 4/2565 [00:02&lt;30:07,  1.42it/s]
  1%|1         | 36/2565 [00:02&lt;02:31, 16.75it/s]
 20%|##        | 524/2565 [00:03&lt;00:06, 325.44it/s]
 60%|######    | 1548/2565 [00:03&lt;00:00, 1087.11it/s]
 80%|########  | 2060/2565 [00:03&lt;00:00, 1427.63it/s]
100%|##########| 2565/2565 [00:03&lt;00:00, 763.02it/s]

  0%|          | 0/2440 [00:00&lt;?, ?it/s]
  4%|3         | 92/2440 [00:00&lt;00:02, 876.70it/s]
 31%|###1      | 764/2440 [00:00&lt;00:00, 3516.74it/s]
 63%|######2   | 1532/2440 [00:00&lt;00:00, 4551.96it/s]
 84%|########3 | 2044/2440 [00:00&lt;00:00, 4222.01it/s]
100%|##########| 2440/2440 [00:00&lt;00:00, 4752.26it/s]

  0%|          | 0/2195 [00:00&lt;?, ?it/s]
  4%|4         | 92/2195 [00:00&lt;00:02, 879.34it/s]
 35%|###4      | 764/2195 [00:00&lt;00:00, 3930.90it/s]
 70%|######9   | 1532/2195 [00:00&lt;00:00, 5165.40it/s]
 93%|#########3| 2044/2195 [00:00&lt;00:00, 5072.76it/s]
100%|##########| 2195/2195 [00:00&lt;00:00, 4982.29it/s]

  0%|          | 0/1900 [00:00&lt;?, ?it/s]
  5%|4         | 92/1900 [00:00&lt;00:02, 883.62it/s]
 40%|####      | 764/1900 [00:00&lt;00:00, 3904.51it/s]
 81%|########  | 1532/1900 [00:00&lt;00:00, 5236.17it/s]
100%|##########| 1900/1900 [00:00&lt;00:00, 5699.49it/s]

  0%|          | 0/1322 [00:00&lt;?, ?it/s]
  9%|9         | 124/1322 [00:00&lt;00:01, 1195.91it/s]
 77%|#######7  | 1020/1322 [00:00&lt;00:00, 5591.12it/s]
100%|##########| 1322/1322 [00:00&lt;00:00, 6377.05it/s]

  0%|          | 0/1245 [00:00&lt;?, ?it/s]
  5%|4         | 60/1245 [00:00&lt;00:02, 571.89it/s]
 82%|########1 | 1020/1245 [00:00&lt;00:00, 5411.44it/s]
100%|##########| 1245/1245 [00:00&lt;00:00, 5736.86it/s]

  0%|          | 0/1798 [00:00&lt;?, ?it/s]
  2%|2         | 44/1798 [00:00&lt;00:04, 437.58it/s]
 28%|##8       | 508/1798 [00:00&lt;00:00, 2878.24it/s]
 85%|########5 | 1532/1798 [00:00&lt;00:00, 4762.13it/s]
100%|##########| 1798/1798 [00:00&lt;00:00, 4860.86it/s]

  0%|          | 0/5 [00:00&lt;?, ?it/s]
 80%|########  | 4/5 [00:00&lt;00:00, 34.11it/s]
100%|##########| 5/5 [00:00&lt;00:00, 34.47it/s]

  0%|          | 0/5 [00:00&lt;?, ?it/s]
 80%|########  | 4/5 [00:00&lt;00:00, 36.03it/s]
100%|##########| 5/5 [00:00&lt;00:00, 36.08it/s]
</pre></div>
</div>
<p>A few common issues that can hinder BIDS from working properly are:</p>
<ol class="arabic simple">
<li><p>Faulty <cite>dataset_description.json</cite> file. You need to make sure that the
file contains the right names for the pipeline. See above for an example
of that.</p></li>
<li><p>File naming convention doesn’t uniquely identify file with bids filters.</p></li>
</ol>
<p class="sphx-glr-timing"><strong>Total running time of the script:</strong> ( 23 minutes  4.716 seconds)</p>
<div class="sphx-glr-footer class sphx-glr-footer-example docutils container" id="sphx-glr-download-auto-examples-plot-bids-layout-py">
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../_downloads/9bdf3bad98b30ef023e365f728dd0600/plot_bids_layout.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">plot_bids_layout.py</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../_downloads/8c66bf5eff5959786100ed0e3b200d1e/plot_bids_layout.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">plot_bids_layout.ipynb</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</div>


              </div>
              
              
              <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="plot_optic_radiations.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Plotting the Optic Radiations</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="cloudknot_example.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Using cloudknot to run pyAFQ on AWS batch:</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
              
          </main>
          

      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>

<footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2018--, The pyAFQ Contributors.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.5.0.<br>
</p>
    </div>
    
  </div>
</footer>
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
var pageTracker = _gat._getTracker("UA-156363454-2");
pageTracker._trackPageview();
} catch(err) {}</script>

  </body>
</html>