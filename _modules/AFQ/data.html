
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AFQ.data &#8212; AFQ 0.1 documentation</title>
    
  <link href="../../_static/css/theme.css" rel="stylesheet" />
  <link href="../../_static/css/index.f6b7ca918bee2f46fd9abac01cfb07d5.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/basic.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/gallery.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/gallery-rendered-html.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css" />
    
  <link rel="preload" as="script" href="../../_static/js/index.1e043a052b0af929e4d8.js">

    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">


    
    <a class="navbar-brand" href="../../index.html">
      <p class="title">AFQ</p>
    </a>
    

    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-menu" aria-controls="navbar-menu" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>

    
    <div id="navbar-menu" class="col-lg-9 collapse navbar-collapse">
      <ul id="navbar-main-elements" class="navbar-nav mr-auto">
        <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../installation_guide.html">
  Installing
  <code class="docutils literal notranslate">
   <span class="pre">
    pyAFQ
   </span>
  </code>
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../usage/index.html">
  Using pyAFQ
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../auto_examples/index.html">
  Examples
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../getting_help.html">
  Getting help using pyAFQ
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../contributing.html">
  Contributing to pyAFQ
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../autoapi/index.html">
  API Reference
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../developing/index.html">
  Developing
  <cite>
   pyAFQ
  </cite>
 </a>
</li>

        
      </ul>

      <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
      </ul>
    </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar"><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form>
<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    
  </div>
</nav>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
              

<nav id="bd-toc-nav">
    
</nav>


              
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <h1>Source code for AFQ.data</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">dipy.align</span> <span class="kn">import</span> <span class="n">resample</span>
<span class="kn">from</span> <span class="nn">dipy.segment.clustering</span> <span class="kn">import</span> <span class="n">QuickBundles</span>
<span class="kn">from</span> <span class="nn">dipy.segment.metric</span> <span class="kn">import</span> <span class="p">(</span><span class="n">AveragePointwiseEuclideanMetric</span><span class="p">,</span>
                                 <span class="n">ResampleFeature</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">dipy.io.streamline</span> <span class="kn">import</span> <span class="n">load_tractogram</span><span class="p">,</span> <span class="n">load_trk</span>
<span class="kn">from</span> <span class="nn">dipy.data.fetcher</span> <span class="kn">import</span> <span class="n">_make_fetcher</span>
<span class="kn">import</span> <span class="nn">dipy.data</span> <span class="k">as</span> <span class="nn">dpd</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span>
<span class="kn">import</span> <span class="nn">gzip</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">os.path</span> <span class="k">as</span> <span class="nn">op</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">glob</span> <span class="kn">import</span> <span class="n">glob</span>
<span class="kn">import</span> <span class="nn">shutil</span>

<span class="kn">import</span> <span class="nn">boto3</span>
<span class="kn">import</span> <span class="nn">s3fs</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">bids</span> <span class="kn">import</span> <span class="n">BIDSLayout</span>
<span class="kn">import</span> <span class="nn">bids.config</span> <span class="k">as</span> <span class="nn">bids_config</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">bids_config</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;extension_initial_dot&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
    <span class="k">pass</span>
<span class="kn">from</span> <span class="nn">botocore</span> <span class="kn">import</span> <span class="n">UNSIGNED</span>
<span class="kn">from</span> <span class="nn">botocore.client</span> <span class="kn">import</span> <span class="n">Config</span>
<span class="kn">from</span> <span class="nn">dask</span> <span class="kn">import</span> <span class="n">compute</span><span class="p">,</span> <span class="n">delayed</span>
<span class="kn">from</span> <span class="nn">dask.diagnostics</span> <span class="kn">import</span> <span class="n">ProgressBar</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">tqdm.auto</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">nibabel</span> <span class="k">as</span> <span class="nn">nib</span>

<span class="c1"># capture templateflow resource warning and log</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">default_warning_format</span> <span class="o">=</span> <span class="n">warnings</span><span class="o">.</span><span class="n">formatwarning</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">formatwarning</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">msg</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">captureWarnings</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">pywarnings_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;py.warnings&#39;</span><span class="p">)</span>
    <span class="n">console_handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
    <span class="n">console_handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">BASIC_FORMAT</span><span class="p">))</span>
    <span class="n">pywarnings_logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">console_handler</span><span class="p">)</span>

    <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span>
        <span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">ResourceWarning</span><span class="p">,</span>
        <span class="n">module</span><span class="o">=</span><span class="s2">&quot;templateflow&quot;</span><span class="p">)</span>

    <span class="kn">from</span> <span class="nn">templateflow</span> <span class="kn">import</span> <span class="n">api</span> <span class="k">as</span> <span class="n">tflow</span>
<span class="k">finally</span><span class="p">:</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">captureWarnings</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">formatwarning</span> <span class="o">=</span> <span class="n">default_warning_format</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;fetch_callosum_templates&quot;</span><span class="p">,</span> <span class="s2">&quot;read_callosum_templates&quot;</span><span class="p">,</span>
           <span class="s2">&quot;fetch_templates&quot;</span><span class="p">,</span> <span class="s2">&quot;read_templates&quot;</span><span class="p">,</span> <span class="s2">&quot;fetch_hcp&quot;</span><span class="p">,</span>
           <span class="s2">&quot;fetch_stanford_hardi_tractography&quot;</span><span class="p">,</span>
           <span class="s2">&quot;read_stanford_hardi_tractography&quot;</span><span class="p">,</span>
           <span class="s2">&quot;organize_stanford_data&quot;</span><span class="p">]</span>


<span class="n">BUNDLE_RECO_2_AFQ</span> <span class="o">=</span> \
    <span class="p">{</span>
        <span class="s2">&quot;AF_L&quot;</span><span class="p">:</span> <span class="s2">&quot;ARC_L&quot;</span><span class="p">,</span> <span class="s2">&quot;AF_R&quot;</span><span class="p">:</span> <span class="s2">&quot;ARC_R&quot;</span><span class="p">,</span>
        <span class="s2">&quot;UF_L&quot;</span><span class="p">:</span> <span class="s2">&quot;UNC_L&quot;</span><span class="p">,</span> <span class="s2">&quot;UF_R&quot;</span><span class="p">:</span> <span class="s2">&quot;UNC_R&quot;</span><span class="p">,</span>
        <span class="s2">&quot;IFOF_L&quot;</span><span class="p">:</span> <span class="s2">&quot;IFO_L&quot;</span><span class="p">,</span> <span class="s2">&quot;IFOF_R&quot;</span><span class="p">:</span> <span class="s2">&quot;IFO_R&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CST_L&quot;</span><span class="p">:</span> <span class="s2">&quot;CST_L&quot;</span><span class="p">,</span> <span class="s2">&quot;CST_R&quot;</span><span class="p">:</span> <span class="s2">&quot;CST_R&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ILF_L&quot;</span><span class="p">:</span> <span class="s2">&quot;ILF_L&quot;</span><span class="p">,</span> <span class="s2">&quot;ILF_R&quot;</span><span class="p">:</span> <span class="s2">&quot;ILF_R&quot;</span><span class="p">,</span>
        <span class="s2">&quot;SLF_L&quot;</span><span class="p">:</span> <span class="s2">&quot;SLF_L&quot;</span><span class="p">,</span> <span class="s2">&quot;SLF_R&quot;</span><span class="p">:</span> <span class="s2">&quot;SLF_R&quot;</span>
    <span class="p">}</span>

<span class="n">BUNDLE_MAT_2_PYTHON</span> <span class="o">=</span> \
    <span class="p">{</span><span class="s1">&#39;Right Corticospinal&#39;</span><span class="p">:</span> <span class="s1">&#39;CST_R&#39;</span><span class="p">,</span> <span class="s1">&#39;Left Corticospinal&#39;</span><span class="p">:</span> <span class="s1">&#39;CST_L&#39;</span><span class="p">,</span>
     <span class="s1">&#39;RightCorticospinal&#39;</span><span class="p">:</span> <span class="s1">&#39;CST_R&#39;</span><span class="p">,</span> <span class="s1">&#39;LeftCorticospinal&#39;</span><span class="p">:</span> <span class="s1">&#39;CST_L&#39;</span><span class="p">,</span>
     <span class="s1">&#39;Right Uncinate&#39;</span><span class="p">:</span> <span class="s1">&#39;UNC_R&#39;</span><span class="p">,</span> <span class="s1">&#39;Left Uncinate&#39;</span><span class="p">:</span> <span class="s1">&#39;UNC_L&#39;</span><span class="p">,</span>
     <span class="s1">&#39;RightUncinate&#39;</span><span class="p">:</span> <span class="s1">&#39;UNC_R&#39;</span><span class="p">,</span> <span class="s1">&#39;LeftUncinate&#39;</span><span class="p">:</span> <span class="s1">&#39;UNC_L&#39;</span><span class="p">,</span>
     <span class="s1">&#39;Left IFOF&#39;</span><span class="p">:</span> <span class="s1">&#39;IFO_L&#39;</span><span class="p">,</span> <span class="s1">&#39;Right IFOF&#39;</span><span class="p">:</span> <span class="s1">&#39;IFO_R&#39;</span><span class="p">,</span>
     <span class="s1">&#39;LeftIFOF&#39;</span><span class="p">:</span> <span class="s1">&#39;IFO_L&#39;</span><span class="p">,</span> <span class="s1">&#39;RightIFOF&#39;</span><span class="p">:</span> <span class="s1">&#39;IFO_R&#39;</span><span class="p">,</span>
     <span class="s1">&#39;Right Arcuate&#39;</span><span class="p">:</span> <span class="s1">&#39;ARC_R&#39;</span><span class="p">,</span> <span class="s1">&#39;Left Arcuate&#39;</span><span class="p">:</span> <span class="s1">&#39;ARC_L&#39;</span><span class="p">,</span>
     <span class="s1">&#39;RightArcuate&#39;</span><span class="p">:</span> <span class="s1">&#39;ARC_R&#39;</span><span class="p">,</span> <span class="s1">&#39;LeftArcuate&#39;</span><span class="p">:</span> <span class="s1">&#39;ARC_L&#39;</span><span class="p">,</span>
     <span class="s1">&#39;Right Thalamic Radiation&#39;</span><span class="p">:</span> <span class="s1">&#39;ATR_R&#39;</span><span class="p">,</span> <span class="s1">&#39;Left Thalamic Radiation&#39;</span><span class="p">:</span> <span class="s1">&#39;ATR_L&#39;</span><span class="p">,</span>
     <span class="s1">&#39;RightThalamicRadiation&#39;</span><span class="p">:</span> <span class="s1">&#39;ATR_R&#39;</span><span class="p">,</span> <span class="s1">&#39;LeftThalamicRadiation&#39;</span><span class="p">:</span> <span class="s1">&#39;ATR_L&#39;</span><span class="p">,</span>
     <span class="s1">&#39;Right Cingulum Cingulate&#39;</span><span class="p">:</span> <span class="s1">&#39;CGC_R&#39;</span><span class="p">,</span> <span class="s1">&#39;Left Cingulum Cingulate&#39;</span><span class="p">:</span> <span class="s1">&#39;CGC_L&#39;</span><span class="p">,</span>
     <span class="s1">&#39;RightCingulumCingulate&#39;</span><span class="p">:</span> <span class="s1">&#39;CGC_R&#39;</span><span class="p">,</span> <span class="s1">&#39;LeftCingulumCingulate&#39;</span><span class="p">:</span> <span class="s1">&#39;CGC_L&#39;</span><span class="p">,</span>
     <span class="s1">&#39;Right Cingulum Hippocampus&#39;</span><span class="p">:</span> <span class="s1">&#39;HCC_R&#39;</span><span class="p">,</span>
     <span class="s1">&#39;Left Cingulum Hippocampus&#39;</span><span class="p">:</span> <span class="s1">&#39;HCC_L&#39;</span><span class="p">,</span>
     <span class="s1">&#39;RightCingulumHippocampus&#39;</span><span class="p">:</span> <span class="s1">&#39;HCC_R&#39;</span><span class="p">,</span>
     <span class="s1">&#39;LeftCingulumHippocampus&#39;</span><span class="p">:</span> <span class="s1">&#39;HCC_L&#39;</span><span class="p">,</span>
     <span class="s1">&#39;Callosum Forceps Major&#39;</span><span class="p">:</span> <span class="s1">&#39;FP&#39;</span><span class="p">,</span> <span class="s1">&#39;Callosum Forceps Minor&#39;</span><span class="p">:</span> <span class="s1">&#39;FA&#39;</span><span class="p">,</span>
     <span class="s1">&#39;CallosumForcepsMajor&#39;</span><span class="p">:</span> <span class="s1">&#39;FP&#39;</span><span class="p">,</span> <span class="s1">&#39;CallosumForcepsMinor&#39;</span><span class="p">:</span> <span class="s1">&#39;FA&#39;</span><span class="p">,</span>
     <span class="s1">&#39;Right ILF&#39;</span><span class="p">:</span> <span class="s1">&#39;ILF_R&#39;</span><span class="p">,</span> <span class="s1">&#39;Left ILF&#39;</span><span class="p">:</span> <span class="s1">&#39;ILF_L&#39;</span><span class="p">,</span>
     <span class="s1">&#39;RightILF&#39;</span><span class="p">:</span> <span class="s1">&#39;ILF_R&#39;</span><span class="p">,</span> <span class="s1">&#39;LeftILF&#39;</span><span class="p">:</span> <span class="s1">&#39;ILF_L&#39;</span><span class="p">,</span>
     <span class="s1">&#39;Right SLF&#39;</span><span class="p">:</span> <span class="s1">&#39;SLF_R&#39;</span><span class="p">,</span> <span class="s1">&#39;Left SLF&#39;</span><span class="p">:</span> <span class="s1">&#39;SLF_L&#39;</span><span class="p">,</span>
     <span class="s1">&#39;RightSLF&#39;</span><span class="p">:</span> <span class="s1">&#39;SLF_R&#39;</span><span class="p">,</span> <span class="s1">&#39;LeftSLF&#39;</span><span class="p">:</span> <span class="s1">&#39;SLF_L&#39;</span><span class="p">}</span>

<span class="n">afq_home</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">),</span> <span class="s1">&#39;AFQ_data&#39;</span><span class="p">)</span>

<span class="n">baseurl</span> <span class="o">=</span> <span class="s2">&quot;https://ndownloader.figshare.com/files/&quot;</span>

<span class="n">callosum_fnames</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Callosum_midsag.nii.gz&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;L_AntFrontal.nii.gz&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;L_Motor.nii.gz&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;L_Occipital.nii.gz&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;L_Orbital.nii.gz&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;L_PostParietal.nii.gz&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;L_SupFrontal.nii.gz&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;L_SupParietal.nii.gz&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;L_Temporal.nii.gz&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;R_AntFrontal.nii.gz&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;R_Motor.nii.gz&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;R_Occipital.nii.gz&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;R_Orbital.nii.gz&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;R_PostParietal.nii.gz&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;R_SupFrontal.nii.gz&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;R_SupParietal.nii.gz&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;R_Temporal.nii.gz&quot;</span><span class="p">]</span>

<span class="n">callosum_remote_fnames</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;5273794&quot;</span><span class="p">,</span> <span class="s2">&quot;5273797&quot;</span><span class="p">,</span> <span class="s2">&quot;5273800&quot;</span><span class="p">,</span> <span class="s2">&quot;5273803&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;5273806&quot;</span><span class="p">,</span> <span class="s2">&quot;5273809&quot;</span><span class="p">,</span> <span class="s2">&quot;5273812&quot;</span><span class="p">,</span> <span class="s2">&quot;5273815&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;5273821&quot;</span><span class="p">,</span> <span class="s2">&quot;5273818&quot;</span><span class="p">,</span> <span class="s2">&quot;5273824&quot;</span><span class="p">,</span> <span class="s2">&quot;5273827&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;5273830&quot;</span><span class="p">,</span> <span class="s2">&quot;5273833&quot;</span><span class="p">,</span> <span class="s2">&quot;5273836&quot;</span><span class="p">,</span> <span class="s2">&quot;5273839&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;5273842&quot;</span><span class="p">]</span>

<span class="n">callosum_md5_hashes</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;709fa90baadeacd64f1d62b5049a4125&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;987c6169de807c4e93dc2cbd7a25d506&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;0da114123d0b0097b96fe450a459550b&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;6d845bd10504f67f1dc17f9000076d7e&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;e16c7873ef4b08d26b77ef746dab8237&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;47193fd4df1ea17367817466de798b90&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;7e78bf9671e6945f4b2f5e7c30595a3c&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;8adbb947377ff7b484c88d8c0ffc2125&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;0fd981a4d0847e0642ff96e84fe44e47&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;87c4855efa406d8fb004cffb8259180e&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;c7969bcf5f2343fd9ce9c49b336cf14c&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;bb4372b88991932150205ffb22aa6cb7&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;d198d4e7db18ddc7236cf143ecb8342e&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;d0f6edef64b0c710c92e634496085dda&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;85eaee44665f244db5adae2e259833f6&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;25f24eb22879a05d12bda007c81ea55a&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;2664e0b8c2d9c59f13649a89bfcce399&quot;</span><span class="p">]</span>

<div class="viewcode-block" id="fetch_callosum_templates"><a class="viewcode-back" href="../../autoapi/AFQ/index.html#AFQ.data.fetch_callosum_templates">[docs]</a><span class="n">fetch_callosum_templates</span> <span class="o">=</span> <span class="n">_make_fetcher</span><span class="p">(</span><span class="s2">&quot;fetch_callosum_templates&quot;</span><span class="p">,</span>
                                         <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">afq_home</span><span class="p">,</span>
                                                 <span class="s1">&#39;callosum_templates&#39;</span><span class="p">),</span>
                                         <span class="n">baseurl</span><span class="p">,</span> <span class="n">callosum_remote_fnames</span><span class="p">,</span>
                                         <span class="n">callosum_fnames</span><span class="p">,</span>
                                         <span class="n">md5_list</span><span class="o">=</span><span class="n">callosum_md5_hashes</span><span class="p">,</span>
                                         <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;Download AFQ callosum templates&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="read_callosum_templates"><a class="viewcode-back" href="../../autoapi/AFQ/index.html#AFQ.data.read_callosum_templates">[docs]</a><span class="k">def</span> <span class="nf">read_callosum_templates</span><span class="p">(</span><span class="n">resample_to</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Load AFQ callosum templates from file</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict with: keys: names of template ROIs and values: nibabel Nifti1Image</span>
<span class="sd">    objects from each of the ROI nifti files.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;AFQ.data&#39;</span><span class="p">)</span>

    <span class="n">files</span><span class="p">,</span> <span class="n">folder</span> <span class="o">=</span> <span class="n">fetch_callosum_templates</span><span class="p">()</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;loading callosum templates&#39;</span><span class="p">)</span>
    <span class="n">tic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>

    <span class="n">template_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">resample_to</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">resample_to</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">resample_to</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">resample_to</span><span class="p">)</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">Nifti1Image</span><span class="p">(</span><span class="n">resample</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">(),</span>
                                           <span class="n">resample_to</span><span class="p">,</span>
                                           <span class="n">img</span><span class="o">.</span><span class="n">affine</span><span class="p">,</span>
                                           <span class="n">resample_to</span><span class="o">.</span><span class="n">affine</span><span class="p">)</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">(),</span>
                                  <span class="n">resample_to</span><span class="o">.</span><span class="n">affine</span><span class="p">)</span>
        <span class="n">template_dict</span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">img</span>

    <span class="n">toc</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;callosum templates loaded in </span><span class="si">{</span><span class="n">toc</span> <span class="o">-</span> <span class="n">tic</span><span class="si">:</span><span class="s1">0.4f</span><span class="si">}</span><span class="s1"> seconds&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">template_dict</span></div>


<span class="k">def</span> <span class="nf">read_resample_roi</span><span class="p">(</span><span class="n">roi</span><span class="p">,</span> <span class="n">resample_to</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads an roi from file-name/img and resamples it to conform with</span>
<span class="sd">    another file-name/img.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    roi : str or nibabel image class instance.</span>
<span class="sd">        Should contain a binary volume with 1s in the region of interest and</span>
<span class="sd">        0s elsewhere.</span>

<span class="sd">    resample_to : str or nibabel image class instance, optional</span>
<span class="sd">        A template image to resample to. Typically, this should be the</span>
<span class="sd">        template to which individual-level data are registered. Defaults to</span>
<span class="sd">        the MNI template.</span>

<span class="sd">    threshold: bool or float</span>
<span class="sd">        If set to False (default), resampled result is returned. Otherwise,</span>
<span class="sd">        the resampled result is thresholded at this value and binarized.</span>
<span class="sd">        This is not applied if the input ROI is already in the space of the</span>
<span class="sd">        output.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    nibabel image class instance that contains the binary ROI resampled into</span>
<span class="sd">    the requested space.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">roi</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">roi</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">roi</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">resample_to</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">resample_to</span> <span class="o">=</span> <span class="n">read_mni_template</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">resample_to</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">resample_to</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">resample_to</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">resample_to</span><span class="o">.</span><span class="n">affine</span><span class="p">,</span> <span class="n">roi</span><span class="o">.</span><span class="n">affine</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">roi</span>

    <span class="n">as_array</span> <span class="o">=</span> <span class="n">resample</span><span class="p">(</span>
        <span class="n">roi</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">(),</span>
        <span class="n">resample_to</span><span class="p">,</span>
        <span class="n">roi</span><span class="o">.</span><span class="n">affine</span><span class="p">,</span>
        <span class="n">resample_to</span><span class="o">.</span><span class="n">affine</span><span class="p">)</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">threshold</span><span class="p">:</span>
        <span class="n">as_array</span> <span class="o">=</span> <span class="p">(</span><span class="n">as_array</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="n">img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">Nifti1Image</span><span class="p">(</span>
        <span class="n">as_array</span><span class="p">,</span>
        <span class="n">resample_to</span><span class="o">.</span><span class="n">affine</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">img</span>


<span class="n">template_fnames</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ATR_roi1_L.nii.gz&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;ATR_roi1_R.nii.gz&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;ATR_roi2_L.nii.gz&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;ATR_roi2_R.nii.gz&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;ATR_L_prob_map.nii.gz&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;ATR_R_prob_map.nii.gz&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;CGC_roi1_L.nii.gz&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;CGC_roi1_R.nii.gz&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;CGC_roi2_L.nii.gz&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;CGC_roi2_R.nii.gz&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;CGC_L_prob_map.nii.gz&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;CGC_R_prob_map.nii.gz&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;CST_roi1_L.nii.gz&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;CST_roi1_R.nii.gz&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;CST_roi2_L.nii.gz&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;CST_roi2_R.nii.gz&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;CST_L_prob_map.nii.gz&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;CST_R_prob_map.nii.gz&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;FA_L.nii.gz&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;FA_R.nii.gz&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;FA_prob_map.nii.gz&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;FP_L.nii.gz&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;FP_R.nii.gz&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;FP_prob_map.nii.gz&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;HCC_roi1_L.nii.gz&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;HCC_roi1_R.nii.gz&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;HCC_roi2_L.nii.gz&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;HCC_roi2_R.nii.gz&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;HCC_L_prob_map.nii.gz&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;HCC_R_prob_map.nii.gz&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;IFO_roi1_L.nii.gz&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;IFO_roi1_R.nii.gz&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;IFO_roi2_L.nii.gz&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;IFO_roi2_R.nii.gz&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;IFO_L_prob_map.nii.gz&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;IFO_R_prob_map.nii.gz&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;ILF_roi1_L.nii.gz&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;ILF_roi1_R.nii.gz&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;ILF_roi2_L.nii.gz&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;ILF_roi2_R.nii.gz&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;ILF_L_prob_map.nii.gz&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;ILF_R_prob_map.nii.gz&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;SLF_roi1_L.nii.gz&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;SLF_roi1_R.nii.gz&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;SLF_roi2_L.nii.gz&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;SLF_roi2_R.nii.gz&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;SLFt_roi2_L.nii.gz&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;SLFt_roi2_R.nii.gz&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;SLF_L_prob_map.nii.gz&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;SLF_R_prob_map.nii.gz&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;UNC_roi1_L.nii.gz&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;UNC_roi1_R.nii.gz&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;UNC_roi2_L.nii.gz&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;UNC_roi2_R.nii.gz&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;UNC_L_prob_map.nii.gz&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;UNC_R_prob_map.nii.gz&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;ARC_L_prob_map.nii.gz&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;ARC_R_prob_map.nii.gz&quot;</span><span class="p">]</span>


<span class="n">template_remote_fnames</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;5273680&quot;</span><span class="p">,</span> <span class="s2">&quot;5273683&quot;</span><span class="p">,</span> <span class="s2">&quot;5273686&quot;</span><span class="p">,</span> <span class="s2">&quot;5273689&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;11458274&quot;</span><span class="p">,</span> <span class="s2">&quot;11458277&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;5273695&quot;</span><span class="p">,</span> <span class="s2">&quot;5273692&quot;</span><span class="p">,</span> <span class="s2">&quot;5273698&quot;</span><span class="p">,</span> <span class="s2">&quot;5273701&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;11458268&quot;</span><span class="p">,</span> <span class="s2">&quot;11458271&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;5273704&quot;</span><span class="p">,</span> <span class="s2">&quot;5273707&quot;</span><span class="p">,</span> <span class="s2">&quot;5273710&quot;</span><span class="p">,</span> <span class="s2">&quot;5273713&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;11458262&quot;</span><span class="p">,</span> <span class="s2">&quot;11458265&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;5273716&quot;</span><span class="p">,</span> <span class="s2">&quot;5273719&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;11458220&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;5273722&quot;</span><span class="p">,</span> <span class="s2">&quot;5273725&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;11458226&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;5273728&quot;</span><span class="p">,</span> <span class="s2">&quot;5273731&quot;</span><span class="p">,</span> <span class="s2">&quot;5273734&quot;</span><span class="p">,</span> <span class="s2">&quot;5273746&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;11458259&quot;</span><span class="p">,</span> <span class="s2">&quot;11458256&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;5273737&quot;</span><span class="p">,</span> <span class="s2">&quot;5273740&quot;</span><span class="p">,</span> <span class="s2">&quot;5273743&quot;</span><span class="p">,</span> <span class="s2">&quot;5273749&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;11458250&quot;</span><span class="p">,</span> <span class="s2">&quot;11458253&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;5273752&quot;</span><span class="p">,</span> <span class="s2">&quot;5273755&quot;</span><span class="p">,</span> <span class="s2">&quot;5273758&quot;</span><span class="p">,</span> <span class="s2">&quot;5273761&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;11458244&quot;</span><span class="p">,</span> <span class="s2">&quot;11458247&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;5273764&quot;</span><span class="p">,</span> <span class="s2">&quot;5273767&quot;</span><span class="p">,</span> <span class="s2">&quot;5273770&quot;</span><span class="p">,</span> <span class="s2">&quot;5273773&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;5273776&quot;</span><span class="p">,</span> <span class="s2">&quot;5273791&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;11458238&quot;</span><span class="p">,</span> <span class="s2">&quot;11458241&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;5273779&quot;</span><span class="p">,</span> <span class="s2">&quot;5273782&quot;</span><span class="p">,</span> <span class="s2">&quot;5273785&quot;</span><span class="p">,</span> <span class="s2">&quot;5273788&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;11458223&quot;</span><span class="p">,</span> <span class="s2">&quot;11458229&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;11458232&quot;</span><span class="p">,</span> <span class="s2">&quot;11458235&quot;</span><span class="p">]</span>


<span class="n">template_md5_hashes</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;6b7aaed1a2982fd0ea436a223133908b&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;fd60d46d4e3cbd906c86e4c9e4fd6e2a&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;3aba60b169a35c38640de4ec29d362c8&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;12716a5688a1809fbaed1d58d2e68b59&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;c5637f471df861d9bbb45604db34770b&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;850cc4c04d7241747063fe3cd440b2ce&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;8e8973bc7838c8744914d402f52d91ca&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;c5fa4e6e685e695c006823b6784d2407&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;e1fab77f21d5303ed52285f015e24f0b&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;5f89defec3753fd75cd688c7bfb20a36&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;a4f3cd65b06fb25f63d5dab7592f00f2&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;7e73ab02db30a3ad6bd9e82148c2486e&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;f9db3154955a20b67c2dda758800d14c&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;73941510c798c1ed1b03e2bd481cd5c7&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;660cdc031ee0716d60159c7d933119ea&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;660cdc031ee0716d60159c7d933119ea&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;fd012bc89f6bed7bd54530195496bac4&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;3406906a86e633cc102127cf210a1063&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;9040a7953dcbbf131d135c866182d8ef&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;a72e17194824fcd838a594a2eb50c72e&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;627d7bb2e6d55f8243da815a36d9ff1a&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;55adbe9b8279185eedbe342149e1ff90&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;5a7412a3cf0fb185eec53d1989df2f7c&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;1aa36e83ae7b5555bb19d776ede9c18d&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;ba453196ff179b0e31172806e313b52c&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;d85c6574526b296935f34bf4f65cd493&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;9b81646317f59c7db087f27e2f85679e&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;9806e82c250e4604534b96917f87b7e8&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;213d3fb1ccd756d878f9b50b765b1c8f&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;f1e7e6bc51aa0aa279c54fb3805fb5e3&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;0e68a9feaaddcc9b4d667c2f15903368&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;d45020a87ee4bb496edd350631d91f6a&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;75c2c911826ec4b23159f9bd80e3c039&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;55d616ea9e0c646adc1aafa0f5fbe625&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;dee83fa6b03cfa5e0f5c965953aa6778&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;a13eef7059c98568adfefbab660e434e&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;045b7d5c6341997f3f0120c3a4212ad8&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;d174b1359ba982b03840436c93b7bbb4&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;fff9753f394fc4c73fb2ae40b3b4dde0&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;cd278b4dd6ff77481ea9ac16485a5ae2&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;7bdf5111265107091c7a2fca9215de30&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;7d4a43714504e6e930f922c9bc2a13d5&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;af2bcedf47e193686af329b9a8e259da&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;9a1122943579d11ba169d3ad87a75625&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;627903f7a06627bfd4153dc9245fa390&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;1714cd7f989c3435bdd5a2076e6272a0&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;1fa2114049707a4e05b53f9d95730375&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;b6663067d5ea53c70cb8803948f8adf7&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;d3e068997ebc60407bd6e9576e47dede&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;27ecfbd1d2f98213e52d73b7d70fe0e7&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;fa141bb2d951bec486916acda3652d95&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;d391d073e86e28588be9a6d01b2e7a82&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;a3e085562e6b8111c7ebc358f9450c8b&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;d65c67910807504735e034f7ea92d590&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;93cb24a9128db1a6c34a09eaf79fe7f0&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;71a7455cb4062dc39b1677c118c7b5a5&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;19590c712f1776da1fdba64d4eb7f1f6&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;04d5af0feb2c1b5b52a87ccbbf148e4b&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;53c277be990d00f7de04f2ea35e74d73&quot;</span><span class="p">]</span>

<div class="viewcode-block" id="fetch_templates"><a class="viewcode-back" href="../../autoapi/AFQ/index.html#AFQ.data.fetch_templates">[docs]</a><span class="n">fetch_templates</span> <span class="o">=</span> <span class="n">_make_fetcher</span><span class="p">(</span><span class="s2">&quot;fetch_templates&quot;</span><span class="p">,</span>
                                <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">afq_home</span><span class="p">,</span> <span class="s1">&#39;templates&#39;</span><span class="p">),</span>
                                <span class="n">baseurl</span><span class="p">,</span> <span class="n">template_remote_fnames</span><span class="p">,</span>
                                <span class="n">template_fnames</span><span class="p">,</span> <span class="n">md5_list</span><span class="o">=</span><span class="n">template_md5_hashes</span><span class="p">,</span>
                                <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;Download AFQ templates&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="read_templates"><a class="viewcode-back" href="../../autoapi/AFQ/index.html#AFQ.data.read_templates">[docs]</a><span class="k">def</span> <span class="nf">read_templates</span><span class="p">(</span><span class="n">resample_to</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Load AFQ templates from file</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict with: keys: names of template ROIs and values: nibabel Nifti1Image</span>
<span class="sd">    objects from each of the ROI nifti files.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;AFQ.data&#39;</span><span class="p">)</span>

    <span class="n">files</span><span class="p">,</span> <span class="n">folder</span> <span class="o">=</span> <span class="n">fetch_templates</span><span class="p">()</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;loading AFQ templates&#39;</span><span class="p">)</span>
    <span class="n">tic</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>

    <span class="n">template_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">resample_to</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">resample_to</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">resample_to</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">resample_to</span><span class="p">)</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">Nifti1Image</span><span class="p">(</span>
                <span class="n">resample</span><span class="p">(</span>
                    <span class="n">img</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">(),</span>
                    <span class="n">resample_to</span><span class="p">,</span>
                    <span class="n">img</span><span class="o">.</span><span class="n">affine</span><span class="p">,</span>
                    <span class="n">resample_to</span><span class="o">.</span><span class="n">affine</span><span class="p">)</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">(),</span>
                <span class="n">resample_to</span><span class="o">.</span><span class="n">affine</span><span class="p">)</span>
        <span class="n">template_dict</span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">img</span>

    <span class="n">toc</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;AFQ templates loaded in </span><span class="si">{</span><span class="n">toc</span> <span class="o">-</span> <span class="n">tic</span><span class="si">:</span><span class="s1">0.4f</span><span class="si">}</span><span class="s1"> seconds&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">template_dict</span></div>


<span class="c1"># +----------------------------------------------------+</span>
<span class="c1"># | Begin S3BIDSStudy classes and supporting functions |</span>
<span class="c1"># +----------------------------------------------------+</span>
<span class="k">def</span> <span class="nf">get_s3_client</span><span class="p">(</span><span class="n">anon</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a boto3 s3 client</span>

<span class="sd">    Global boto clients are not thread safe so we use this function</span>
<span class="sd">    to return independent session clients for different threads.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    anon : bool</span>
<span class="sd">        Whether to use anonymous connection (public buckets only).</span>
<span class="sd">        If False, uses the key/secret given, or botos credential</span>
<span class="sd">        resolver (client_kwargs, environment, variables, config files,</span>
<span class="sd">        EC2 IAM server, in that order). Default: True</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    s3_client : boto3.client(&#39;s3&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">anon</span><span class="p">:</span>
        <span class="n">s3_client</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">client</span><span class="p">(</span>
            <span class="s1">&#39;s3&#39;</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="n">Config</span><span class="p">(</span><span class="n">signature_version</span><span class="o">=</span><span class="n">UNSIGNED</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">s3_client</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;s3&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">s3_client</span>


<span class="k">def</span> <span class="nf">_ls_s3fs</span><span class="p">(</span><span class="n">s3_prefix</span><span class="p">,</span> <span class="n">anon</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns a dict of list of files using s3fs</span>

<span class="sd">    The files are divided between subject directories/files and</span>
<span class="sd">    non-subject directories/files.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    s3_prefix : str</span>
<span class="sd">        AWS S3 key for the study or site &quot;directory&quot; that contains all</span>
<span class="sd">        of the subjects</span>

<span class="sd">    anon : bool</span>
<span class="sd">        Whether to use anonymous connection (public buckets only).</span>
<span class="sd">        If False, uses the key/secret given, or botos credential</span>
<span class="sd">        resolver (client_kwargs, environment, variables, config files,</span>
<span class="sd">        EC2 IAM server, in that order). Default: True</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    subjects : dict</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fs</span> <span class="o">=</span> <span class="n">s3fs</span><span class="o">.</span><span class="n">S3FileSystem</span><span class="p">(</span><span class="n">anon</span><span class="o">=</span><span class="n">anon</span><span class="p">)</span>
    <span class="n">site_files</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">ls</span><span class="p">(</span><span class="n">s3_prefix</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Just need BIDSLayout for the `parse_file_entities` method</span>
    <span class="c1"># so we can pass dev/null as the argument</span>
    <span class="n">layout</span> <span class="o">=</span> <span class="n">BIDSLayout</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">devnull</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">entities</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">layout</span><span class="o">.</span><span class="n">parse_file_entities</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">site_files</span>
    <span class="p">]</span>

    <span class="n">files</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;subjects&#39;</span><span class="p">:</span> <span class="p">[</span>
            <span class="n">f</span> <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">site_files</span><span class="p">,</span> <span class="n">entities</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;subject&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">],</span>
        <span class="s1">&#39;other&#39;</span><span class="p">:</span> <span class="p">[</span>
            <span class="n">f</span> <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">site_files</span><span class="p">,</span> <span class="n">entities</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;subject&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="p">]</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">files</span>


<span class="k">def</span> <span class="nf">_get_matching_s3_keys</span><span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">anon</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generate all the matching keys in an S3 bucket.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    bucket : str</span>
<span class="sd">        Name of the S3 bucket</span>

<span class="sd">    prefix : str, optional</span>
<span class="sd">        Only fetch keys that start with this prefix</span>

<span class="sd">    suffix : str, optional</span>
<span class="sd">        Only fetch keys that end with this suffix</span>

<span class="sd">    anon : bool</span>
<span class="sd">        Whether to use anonymous connection (public buckets only).</span>
<span class="sd">        If False, uses the key/secret given, or botos credential</span>
<span class="sd">        resolver (client_kwargs, environment, variables, config files,</span>
<span class="sd">        EC2 IAM server, in that order). Default: True</span>

<span class="sd">    Yields</span>
<span class="sd">    ------</span>
<span class="sd">    key : list</span>
<span class="sd">        S3 keys that match the prefix and suffix</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s3</span> <span class="o">=</span> <span class="n">get_s3_client</span><span class="p">(</span><span class="n">anon</span><span class="o">=</span><span class="n">anon</span><span class="p">)</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Bucket&#39;</span><span class="p">:</span> <span class="n">bucket</span><span class="p">,</span> <span class="s1">&#39;MaxKeys&#39;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">}</span>

    <span class="c1"># If the prefix is a single string (not a tuple of strings), we can</span>
    <span class="c1"># do the filtering directly in the S3 API.</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">prefix</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;Prefix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prefix</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="c1"># The S3 API response is a large blob of metadata.</span>
        <span class="c1"># &#39;Contents&#39; contains information about the listed objects.</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">s3</span><span class="o">.</span><span class="n">list_objects_v2</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">contents</span> <span class="o">=</span> <span class="n">resp</span><span class="p">[</span><span class="s1">&#39;Contents&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">contents</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;Key&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="ow">and</span> <span class="n">key</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">suffix</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">key</span>

        <span class="c1"># The S3 API is paginated, returning up to 1000 keys at a time.</span>
        <span class="c1"># Pass the continuation token into the next response, until we</span>
        <span class="c1"># reach the final page (when this field is missing).</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;ContinuationToken&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resp</span><span class="p">[</span><span class="s1">&#39;NextContinuationToken&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">break</span>


<span class="k">def</span> <span class="nf">_download_from_s3</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">anon</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Download object from S3 to local file</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fname : str</span>
<span class="sd">        File path to which to download the object</span>

<span class="sd">    bucket : str</span>
<span class="sd">        S3 bucket name</span>

<span class="sd">    key : str</span>
<span class="sd">        S3 key for the object to download</span>

<span class="sd">    overwrite : bool</span>
<span class="sd">        If True, overwrite file if it already exists.</span>
<span class="sd">        If False, skip download and return. Default: False</span>

<span class="sd">    anon : bool</span>
<span class="sd">        Whether to use anonymous connection (public buckets only).</span>
<span class="sd">        If False, uses the key/secret given, or botos credential</span>
<span class="sd">        resolver (client_kwargs, environment, variables, config files,</span>
<span class="sd">        EC2 IAM server, in that order). Default: True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create the directory and file if necessary</span>
    <span class="n">fs</span> <span class="o">=</span> <span class="n">s3fs</span><span class="o">.</span><span class="n">S3FileSystem</span><span class="p">(</span><span class="n">anon</span><span class="o">=</span><span class="n">anon</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">overwrite</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">op</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
        <span class="n">Path</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">fname</span><span class="p">))</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">fs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="p">]),</span> <span class="n">fname</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">S3BIDSSubject</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;A single study subject hosted on AWS S3&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subject_id</span><span class="p">,</span> <span class="n">study</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize a Subject instance</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        subject_id : str</span>
<span class="sd">            Subject-ID for this subject</span>

<span class="sd">        study : AFQ.data.S3BIDSStudy</span>
<span class="sd">            The S3BIDSStudy for which this subject was a participant</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;botocore&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subject_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;subject_id must be a string.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">study</span><span class="p">,</span> <span class="n">S3BIDSStudy</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;study must be an instance of S3BIDSStudy.&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_subject_id</span> <span class="o">=</span> <span class="n">subject_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_study</span> <span class="o">=</span> <span class="n">study</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_s3_keys</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_files</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;raw&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;derivatives&#39;</span><span class="p">:</span> <span class="p">{}}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">subject_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;An identifier string for the subject&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subject_id</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">study</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The study in which this subject participated&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_study</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">s3_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A dict of S3 keys for this subject&#39;s data</span>

<span class="sd">        The S3 keys are divided between &quot;raw&quot; data and derivatives</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_s3_keys</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Local files for this subject&#39;s dMRI data</span>

<span class="sd">        Before the call to subject.download(), this is None.</span>
<span class="sd">        Afterward, the files are stored in a dict with keys</span>
<span class="sd">        for each Amazon S3 key and values corresponding to</span>
<span class="sd">        the local file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_files</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">(subject_id=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">subject_id</span><span class="si">}</span><span class="s1">, &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;study_id=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">study</span><span class="o">.</span><span class="n">study_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_s3_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get all required S3 keys for this subject</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        s3_keys : dict</span>
<span class="sd">            S3 keys organized into &quot;raw&quot; and &quot;derivatives&quot; lists</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">prefixes</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;raw&#39;</span><span class="p">:</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">study</span><span class="o">.</span><span class="n">s3_prefix</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">subject_id</span><span class="p">])</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">),</span>
            <span class="s1">&#39;derivatives&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="n">dt</span><span class="p">:</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
                    <span class="o">*</span><span class="n">dt</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:],</span>  <span class="c1"># removes bucket name</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">subject_id</span>
                <span class="p">])</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">study</span><span class="o">.</span><span class="n">derivative_types</span>
            <span class="p">},</span>
        <span class="p">}</span>

        <span class="n">s3_keys</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;raw&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">_get_matching_s3_keys</span><span class="p">(</span>
                <span class="n">bucket</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">study</span><span class="o">.</span><span class="n">bucket</span><span class="p">,</span>
                <span class="n">prefix</span><span class="o">=</span><span class="n">prefixes</span><span class="p">[</span><span class="s1">&#39;raw&#39;</span><span class="p">],</span>
                <span class="n">anon</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">study</span><span class="o">.</span><span class="n">anon</span><span class="p">,</span>
            <span class="p">))),</span>
            <span class="s1">&#39;derivatives&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="n">dt</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">_get_matching_s3_keys</span><span class="p">(</span>
                    <span class="n">bucket</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">study</span><span class="o">.</span><span class="n">bucket</span><span class="p">,</span>
                    <span class="n">prefix</span><span class="o">=</span><span class="n">prefixes</span><span class="p">[</span><span class="s1">&#39;derivatives&#39;</span><span class="p">][</span><span class="n">dt</span><span class="p">],</span>
                    <span class="n">anon</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">study</span><span class="o">.</span><span class="n">anon</span><span class="p">,</span>
                <span class="p">)))</span> <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">study</span><span class="o">.</span><span class="n">derivative_types</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_s3_keys</span> <span class="o">=</span> <span class="n">s3_keys</span>

    <span class="k">def</span> <span class="nf">download</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directory</span><span class="p">,</span> <span class="n">include_derivs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">suffix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pbar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">pbar_idx</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Download files from S3</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        directory : str</span>
<span class="sd">            Directory to which to download subject files</span>

<span class="sd">        include_derivs : bool or str</span>
<span class="sd">            If True, download all derivatives files. If False, do not.</span>
<span class="sd">            If a string or sequence of strings is passed, this will</span>
<span class="sd">            only download derivatives that match the string(s) (e.g.</span>
<span class="sd">            [&#39;dmriprep&#39;, &#39;afq&#39;]). Default: False</span>

<span class="sd">        overwrite : bool</span>
<span class="sd">            If True, overwrite files for each subject. Default: False</span>

<span class="sd">        suffix : str</span>
<span class="sd">            Suffix, including extension, of file(s) to download.</span>
<span class="sd">            Default: None</span>

<span class="sd">        pbar : bool</span>
<span class="sd">            If True, include download progress bar. Default: True</span>

<span class="sd">        pbar_idx : int</span>
<span class="sd">            Progress bar index for multithreaded progress bars. Default: 0</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;directory must be a string.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">include_derivs</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span>
                <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">include_derivs</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
                <span class="ow">or</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">include_derivs</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;include_derivs must be a boolean, a &#39;</span>
                            <span class="s1">&#39;string, or a sequence of strings.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">overwrite</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;overwrite must be a boolean.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">suffix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">suffix</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;suffix must be a string.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pbar</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;pbar must be a boolean.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pbar_idx</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;pbar_idx must be an integer.&#39;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">split_key</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">study</span><span class="o">.</span><span class="n">s3_prefix</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">study</span><span class="o">.</span><span class="n">s3_prefix</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">key</span>

        <span class="c1"># Filter out keys that do not end with suffix</span>
        <span class="k">if</span> <span class="n">suffix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">s3_keys_raw</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">s3key</span> <span class="k">for</span> <span class="n">s3key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">s3_keys</span><span class="p">[</span><span class="s1">&#39;raw&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">s3key</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="n">s3_keys_deriv</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">dt</span><span class="p">:</span> <span class="p">[</span>
                    <span class="n">s3key</span> <span class="k">for</span> <span class="n">s3key</span> <span class="ow">in</span> <span class="n">s3keys</span> <span class="k">if</span> <span class="n">s3key</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span>
                <span class="p">]</span> <span class="k">for</span> <span class="n">dt</span><span class="p">,</span> <span class="n">s3keys</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">s3_keys</span><span class="p">[</span><span class="s1">&#39;derivatives&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s3_keys_raw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s3_keys</span><span class="p">[</span><span class="s1">&#39;raw&#39;</span><span class="p">]</span>
            <span class="n">s3_keys_deriv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s3_keys</span><span class="p">[</span><span class="s1">&#39;derivatives&#39;</span><span class="p">]</span>

        <span class="n">files</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;raw&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="n">op</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">directory</span><span class="p">,</span>
                    <span class="n">split_key</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
                <span class="p">))</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">s3_keys_raw</span>
            <span class="p">],</span>
            <span class="s1">&#39;derivatives&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="n">dt</span><span class="p">:</span> <span class="p">[</span>
                    <span class="n">op</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="n">directory</span><span class="p">,</span>
                        <span class="n">split_key</span><span class="p">(</span><span class="n">s3key</span><span class="p">)</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
                    <span class="p">))</span> <span class="k">for</span> <span class="n">s3key</span> <span class="ow">in</span> <span class="n">s3keys</span>
                <span class="p">]</span> <span class="k">for</span> <span class="n">dt</span><span class="p">,</span> <span class="n">s3keys</span> <span class="ow">in</span> <span class="n">s3_keys_deriv</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="n">raw_zip</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">s3_keys_raw</span><span class="p">,</span> <span class="n">files</span><span class="p">[</span><span class="s1">&#39;raw&#39;</span><span class="p">]))</span>

        <span class="c1"># Populate files parameter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">f</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">raw_zip</span><span class="p">})</span>

        <span class="c1"># Generate list of (key, file) tuples</span>
        <span class="n">download_pairs</span> <span class="o">=</span> <span class="p">[(</span><span class="n">k</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">raw_zip</span><span class="p">]</span>

        <span class="n">deriv_zips</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">dt</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span>
                <span class="n">s3keys</span><span class="p">,</span> <span class="n">files</span><span class="p">[</span><span class="s1">&#39;derivatives&#39;</span><span class="p">][</span><span class="n">dt</span><span class="p">]</span>
            <span class="p">))</span> <span class="k">for</span> <span class="n">dt</span><span class="p">,</span> <span class="n">s3keys</span> <span class="ow">in</span> <span class="n">s3_keys_deriv</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="n">deriv_pairs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">files</span><span class="p">[</span><span class="s1">&#39;derivatives&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">include_derivs</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="c1"># In this case, include all derivatives files</span>
                <span class="n">deriv_pairs</span> <span class="o">+=</span> <span class="p">[(</span><span class="n">k</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">deriv_zips</span><span class="p">[</span><span class="n">dt</span><span class="p">]]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">[</span><span class="s1">&#39;derivatives&#39;</span><span class="p">][</span><span class="n">dt</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">k</span><span class="p">:</span> <span class="n">f</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">deriv_zips</span><span class="p">[</span><span class="n">dt</span><span class="p">]</span>
                <span class="p">}</span>
            <span class="k">elif</span> <span class="n">include_derivs</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">include_derivs</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
                  <span class="c1"># In this case, filter only derivatives S3 keys that</span>
                  <span class="c1"># include the `include_derivs` string as a substring</span>
                  <span class="ow">and</span> <span class="n">include_derivs</span> <span class="ow">in</span> <span class="n">dt</span><span class="p">):</span>
                <span class="n">deriv_pairs</span> <span class="o">+=</span> <span class="p">[(</span><span class="n">k</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">deriv_zips</span><span class="p">[</span><span class="n">dt</span><span class="p">]]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">[</span><span class="s1">&#39;derivatives&#39;</span><span class="p">][</span><span class="n">dt</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">k</span><span class="p">:</span> <span class="n">f</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">deriv_zips</span><span class="p">[</span><span class="n">dt</span><span class="p">]</span>
                <span class="p">}</span>
            <span class="k">elif</span> <span class="p">(</span><span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">include_derivs</span><span class="p">)</span>
                  <span class="ow">and</span> <span class="nb">any</span><span class="p">([</span><span class="n">deriv</span> <span class="ow">in</span> <span class="n">dt</span> <span class="k">for</span> <span class="n">deriv</span> <span class="ow">in</span> <span class="n">include_derivs</span><span class="p">])):</span>
                <span class="c1"># In this case, filter only derivatives S3 keys that</span>
                <span class="c1"># include any of the `include_derivs` strings as a</span>
                <span class="c1"># substring</span>
                <span class="n">deriv_pairs</span> <span class="o">+=</span> <span class="p">[(</span><span class="n">k</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">deriv_zips</span><span class="p">[</span><span class="n">dt</span><span class="p">]]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_files</span><span class="p">[</span><span class="s1">&#39;derivatives&#39;</span><span class="p">][</span><span class="n">dt</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">k</span><span class="p">:</span> <span class="n">f</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">deriv_zips</span><span class="p">[</span><span class="n">dt</span><span class="p">]</span>
                <span class="p">}</span>

        <span class="k">if</span> <span class="n">include_derivs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">download_pairs</span> <span class="o">+=</span> <span class="n">deriv_pairs</span>

        <span class="c1"># Now iterate through the list and download each item</span>
        <span class="k">if</span> <span class="n">pbar</span><span class="p">:</span>
            <span class="n">progress</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Download </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">subject_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                            <span class="n">position</span><span class="o">=</span><span class="n">pbar_idx</span><span class="p">,</span>
                            <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">download_pairs</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span> <span class="ow">in</span> <span class="n">download_pairs</span><span class="p">:</span>
            <span class="n">_download_from_s3</span><span class="p">(</span><span class="n">fname</span><span class="o">=</span><span class="n">fname</span><span class="p">,</span>
                              <span class="n">bucket</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">study</span><span class="o">.</span><span class="n">bucket</span><span class="p">,</span>
                              <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span>
                              <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">,</span>
                              <span class="n">anon</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">study</span><span class="o">.</span><span class="n">anon</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">pbar</span><span class="p">:</span>
                <span class="n">progress</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">pbar</span><span class="p">:</span>
            <span class="n">progress</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
            <span class="n">progress</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">HBNSubject</span><span class="p">(</span><span class="n">S3BIDSSubject</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A subject in the HBN study</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    AFQ.data.S3BIDSSubject</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subject_id</span><span class="p">,</span> <span class="n">study</span><span class="p">,</span> <span class="n">site</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize a Subject instance</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        subject_id : str</span>
<span class="sd">            Subject-ID for this subject</span>

<span class="sd">        study : AFQ.data.S3BIDSStudy</span>
<span class="sd">            The S3BIDSStudy for which this subject was a participant</span>

<span class="sd">        site : str, optional</span>
<span class="sd">            Site-ID for the site from which this subject&#39;s data was collected</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">site</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">site</span><span class="p">,</span> <span class="nb">str</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;site must be a string or None.&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_site</span> <span class="o">=</span> <span class="n">site</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">subject_id</span><span class="o">=</span><span class="n">subject_id</span><span class="p">,</span>
            <span class="n">study</span><span class="o">=</span><span class="n">study</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">site</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The site at which this subject was a participant&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_site</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">(subject_id=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">subject_id</span><span class="si">}</span><span class="s1">, &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;study_id=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">study</span><span class="o">.</span><span class="n">study_id</span><span class="si">}</span><span class="s1">, site=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_s3_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get all required S3 keys for this subject</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        s3_keys : dict</span>
<span class="sd">            S3 keys organized into &quot;raw&quot; and &quot;derivatives&quot; lists</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">prefixes</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;raw&#39;</span><span class="p">:</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">study</span><span class="o">.</span><span class="n">s3_prefix</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">subject_id</span><span class="p">])</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">),</span>
            <span class="s1">&#39;derivatives&#39;</span><span class="p">:</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">study</span><span class="o">.</span><span class="n">s3_prefix</span><span class="p">,</span>
                <span class="s1">&#39;derivatives&#39;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">subject_id</span>
            <span class="p">])</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="n">s3_keys</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">datatype</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">_get_matching_s3_keys</span><span class="p">(</span>
                <span class="n">bucket</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">study</span><span class="o">.</span><span class="n">bucket</span><span class="p">,</span>
                <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">,</span>
                <span class="n">anon</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">study</span><span class="o">.</span><span class="n">anon</span><span class="p">,</span>
            <span class="p">)))</span> <span class="k">for</span> <span class="n">datatype</span><span class="p">,</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="n">prefixes</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="k">def</span> <span class="nf">get_deriv_type</span><span class="p">(</span><span class="n">s3_key</span><span class="p">):</span>
            <span class="n">after_sub</span> <span class="o">=</span> <span class="n">s3_key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">subject_id</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">deriv_type</span> <span class="o">=</span> <span class="n">after_sub</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">deriv_keys</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">dt</span><span class="p">:</span> <span class="p">[</span>
                <span class="n">s3key</span> <span class="k">for</span> <span class="n">s3key</span> <span class="ow">in</span> <span class="n">s3_keys</span><span class="p">[</span><span class="s1">&#39;derivatives&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">dt</span> <span class="o">==</span> <span class="n">get_deriv_type</span><span class="p">(</span><span class="n">s3key</span><span class="p">)</span>
            <span class="p">]</span> <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">study</span><span class="o">.</span><span class="n">derivative_types</span>
        <span class="p">}</span>

        <span class="n">s3_keys</span><span class="p">[</span><span class="s1">&#39;derivatives&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">deriv_keys</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_s3_keys</span> <span class="o">=</span> <span class="n">s3_keys</span>


<span class="k">class</span> <span class="nc">S3BIDSStudy</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;A BIDS-compliant study hosted on AWS S3&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">study_id</span><span class="p">,</span> <span class="n">bucket</span><span class="p">,</span> <span class="n">s3_prefix</span><span class="p">,</span> <span class="n">subjects</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">anon</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">use_participants_tsv</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">random_seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">_subject_class</span><span class="o">=</span><span class="n">S3BIDSSubject</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize an S3BIDSStudy instance</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        study_id : str</span>
<span class="sd">            An identifier string for the study</span>

<span class="sd">        bucket : str</span>
<span class="sd">            The S3 bucket that contains the study data</span>

<span class="sd">        s3_prefix : str</span>
<span class="sd">            The S3 prefix common to all of the study objects on S3</span>

<span class="sd">        subjects : str, sequence(str), int, or None</span>
<span class="sd">            If int, retrieve S3 keys for the first `subjects` subjects.</span>
<span class="sd">            If &quot;all&quot;, retrieve all subjects. If str or sequence of</span>
<span class="sd">            strings, retrieve S3 keys for the specified subjects. If sequence</span>
<span class="sd">            of ints, then for each int n retrieve S3 keys for the nth subject.</span>
<span class="sd">            If None, retrieve S3 keys for the first subject. Default: None</span>

<span class="sd">        anon : bool</span>
<span class="sd">            Whether to use anonymous connection (public buckets only).</span>
<span class="sd">            If False, uses the key/secret given, or botos credential</span>
<span class="sd">            resolver (client_kwargs, environment, variables, config</span>
<span class="sd">            files, EC2 IAM server, in that order). Default: True</span>

<span class="sd">        use_participants_tsv : bool</span>
<span class="sd">            If True, use the particpants tsv files to retrieve subject</span>
<span class="sd">            identifiers. This is faster but may not catch all subjects.</span>
<span class="sd">            Sometimes the tsv files are outdated. Default: False</span>

<span class="sd">        random_seed : int or None</span>
<span class="sd">            Random seed for selection of subjects if `subjects` is an</span>
<span class="sd">            integer. Use the same random seed for reproducibility.</span>
<span class="sd">            Default: None</span>

<span class="sd">        _subject_class : object</span>
<span class="sd">            The subject class to be used for this study. This parameter</span>
<span class="sd">            has a leading underscore because you probably don&#39;t want</span>
<span class="sd">            to change it. If you do change it, you must provide a</span>
<span class="sd">            class that quacks like AFQ.data.S3BIDSSubject. Default:</span>
<span class="sd">            S3BIDSSubject</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;botocore&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">study_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;`study_id` must be a string.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;`bucket` must be a string.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s3_prefix</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;`s3_prefix` must be a string.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">subjects</span> <span class="ow">is</span> <span class="kc">None</span>
                <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subjects</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
                <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subjects</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
                <span class="ow">or</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">subjects</span><span class="p">)</span>
                <span class="ow">or</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">subjects</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;`subjects` must be an int, string, &#39;</span>
                            <span class="s1">&#39;sequence of strings, or a sequence of ints.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">anon</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;`anon` must be of type bool.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subjects</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">subjects</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;If `subjects` is an int, it must be &#39;</span>
                             <span class="s1">&#39;greater than 0.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">use_participants_tsv</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;`use_participants_tsv` must be boolean.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">random_seed</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">random_seed</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;`random_seed` must be an integer.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_study_id</span> <span class="o">=</span> <span class="n">study_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bucket</span> <span class="o">=</span> <span class="n">bucket</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_s3_prefix</span> <span class="o">=</span> <span class="n">s3_prefix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_use_participants_tsv</span> <span class="o">=</span> <span class="n">use_participants_tsv</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_random_seed</span> <span class="o">=</span> <span class="n">random_seed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_anon</span> <span class="o">=</span> <span class="n">anon</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_subject_class</span> <span class="o">=</span> <span class="n">_subject_class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_local_directories</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Get a list of all subjects in the study</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_all_subjects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_list_all_subjects</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_derivative_types</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_derivative_types</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_non_subject_s3_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_non_subject_s3_keys</span><span class="p">()</span>

        <span class="c1"># Convert `subjects` into a sequence of subjectID strings</span>
        <span class="k">if</span> <span class="n">subjects</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subjects</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> \
                <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">subjects</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subjects</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">int</span><span class="p">)):</span>
            <span class="c1"># if subjects is an int, get that many random subjects</span>
            <span class="n">prng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="n">random_seed</span><span class="p">)</span>
            <span class="n">randomized_subjects</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_all_subjects</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
            <span class="n">prng</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">randomized_subjects</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">subjects</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">subjects</span> <span class="o">=</span> <span class="n">randomized_subjects</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subjects</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="n">subjects</span> <span class="o">=</span> <span class="n">randomized_subjects</span><span class="p">[:</span><span class="n">subjects</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">subjects</span> <span class="o">=</span> <span class="p">[</span><span class="n">randomized_subjects</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">subjects</span><span class="p">]</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subjects</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">subjects</span> <span class="o">=</span> <span class="p">[</span><span class="n">subjects</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">subjects</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="c1"># if &quot;all,&quot; retrieve all subjects</span>
            <span class="n">subjects</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_all_subjects</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subjects</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="c1"># if a string, just get that one subject</span>
            <span class="n">subjects</span> <span class="o">=</span> <span class="p">[</span><span class="n">subjects</span><span class="p">]</span>
        <span class="c1"># The last case for subjects is what we want. No transformation needed.</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">set</span><span class="p">(</span><span class="n">subjects</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_all_subjects</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;The following subjects could not be found in the study: &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">set</span><span class="p">(</span><span class="n">subjects</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_all_subjects</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="p">)</span>

        <span class="n">subs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">delayed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_subject</span><span class="p">)(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">subjects</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Retrieving subject S3 keys&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">ProgressBar</span><span class="p">():</span>
            <span class="n">subjects</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">compute</span><span class="p">(</span><span class="o">*</span><span class="n">subs</span><span class="p">,</span> <span class="n">scheduler</span><span class="o">=</span><span class="s1">&#39;threads&#39;</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_subjects</span> <span class="o">=</span> <span class="n">subjects</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">study_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;An identifier string for the study&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_study_id</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">bucket</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The S3 bucket that contains the study data&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bucket</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">s3_prefix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The S3 prefix common to all of the study objects on S3&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_s3_prefix</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">subjects</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A list of Subject instances for each requested subject&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subjects</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">anon</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Is this study using an anonymous S3 connection?&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_anon</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">derivative_types</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A list of derivative pipelines available in this study&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_derivative_types</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">non_sub_s3_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A dict of S3 keys that are not in subject directories&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_non_subject_s3_keys</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">local_directories</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A list of local directories to which this study has been downloaded&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_local_directories</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">use_participants_tsv</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Did we use a participants.tsv file to populate the list of</span>
<span class="sd">        study subjects.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_participants_tsv</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">random_seed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The random seed used to retrieve study subjects&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_random_seed</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">(study_id=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">study_id</span><span class="si">}</span><span class="s1">, &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;bucket=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bucket</span><span class="si">}</span><span class="s1">, s3_prefix=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">s3_prefix</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_subject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subject_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a Subject instance from a subject-ID&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subject_class</span><span class="p">(</span><span class="n">subject_id</span><span class="o">=</span><span class="n">subject_id</span><span class="p">,</span>
                                   <span class="n">study</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_derivative_types</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of available derivatives pipelines</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            list of available derivatives pipelines</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s3_prefix</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">bucket</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">s3_prefix</span><span class="p">])</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="n">nonsub_keys</span> <span class="o">=</span> <span class="n">_ls_s3fs</span><span class="p">(</span><span class="n">s3_prefix</span><span class="o">=</span><span class="n">s3_prefix</span><span class="p">,</span>
                               <span class="n">anon</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">anon</span><span class="p">)[</span><span class="s1">&#39;other&#39;</span><span class="p">]</span>
        <span class="n">derivatives_prefix</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">s3_prefix</span><span class="p">,</span> <span class="s1">&#39;derivatives&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">derivatives_prefix</span> <span class="ow">in</span> <span class="n">nonsub_keys</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_ls_s3fs</span><span class="p">(</span>
                <span class="n">s3_prefix</span><span class="o">=</span><span class="n">derivatives_prefix</span><span class="p">,</span>
                <span class="n">anon</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">anon</span>
            <span class="p">)[</span><span class="s1">&#39;other&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">_get_non_subject_s3_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of &#39;non-subject&#39; files</span>

<span class="sd">        In this context, a &#39;non-subject&#39; file is any file</span>
<span class="sd">        or directory that is not a subject ID folder</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            dict with keys &#39;raw&#39; and &#39;derivatives&#39; and whose values</span>
<span class="sd">            are lists of S3 keys for non-subject files</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">non_sub_s3_keys</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">s3_prefix</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">bucket</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">s3_prefix</span><span class="p">])</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>

        <span class="n">nonsub_keys</span> <span class="o">=</span> <span class="n">_ls_s3fs</span><span class="p">(</span><span class="n">s3_prefix</span><span class="o">=</span><span class="n">s3_prefix</span><span class="p">,</span>
                               <span class="n">anon</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">anon</span><span class="p">)[</span><span class="s1">&#39;other&#39;</span><span class="p">]</span>
        <span class="n">nonsub_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">nonsub_keys</span>
                       <span class="k">if</span> <span class="ow">not</span> <span class="n">k</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;derivatives&#39;</span><span class="p">)]</span>

        <span class="n">nonsub_deriv_keys</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">derivative_types</span><span class="p">:</span>
            <span class="n">nonsub_deriv_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_ls_s3fs</span><span class="p">(</span>
                <span class="n">s3_prefix</span><span class="o">=</span><span class="n">dt</span><span class="p">,</span>
                <span class="n">anon</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">anon</span>
            <span class="p">)[</span><span class="s1">&#39;other&#39;</span><span class="p">])</span>

        <span class="n">non_sub_s3_keys</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;raw&#39;</span><span class="p">:</span> <span class="n">nonsub_keys</span><span class="p">,</span>
            <span class="s1">&#39;derivatives&#39;</span><span class="p">:</span> <span class="n">nonsub_deriv_keys</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">non_sub_s3_keys</span>

    <span class="k">def</span> <span class="nf">_list_all_subjects</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return list of subjects</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            list of participant_ids</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_participants_tsv</span><span class="p">:</span>
            <span class="n">tsv_key</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">s3_prefix</span><span class="p">,</span>
                                <span class="s2">&quot;participants.tsv&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
            <span class="n">s3</span> <span class="o">=</span> <span class="n">get_s3_client</span><span class="p">(</span><span class="n">anon</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">anon</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">get_subs_from_tsv_key</span><span class="p">(</span><span class="n">s3_key</span><span class="p">):</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">s3</span><span class="o">.</span><span class="n">get_object</span><span class="p">(</span>
                    <span class="n">Bucket</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bucket</span><span class="p">,</span>
                    <span class="n">Key</span><span class="o">=</span><span class="n">s3_key</span>
                <span class="p">)</span>

                <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
                    <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Body&#39;</span><span class="p">)</span>
                <span class="p">)</span><span class="o">.</span><span class="n">participant_id</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

            <span class="n">subject_set</span> <span class="o">=</span> <span class="n">get_subs_from_tsv_key</span><span class="p">(</span><span class="n">tsv_key</span><span class="p">)</span>
            <span class="n">subjects</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">subject_set</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s3_prefix</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">bucket</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">s3_prefix</span><span class="p">])</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
            <span class="n">sub_keys</span> <span class="o">=</span> <span class="n">_ls_s3fs</span><span class="p">(</span><span class="n">s3_prefix</span><span class="o">=</span><span class="n">s3_prefix</span><span class="p">,</span>
                                <span class="n">anon</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">anon</span><span class="p">)[</span><span class="s1">&#39;subjects&#39;</span><span class="p">]</span>

            <span class="c1"># Just need BIDSLayout for the `parse_file_entities`</span>
            <span class="c1"># method so we can pass dev/null as the argument</span>
            <span class="n">layout</span> <span class="o">=</span> <span class="n">BIDSLayout</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">devnull</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">subjects</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">sub_keys</span><span class="p">:</span>
                <span class="n">entities</span> <span class="o">=</span> <span class="n">layout</span><span class="o">.</span><span class="n">parse_file_entities</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="n">subjects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;sub-&#39;</span> <span class="o">+</span> <span class="n">entities</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;subject&#39;</span><span class="p">))</span>

        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">subjects</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_download_non_sub_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directory</span><span class="p">,</span>
                               <span class="n">select</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;dataset_description.json&quot;</span><span class="p">,),</span>
                               <span class="n">filenames</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="n">s3fs</span><span class="o">.</span><span class="n">S3FileSystem</span><span class="p">(</span><span class="n">anon</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">anon</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">filenames</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filenames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_sub_s3_keys</span><span class="p">[</span><span class="s1">&#39;raw&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">select</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">([</span><span class="n">s</span> <span class="ow">in</span> <span class="n">fn</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">select</span><span class="p">]):</span>
                <span class="n">Path</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">fs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">fn</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">_download_derivative_descriptions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">include_derivs</span><span class="p">,</span> <span class="n">directory</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">derivative</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">derivative_types</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">include_derivs</span> <span class="ow">is</span> <span class="kc">True</span> \
                <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">include_derivs</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="n">include_derivs</span> <span class="o">==</span> <span class="n">op</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">derivative</span><span class="p">))</span> \
                <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">include_derivs</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">include_derivs</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="nb">any</span><span class="p">([</span><span class="n">deriv</span> <span class="ow">in</span> <span class="n">derivative</span> <span class="k">for</span>
                             <span class="n">deriv</span> <span class="ow">in</span> <span class="n">include_derivs</span><span class="p">])):</span>
                <span class="n">filenames</span> <span class="o">=</span> \
                    <span class="n">_ls_s3fs</span><span class="p">(</span><span class="n">s3_prefix</span><span class="o">=</span><span class="n">derivative</span><span class="p">,</span> <span class="n">anon</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">anon</span><span class="p">)[</span><span class="s1">&#39;other&#39;</span><span class="p">]</span>
                <span class="n">deriv_directory</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">directory</span><span class="p">,</span> <span class="o">*</span><span class="n">derivative</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">:])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_download_non_sub_keys</span><span class="p">(</span>
                    <span class="n">deriv_directory</span><span class="p">,</span>
                    <span class="n">select</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;dataset_description.json&quot;</span><span class="p">,),</span>
                    <span class="n">filenames</span><span class="o">=</span><span class="n">filenames</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">download</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directory</span><span class="p">,</span>
                 <span class="n">include_modality_agnostic</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;dataset_description.json&quot;</span><span class="p">,),</span>
                 <span class="n">include_derivs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">include_derivs_dataset_description</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">suffix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">pbar</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Download files for each subject in the study</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        directory : str</span>
<span class="sd">            Directory to which to download subject files</span>

<span class="sd">        include_modality_agnostic : bool, &quot;all&quot; or any subset of [&quot;dataset_description.json&quot;, &quot;CHANGES&quot;, &quot;README&quot;, &quot;LICENSE&quot;]</span>
<span class="sd">            If True or &quot;all&quot;, download all keys in self.non_sub_s3_keys</span>
<span class="sd">            also. If a subset of [&quot;dataset_description.json&quot;, &quot;CHANGES&quot;,</span>
<span class="sd">            &quot;README&quot;, &quot;LICENSE&quot;], download only those files. This is</span>
<span class="sd">            useful if the non_sub_s3_keys contain files common to all</span>
<span class="sd">            subjects that should be inherited. Default: (&quot;dataset_description.json&quot;,)</span>

<span class="sd">        include_derivs : bool or str</span>
<span class="sd">            If True, download all derivatives files. If False, do not.</span>
<span class="sd">            If a string or sequence of strings is passed, this will</span>
<span class="sd">            only download derivatives that match the string(s) (e.g.</span>
<span class="sd">            [&quot;dmriprep&quot;, &quot;afq&quot;]). Default: False</span>

<span class="sd">        include_derivs_dataset_description : bool</span>
<span class="sd">            Used only if include_derivs is not False. If True,</span>
<span class="sd">            dataset_description.json downloaded for each derivative.</span>

<span class="sd">        suffix : str</span>
<span class="sd">            Suffix, including extension, of file(s) to download.</span>
<span class="sd">            Default: None</span>

<span class="sd">        overwrite : bool</span>
<span class="sd">            If True, overwrite files for each subject. Default: False</span>

<span class="sd">        pbar : bool</span>
<span class="sd">            If True, include progress bar. Default: True</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        AFQ.data.S3BIDSSubject.download</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_local_directories</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_local_directories</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_local_directories</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">include_modality_agnostic</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">or</span> <span class="n">include_modality_agnostic</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_download_non_sub_keys</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">select</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">include_modality_agnostic</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
            <span class="c1"># Subset selection</span>
            <span class="n">valid_set</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;dataset_description.json&quot;</span><span class="p">,</span>
                         <span class="s2">&quot;CHANGES&quot;</span><span class="p">,</span>
                         <span class="s2">&quot;README&quot;</span><span class="p">,</span>
                         <span class="s2">&quot;LICENSE&quot;</span><span class="p">}</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">set</span><span class="p">(</span><span class="n">include_modality_agnostic</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">valid_set</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;include_modality_agnostic must be either a boolean, &#39;all&#39;, &quot;</span>
                    <span class="s2">&quot;or a subset of </span><span class="si">{valid_set}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">valid_set</span><span class="o">=</span><span class="n">valid_set</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_download_non_sub_keys</span><span class="p">(</span>
                <span class="n">directory</span><span class="p">,</span> <span class="n">select</span><span class="o">=</span><span class="n">include_modality_agnostic</span><span class="p">)</span>

        <span class="c1"># download dataset_description.json for derivatives</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">include_derivs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">)</span> \
                <span class="ow">and</span> <span class="n">include_derivs_dataset_description</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_download_derivative_descriptions</span><span class="p">(</span>
                <span class="n">include_derivs</span><span class="p">,</span> <span class="n">directory</span><span class="p">)</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">delayed</span><span class="p">(</span><span class="n">sub</span><span class="o">.</span><span class="n">download</span><span class="p">)(</span>
            <span class="n">directory</span><span class="o">=</span><span class="n">directory</span><span class="p">,</span>
            <span class="n">include_derivs</span><span class="o">=</span><span class="n">include_derivs</span><span class="p">,</span>
            <span class="n">suffix</span><span class="o">=</span><span class="n">suffix</span><span class="p">,</span>
            <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">,</span>
            <span class="n">pbar</span><span class="o">=</span><span class="n">pbar</span><span class="p">,</span>
            <span class="n">pbar_idx</span><span class="o">=</span><span class="n">idx</span><span class="p">,</span>
        <span class="p">)</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">sub</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subjects</span><span class="p">)]</span>

        <span class="n">compute</span><span class="p">(</span><span class="o">*</span><span class="n">results</span><span class="p">,</span> <span class="n">scheduler</span><span class="o">=</span><span class="s1">&#39;threads&#39;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">HBNSite</span><span class="p">(</span><span class="n">S3BIDSStudy</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An HBN study site</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    AFQ.data.S3BIDSStudy</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">site</span><span class="p">,</span> <span class="n">study_id</span><span class="o">=</span><span class="s1">&#39;HBN&#39;</span><span class="p">,</span> <span class="n">bucket</span><span class="o">=</span><span class="s1">&#39;fcp-indi&#39;</span><span class="p">,</span>
                 <span class="n">s3_prefix</span><span class="o">=</span><span class="s1">&#39;data/Projects/HBN/MRI&#39;</span><span class="p">,</span>
                 <span class="n">subjects</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_participants_tsv</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">random_seed</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize the HBN site</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        site : [&quot;Site-SI&quot;, &quot;Site-RU&quot;, &quot;Site-CBIC&quot;, &quot;Site-CUNY&quot;]</span>
<span class="sd">            The HBN site</span>

<span class="sd">        study_id : str</span>
<span class="sd">            An identifier string for the site</span>

<span class="sd">        bucket : str</span>
<span class="sd">            The S3 bucket that contains the study data</span>

<span class="sd">        s3_prefix : str</span>
<span class="sd">            The S3 prefix common to all of the study objects on S3</span>

<span class="sd">        subjects : str, sequence(str), int, or None</span>
<span class="sd">            If int, retrieve S3 keys for the first `subjects` subjects.</span>
<span class="sd">            If &quot;all&quot;, retrieve all subjects. If str or sequence of</span>
<span class="sd">            strings, retrieve S3 keys for the specified subjects. If</span>
<span class="sd">            None, retrieve S3 keys for the first subject. Default: None</span>

<span class="sd">        use_participants_tsv : bool</span>
<span class="sd">            If True, use the particpants tsv files to retrieve subject</span>
<span class="sd">            identifiers. This is faster but may not catch all subjects.</span>
<span class="sd">            Sometimes the tsv files are outdated. Default: False</span>

<span class="sd">        random_seed : int or None</span>
<span class="sd">            Random seed for selection of subjects if `subjects` is an</span>
<span class="sd">            integer. Use the same random seed for reproducibility.</span>
<span class="sd">            Default: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">valid_sites</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Site-SI&quot;</span><span class="p">,</span> <span class="s2">&quot;Site-RU&quot;</span><span class="p">,</span> <span class="s2">&quot;Site-CBIC&quot;</span><span class="p">,</span> <span class="s2">&quot;Site-CUNY&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">site</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_sites</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;site must be one of </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">valid_sites</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_site</span> <span class="o">=</span> <span class="n">site</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">study_id</span><span class="o">=</span><span class="n">study_id</span><span class="p">,</span>
            <span class="n">bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span>
            <span class="n">s3_prefix</span><span class="o">=</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">s3_prefix</span><span class="p">,</span> <span class="n">site</span><span class="p">]),</span>
            <span class="n">subjects</span><span class="o">=</span><span class="n">subjects</span><span class="p">,</span>
            <span class="n">use_participants_tsv</span><span class="o">=</span><span class="n">use_participants_tsv</span><span class="p">,</span>
            <span class="n">random_seed</span><span class="o">=</span><span class="n">random_seed</span><span class="p">,</span>
            <span class="n">_subject_class</span><span class="o">=</span><span class="n">HBNSubject</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">site</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The HBN site&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_site</span>

    <span class="k">def</span> <span class="nf">_get_subject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subject_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a Subject instance from a subject-ID&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subject_class</span><span class="p">(</span><span class="n">subject_id</span><span class="o">=</span><span class="n">subject_id</span><span class="p">,</span>
                                   <span class="n">study</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                                   <span class="n">site</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_derivative_types</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of available derivatives pipelines</span>

<span class="sd">        The HBN dataset is not BIDS compliant so to go a list</span>
<span class="sd">        of available derivatives, we must peak inside every</span>
<span class="sd">        directory in `derivatives/sub-XXXX/`</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            list of available derivatives pipelines</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s3_prefix</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">bucket</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">s3_prefix</span><span class="p">])</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="n">nonsub_keys</span> <span class="o">=</span> <span class="n">_ls_s3fs</span><span class="p">(</span><span class="n">s3_prefix</span><span class="o">=</span><span class="n">s3_prefix</span><span class="p">,</span>
                               <span class="n">anon</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">anon</span><span class="p">)[</span><span class="s1">&#39;other&#39;</span><span class="p">]</span>
        <span class="n">derivatives_prefix</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">s3_prefix</span><span class="p">,</span> <span class="s1">&#39;derivatives&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">derivatives_prefix</span> <span class="ow">in</span> <span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">nonsub_keys</span><span class="p">]):</span>
            <span class="n">deriv_subs</span> <span class="o">=</span> <span class="n">_ls_s3fs</span><span class="p">(</span>
                <span class="n">s3_prefix</span><span class="o">=</span><span class="n">derivatives_prefix</span><span class="p">,</span>
                <span class="n">anon</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">anon</span>
            <span class="p">)[</span><span class="s1">&#39;subjects&#39;</span><span class="p">]</span>

            <span class="n">deriv_types</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">sub_key</span> <span class="ow">in</span> <span class="n">deriv_subs</span><span class="p">:</span>
                <span class="n">deriv_types</span> <span class="o">+=</span> <span class="p">[</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sub_key</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">_ls_s3fs</span><span class="p">(</span>
                        <span class="n">s3_prefix</span><span class="o">=</span><span class="n">sub_key</span><span class="p">,</span>
                        <span class="n">anon</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">anon</span>
                    <span class="p">)[</span><span class="s1">&#39;subjects&#39;</span><span class="p">]</span>
                <span class="p">]</span>

            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">deriv_types</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">_get_non_subject_s3_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of &#39;non-subject&#39; files</span>

<span class="sd">        In this context, a &#39;non-subject&#39; file is any file</span>
<span class="sd">        or directory that is not a subject ID folder. This method</span>
<span class="sd">        is different from AFQ.data.S3BIDSStudy because the HBN</span>
<span class="sd">        dataset is not BIDS compliant</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            dict with keys &#39;raw&#39; and &#39;derivatives&#39; and whose values</span>
<span class="sd">            are lists of S3 keys for non-subject files</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        AFQ.data.S3BIDSStudy._get_non_subject_s3_keys</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">non_sub_s3_keys</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">s3_prefix</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">bucket</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">s3_prefix</span><span class="p">])</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>

        <span class="n">nonsub_keys</span> <span class="o">=</span> <span class="n">_ls_s3fs</span><span class="p">(</span><span class="n">s3_prefix</span><span class="o">=</span><span class="n">s3_prefix</span><span class="p">,</span>
                               <span class="n">anon</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">anon</span><span class="p">)[</span><span class="s1">&#39;other&#39;</span><span class="p">]</span>
        <span class="n">nonsub_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">nonsub_keys</span>
                       <span class="k">if</span> <span class="ow">not</span> <span class="n">k</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;derivatives&#39;</span><span class="p">)]</span>

        <span class="n">nonsub_deriv_keys</span> <span class="o">=</span> <span class="n">_ls_s3fs</span><span class="p">(</span>
            <span class="n">s3_prefix</span><span class="o">=</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bucket</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">s3_prefix</span><span class="p">,</span>
                <span class="s1">&#39;derivatives&#39;</span>
            <span class="p">]),</span>
            <span class="n">anon</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">anon</span>
        <span class="p">)[</span><span class="s1">&#39;other&#39;</span><span class="p">]</span>

        <span class="n">non_sub_s3_keys</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;raw&#39;</span><span class="p">:</span> <span class="n">nonsub_keys</span><span class="p">,</span>
            <span class="s1">&#39;derivatives&#39;</span><span class="p">:</span> <span class="n">nonsub_deriv_keys</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">non_sub_s3_keys</span>

    <span class="k">def</span> <span class="nf">download</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directory</span><span class="p">,</span> <span class="n">include_modality_agnostic</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">include_derivs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">pbar</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Download files for each subject in the study</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        directory : str</span>
<span class="sd">            Directory to which to download subject files</span>

<span class="sd">        include_modality_agnostic : bool, &quot;all&quot; or any subset of [&quot;dataset_description.json&quot;, &quot;CHANGES&quot;, &quot;README&quot;, &quot;LICENSE&quot;]</span>
<span class="sd">            If True or &quot;all&quot;, download all keys in self.non_sub_s3_keys</span>
<span class="sd">            also. If a subset of [&quot;dataset_description.json&quot;, &quot;CHANGES&quot;,</span>
<span class="sd">            &quot;README&quot;, &quot;LICENSE&quot;], download only those files. This is</span>
<span class="sd">            useful if the non_sub_s3_keys contain files common to all</span>
<span class="sd">            subjects that should be inherited. Default: False</span>

<span class="sd">        include_derivs : bool or str</span>
<span class="sd">            If True, download all derivatives files. If False, do not.</span>
<span class="sd">            If a string or sequence of strings is passed, this will</span>
<span class="sd">            only download derivatives that match the string(s) (e.g.</span>
<span class="sd">            [&quot;dmriprep&quot;, &quot;afq&quot;]). Default: False</span>

<span class="sd">        overwrite : bool</span>
<span class="sd">            If True, overwrite files for each subject. Default: False</span>

<span class="sd">        pbar : bool</span>
<span class="sd">            If True, include progress bar. Default: True</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        AFQ.data.S3BIDSSubject.download</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">download</span><span class="p">(</span>
            <span class="n">directory</span><span class="o">=</span><span class="n">directory</span><span class="p">,</span>
            <span class="n">include_modality_agnostic</span><span class="o">=</span><span class="n">include_modality_agnostic</span><span class="p">,</span>
            <span class="n">include_derivs</span><span class="o">=</span><span class="n">include_derivs</span><span class="p">,</span>
            <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">,</span>
            <span class="n">pbar</span><span class="o">=</span><span class="n">pbar</span>
        <span class="p">)</span>

        <span class="n">to_bids_description</span><span class="p">(</span>
            <span class="n">directory</span><span class="p">,</span>
            <span class="o">**</span><span class="p">{</span><span class="s2">&quot;BIDSVersion&quot;</span><span class="p">:</span> <span class="s2">&quot;1.0.0&quot;</span><span class="p">,</span>
               <span class="s2">&quot;Name&quot;</span><span class="p">:</span> <span class="s2">&quot;HBN Study, &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="p">,</span>
               <span class="s2">&quot;DatasetType&quot;</span><span class="p">:</span> <span class="s2">&quot;raw&quot;</span><span class="p">,</span>
               <span class="s2">&quot;Subjects&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">subject_id</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subjects</span><span class="p">]})</span>


<span class="c1"># +--------------------------------------------------+</span>
<span class="c1"># | End S3BIDSStudy classes and supporting functions |</span>
<span class="c1"># +--------------------------------------------------+</span>


<div class="viewcode-block" id="fetch_hcp"><a class="viewcode-back" href="../../autoapi/AFQ/index.html#AFQ.data.fetch_hcp">[docs]</a><span class="k">def</span> <span class="nf">fetch_hcp</span><span class="p">(</span><span class="n">subjects</span><span class="p">,</span>
              <span class="n">hcp_bucket</span><span class="o">=</span><span class="s1">&#39;hcp-openaccess&#39;</span><span class="p">,</span>
              <span class="n">profile_name</span><span class="o">=</span><span class="s2">&quot;hcp&quot;</span><span class="p">,</span>
              <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">study</span><span class="o">=</span><span class="s1">&#39;HCP_1200&#39;</span><span class="p">,</span>
              <span class="n">aws_access_key_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">aws_secret_access_key</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fetch HCP diffusion data and arrange it in a manner that resembles the</span>
<span class="sd">    BIDS [1]_ specification.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    subjects : list</span>
<span class="sd">        Each item is an integer, identifying one of the HCP subjects</span>
<span class="sd">    hcp_bucket : string, optional</span>
<span class="sd">        The name of the HCP S3 bucket. Default: &quot;hcp-openaccess&quot;</span>
<span class="sd">    profile_name : string, optional</span>
<span class="sd">        The name of the AWS profile used for access. Default: &quot;hcp&quot;</span>
<span class="sd">    path : string, optional</span>
<span class="sd">        Path to save files into. Default: &#39;~/AFQ_data&#39;</span>
<span class="sd">    study : string, optional</span>
<span class="sd">        Which HCP study to grab. Default: &#39;HCP_1200&#39;</span>
<span class="sd">    aws_access_key_id : string, optional</span>
<span class="sd">        AWS credentials to HCP AWS S3. Will only be used if `profile_name` is</span>
<span class="sd">        set to False.</span>
<span class="sd">    aws_secret_access_key : string, optional</span>
<span class="sd">        AWS credentials to HCP AWS S3. Will only be used if `profile_name` is</span>
<span class="sd">        set to False.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict with remote and local names of these files,</span>
<span class="sd">    path to BIDS derivative dataset</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    To use this function with its default setting, you need to have a</span>
<span class="sd">    file &#39;~/.aws/credentials&#39;, that includes a section:</span>

<span class="sd">    [hcp]</span>
<span class="sd">    AWS_ACCESS_KEY_ID=XXXXXXXXXXXXXXXX</span>
<span class="sd">    AWS_SECRET_ACCESS_KEY=XXXXXXXXXXXXXXXX</span>

<span class="sd">    The keys are credentials that you can get from HCP</span>
<span class="sd">    (see https://wiki.humanconnectome.org/display/PublicData/How+To+Connect+to+Connectome+Data+via+AWS)  # noqa</span>

<span class="sd">    Local filenames are changed to match our expected conventions.</span>

<span class="sd">    .. [1] Gorgolewski et al. (2016). The brain imaging data structure,</span>
<span class="sd">           a format for organizing and describing outputs of neuroimaging</span>
<span class="sd">           experiments. Scientific Data, 3::160044. DOI: 10.1038/sdata.2016.44.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">profile_name</span><span class="p">:</span>
        <span class="n">boto3</span><span class="o">.</span><span class="n">setup_default_session</span><span class="p">(</span><span class="n">profile_name</span><span class="o">=</span><span class="n">profile_name</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">aws_access_key_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">aws_secret_access_key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">boto3</span><span class="o">.</span><span class="n">setup_default_session</span><span class="p">(</span>
            <span class="n">aws_access_key_id</span><span class="o">=</span><span class="n">aws_access_key_id</span><span class="p">,</span>
            <span class="n">aws_secret_access_key</span><span class="o">=</span><span class="n">aws_secret_access_key</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Must provide either a `profile_name` or &quot;</span><span class="p">,</span>
                         <span class="s2">&quot;both `aws_access_key_id` and &quot;</span><span class="p">,</span>
                         <span class="s2">&quot;`aws_secret_access_key` as input to &#39;fetch_hcp&#39;&quot;</span><span class="p">)</span>

    <span class="n">s3</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s1">&#39;s3&#39;</span><span class="p">)</span>
    <span class="n">bucket</span> <span class="o">=</span> <span class="n">s3</span><span class="o">.</span><span class="n">Bucket</span><span class="p">(</span><span class="n">hcp_bucket</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">op</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">afq_home</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">afq_home</span><span class="p">)</span>
        <span class="n">my_path</span> <span class="o">=</span> <span class="n">afq_home</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">my_path</span> <span class="o">=</span> <span class="n">path</span>

    <span class="n">base_dir</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">my_path</span><span class="p">,</span> <span class="n">study</span><span class="p">,</span> <span class="s1">&#39;derivatives&#39;</span><span class="p">,</span> <span class="s1">&#39;dmriprep&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">base_dir</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">data_files</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">subject</span> <span class="ow">in</span> <span class="n">subjects</span><span class="p">:</span>
        <span class="c1"># We make a single session folder per subject for this case, because</span>
        <span class="c1"># AFQ api expects session structure:</span>
        <span class="n">sub_dir</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;sub-</span><span class="si">{</span><span class="n">subject</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">sess_dir</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sub_dir</span><span class="p">,</span> <span class="s2">&quot;ses-01&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">sub_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sess_dir</span><span class="p">,</span> <span class="s1">&#39;dwi&#39;</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sess_dir</span><span class="p">,</span> <span class="s1">&#39;anat&#39;</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">data_files</span><span class="p">[</span><span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sess_dir</span><span class="p">,</span> <span class="s1">&#39;dwi&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;sub-</span><span class="si">{</span><span class="n">subject</span><span class="si">}</span><span class="s1">_dwi.bval&#39;</span><span class="p">)]</span> <span class="o">=</span>\
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">study</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">subject</span><span class="si">}</span><span class="s1">/T1w/Diffusion/bvals&#39;</span>
        <span class="n">data_files</span><span class="p">[</span><span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sess_dir</span><span class="p">,</span> <span class="s1">&#39;dwi&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;sub-</span><span class="si">{</span><span class="n">subject</span><span class="si">}</span><span class="s1">_dwi.bvec&#39;</span><span class="p">)]</span> <span class="o">=</span>\
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">study</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">subject</span><span class="si">}</span><span class="s1">/T1w/Diffusion/bvecs&#39;</span>
        <span class="n">data_files</span><span class="p">[</span><span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sess_dir</span><span class="p">,</span> <span class="s1">&#39;dwi&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;sub-</span><span class="si">{</span><span class="n">subject</span><span class="si">}</span><span class="s1">_dwi.nii.gz&#39;</span><span class="p">)]</span> <span class="o">=</span>\
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">study</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">subject</span><span class="si">}</span><span class="s1">/T1w/Diffusion/data.nii.gz&#39;</span>
        <span class="n">data_files</span><span class="p">[</span><span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sess_dir</span><span class="p">,</span> <span class="s1">&#39;anat&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;sub-</span><span class="si">{</span><span class="n">subject</span><span class="si">}</span><span class="s1">_T1w.nii.gz&#39;</span><span class="p">)]</span> <span class="o">=</span>\
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">study</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">subject</span><span class="si">}</span><span class="s1">/T1w/T1w_acpc_dc.nii.gz&#39;</span>
        <span class="n">data_files</span><span class="p">[</span><span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sess_dir</span><span class="p">,</span> <span class="s1">&#39;anat&#39;</span><span class="p">,</span>
                           <span class="sa">f</span><span class="s1">&#39;sub-</span><span class="si">{</span><span class="n">subject</span><span class="si">}</span><span class="s1">_aparc+aseg_seg.nii.gz&#39;</span><span class="p">)]</span> <span class="o">=</span>\
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">study</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">subject</span><span class="si">}</span><span class="s1">/T1w/aparc+aseg.nii.gz&#39;</span>

    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">data_files</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">op</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
            <span class="n">bucket</span><span class="o">.</span><span class="n">download_file</span><span class="p">(</span><span class="n">data_files</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">k</span><span class="p">)</span>
    <span class="c1"># Create the BIDS dataset description file text</span>
    <span class="n">hcp_acknowledgements</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;Data were provided by the Human Connectome Project, WU-Minn Consortium (Principal Investigators: David Van Essen and Kamil Ugurbil; 1U54MH091657) funded by the 16 NIH Institutes and Centers that support the NIH Blueprint for Neuroscience Research; and by the McDonnell Center for Systems Neuroscience at Washington University.&quot;&quot;&quot;</span><span class="p">,</span>  <span class="c1"># noqa</span>
    <span class="n">to_bids_description</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">my_path</span><span class="p">,</span> <span class="n">study</span><span class="p">),</span>
                        <span class="o">**</span><span class="p">{</span><span class="s2">&quot;Name&quot;</span><span class="p">:</span> <span class="n">study</span><span class="p">,</span>
                           <span class="s2">&quot;Acknowledgements&quot;</span><span class="p">:</span> <span class="n">hcp_acknowledgements</span><span class="p">,</span>
                           <span class="s2">&quot;Subjects&quot;</span><span class="p">:</span> <span class="n">subjects</span><span class="p">})</span>

    <span class="c1"># Create the BIDS derivatives description file text</span>
    <span class="n">to_bids_description</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span>
                        <span class="o">**</span><span class="p">{</span><span class="s2">&quot;Name&quot;</span><span class="p">:</span> <span class="n">study</span><span class="p">,</span>
                           <span class="s2">&quot;Acknowledgements&quot;</span><span class="p">:</span> <span class="n">hcp_acknowledgements</span><span class="p">,</span>
                           <span class="s2">&quot;PipelineDescription&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;Name&#39;</span><span class="p">:</span> <span class="s1">&#39;dmriprep&#39;</span><span class="p">}})</span>

    <span class="k">return</span> <span class="n">data_files</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">my_path</span><span class="p">,</span> <span class="n">study</span><span class="p">)</span></div>


<span class="n">stanford_hardi_tractography_remote_fnames</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;5325715&quot;</span><span class="p">,</span> <span class="s2">&quot;5325718&quot;</span><span class="p">,</span> <span class="s2">&quot;25289735&quot;</span><span class="p">]</span>
<span class="n">stanford_hardi_tractography_hashes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;6f4bdae702031a48d1cd3811e7a42ef9&#39;</span><span class="p">,</span>
                                      <span class="s1">&#39;f20854b4f710577c58bd01072cfb4de6&#39;</span><span class="p">,</span>
                                      <span class="s1">&#39;294bfd1831861e8635eef8834ff18892&#39;</span><span class="p">]</span>
<span class="n">stanford_hardi_tractography_fnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mapping.nii.gz&#39;</span><span class="p">,</span>
                                      <span class="s1">&#39;tractography_subsampled.trk&#39;</span><span class="p">,</span>
                                      <span class="s1">&#39;full_segmented_cleaned_tractography.trk&#39;</span><span class="p">]</span>

<div class="viewcode-block" id="fetch_stanford_hardi_tractography"><a class="viewcode-back" href="../../autoapi/AFQ/index.html#AFQ.data.fetch_stanford_hardi_tractography">[docs]</a><span class="n">fetch_stanford_hardi_tractography</span> <span class="o">=</span> <span class="n">_make_fetcher</span><span class="p">(</span>
    <span class="s2">&quot;fetch_stanford_hardi_tractography&quot;</span><span class="p">,</span>
    <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">afq_home</span><span class="p">,</span>
            <span class="s1">&#39;stanford_hardi_tractography&#39;</span><span class="p">),</span>
    <span class="n">baseurl</span><span class="p">,</span>
    <span class="n">stanford_hardi_tractography_remote_fnames</span><span class="p">,</span>
    <span class="n">stanford_hardi_tractography_fnames</span><span class="p">,</span>
    <span class="n">md5_list</span><span class="o">=</span><span class="n">stanford_hardi_tractography_hashes</span><span class="p">,</span>
    <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;Download Stanford HARDI tractography and mapping. For testing</span>
<span class="s2">           purposes&quot;&quot;&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="read_stanford_hardi_tractography"><a class="viewcode-back" href="../../autoapi/AFQ/index.html#AFQ.data.read_stanford_hardi_tractography">[docs]</a><span class="k">def</span> <span class="nf">read_stanford_hardi_tractography</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads a minimal tractography from the Stanford dataset.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">files</span><span class="p">,</span> <span class="n">folder</span> <span class="o">=</span> <span class="n">fetch_stanford_hardi_tractography</span><span class="p">()</span>
    <span class="n">files_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;mapping.nii.gz&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
        <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">afq_home</span><span class="p">,</span>
                <span class="s1">&#39;stanford_hardi_tractography&#39;</span><span class="p">,</span>
                <span class="s1">&#39;mapping.nii.gz&#39;</span><span class="p">))</span>

    <span class="c1"># We need the original data as reference</span>
    <span class="n">dwi_img</span><span class="p">,</span> <span class="n">gtab</span> <span class="o">=</span> <span class="n">dpd</span><span class="o">.</span><span class="n">read_stanford_hardi</span><span class="p">()</span>

    <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;tractography_subsampled.trk&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_trk</span><span class="p">(</span>
        <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">afq_home</span><span class="p">,</span>
                <span class="s1">&#39;stanford_hardi_tractography&#39;</span><span class="p">,</span>
                <span class="s1">&#39;tractography_subsampled.trk&#39;</span><span class="p">),</span>
        <span class="n">dwi_img</span><span class="p">,</span>
        <span class="n">bbox_valid_check</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">trk_header_check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">streamlines</span>

    <span class="n">files_dict</span><span class="p">[</span><span class="s1">&#39;full_segmented_cleaned_tractography.trk&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_trk</span><span class="p">(</span>
        <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">afq_home</span><span class="p">,</span>
            <span class="s1">&#39;stanford_hardi_tractography&#39;</span><span class="p">,</span>
            <span class="s1">&#39;full_segmented_cleaned_tractography.trk&#39;</span><span class="p">),</span>
        <span class="n">dwi_img</span><span class="p">)</span><span class="o">.</span><span class="n">streamlines</span>

    <span class="k">return</span> <span class="n">files_dict</span></div>


<span class="k">def</span> <span class="nf">to_bids_description</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">fname</span><span class="o">=</span><span class="s1">&#39;dataset_description.json&#39;</span><span class="p">,</span>
                        <span class="n">BIDSVersion</span><span class="o">=</span><span class="s2">&quot;1.4.0&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Dumps a dict into a bids description at the given location&quot;&quot;&quot;</span>
    <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;BIDSVersion&quot;</span><span class="p">:</span> <span class="n">BIDSVersion</span><span class="p">})</span>
    <span class="n">desc_file</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">desc_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">outfile</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">organize_cfin_data</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create the expected file-system structure for the</span>
<span class="sd">    CFIN multi b-value diffusion data-set.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">dpd</span><span class="o">.</span><span class="n">fetch_cfin_multib</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">afq_home</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">afq_home</span>

    <span class="n">bids_path</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;cfin_multib&#39;</span><span class="p">,)</span>
    <span class="n">derivatives_path</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bids_path</span><span class="p">,</span> <span class="s1">&#39;derivatives&#39;</span><span class="p">)</span>
    <span class="n">dmriprep_folder</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">derivatives_path</span><span class="p">,</span> <span class="s1">&#39;dmriprep&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">op</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">derivatives_path</span><span class="p">):</span>
        <span class="n">anat_folder</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dmriprep_folder</span><span class="p">,</span> <span class="s1">&#39;sub-01&#39;</span><span class="p">,</span> <span class="s1">&#39;ses-01&#39;</span><span class="p">,</span> <span class="s1">&#39;anat&#39;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">anat_folder</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">dwi_folder</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dmriprep_folder</span><span class="p">,</span> <span class="s1">&#39;sub-01&#39;</span><span class="p">,</span> <span class="s1">&#39;ses-01&#39;</span><span class="p">,</span> <span class="s1">&#39;dwi&#39;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dwi_folder</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">t1_img</span> <span class="o">=</span> <span class="n">dpd</span><span class="o">.</span><span class="n">read_cfin_t1</span><span class="p">()</span>
        <span class="n">nib</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">t1_img</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">anat_folder</span><span class="p">,</span> <span class="s1">&#39;sub-01_ses-01_T1w.nii.gz&#39;</span><span class="p">))</span>
        <span class="n">dwi_img</span><span class="p">,</span> <span class="n">gtab</span> <span class="o">=</span> <span class="n">dpd</span><span class="o">.</span><span class="n">read_cfin_dwi</span><span class="p">()</span>
        <span class="n">nib</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">dwi_img</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dwi_folder</span><span class="p">,</span> <span class="s1">&#39;sub-01_ses-01_dwi.nii.gz&#39;</span><span class="p">))</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dwi_folder</span><span class="p">,</span> <span class="s1">&#39;sub-01_ses-01_dwi.bvec&#39;</span><span class="p">),</span> <span class="n">gtab</span><span class="o">.</span><span class="n">bvecs</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dwi_folder</span><span class="p">,</span> <span class="s1">&#39;sub-01_ses-01_dwi.bval&#39;</span><span class="p">),</span> <span class="n">gtab</span><span class="o">.</span><span class="n">bvals</span><span class="p">)</span>

    <span class="n">to_bids_description</span><span class="p">(</span>
        <span class="n">bids_path</span><span class="p">,</span>
        <span class="o">**</span><span class="p">{</span><span class="s2">&quot;BIDSVersion&quot;</span><span class="p">:</span> <span class="s2">&quot;1.0.0&quot;</span><span class="p">,</span>
           <span class="s2">&quot;Name&quot;</span><span class="p">:</span> <span class="s2">&quot;CFIN&quot;</span><span class="p">,</span>
           <span class="s2">&quot;Subjects&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;sub-01&quot;</span><span class="p">]})</span>

    <span class="n">to_bids_description</span><span class="p">(</span>
        <span class="n">dmriprep_folder</span><span class="p">,</span>
        <span class="o">**</span><span class="p">{</span><span class="s2">&quot;Name&quot;</span><span class="p">:</span> <span class="s2">&quot;CFIN&quot;</span><span class="p">,</span>
           <span class="s2">&quot;PipelineDescription&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;Name&quot;</span><span class="p">:</span> <span class="s2">&quot;dipy&quot;</span><span class="p">}})</span>


<div class="viewcode-block" id="organize_stanford_data"><a class="viewcode-back" href="../../autoapi/AFQ/index.html#AFQ.data.organize_stanford_data">[docs]</a><span class="k">def</span> <span class="nf">organize_stanford_data</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">clear_previous_afq</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    If necessary, downloads the Stanford HARDI dataset into DIPY directory and</span>
<span class="sd">    creates a BIDS compliant file-system structure in AFQ data directory:</span>


<span class="sd">    ~/AFQ_data/</span>
<span class="sd">     stanford_hardi</span>
<span class="sd">     dataset_description.json</span>
<span class="sd">     derivatives</span>
<span class="sd">         freesurfer</span>
<span class="sd">            dataset_description.json</span>
<span class="sd">            sub-01</span>
<span class="sd">                ses-01</span>
<span class="sd">                    anat</span>
<span class="sd">                        sub-01_ses-01_T1w.nii.gz</span>
<span class="sd">                        sub-01_ses-01_seg.nii.gz</span>
<span class="sd">         vistasoft</span>
<span class="sd">             dataset_description.json</span>
<span class="sd">             sub-01</span>
<span class="sd">                 ses-01</span>
<span class="sd">                     dwi</span>
<span class="sd">                         sub-01_ses-01_dwi.bval</span>
<span class="sd">                         sub-01_ses-01_dwi.bvec</span>
<span class="sd">                         sub-01_ses-01_dwi.nii.gz</span>

<span class="sd">    If clear_previous_afq is True and there is an afq folder in derivatives,</span>
<span class="sd">    it will be removed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;AFQ.data&#39;</span><span class="p">)</span>

    <span class="c1"># fetches data for first subject and session</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;fetching Stanford HARDI data&#39;</span><span class="p">)</span>
    <span class="n">dpd</span><span class="o">.</span><span class="n">fetch_stanford_hardi</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">op</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">afq_home</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;creating AFQ home directory: </span><span class="si">{</span><span class="n">afq_home</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">afq_home</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">afq_home</span>

    <span class="n">bids_path</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;stanford_hardi&#39;</span><span class="p">,)</span>
    <span class="n">derivatives_path</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bids_path</span><span class="p">,</span> <span class="s1">&#39;derivatives&#39;</span><span class="p">)</span>
    <span class="n">dmriprep_folder</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">derivatives_path</span><span class="p">,</span> <span class="s1">&#39;vistasoft&#39;</span><span class="p">)</span>
    <span class="n">freesurfer_folder</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">derivatives_path</span><span class="p">,</span> <span class="s1">&#39;freesurfer&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">clear_previous_afq</span><span class="p">:</span>
        <span class="n">afq_folder</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">derivatives_path</span><span class="p">,</span> <span class="s1">&#39;afq&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">afq_folder</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">afq_folder</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">op</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">derivatives_path</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;creating derivatives directory: </span><span class="si">{</span><span class="n">derivatives_path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># anatomical data</span>
        <span class="n">anat_folder</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">freesurfer_folder</span><span class="p">,</span> <span class="s1">&#39;sub-01&#39;</span><span class="p">,</span> <span class="s1">&#39;ses-01&#39;</span><span class="p">,</span> <span class="s1">&#39;anat&#39;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">anat_folder</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">t1_img</span> <span class="o">=</span> <span class="n">dpd</span><span class="o">.</span><span class="n">read_stanford_t1</span><span class="p">()</span>
        <span class="n">nib</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">t1_img</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">anat_folder</span><span class="p">,</span> <span class="s1">&#39;sub-01_ses-01_T1w.nii.gz&#39;</span><span class="p">))</span>

        <span class="n">seg_img</span> <span class="o">=</span> <span class="n">dpd</span><span class="o">.</span><span class="n">read_stanford_labels</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">nib</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">seg_img</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">anat_folder</span><span class="p">,</span>
                                  <span class="s1">&#39;sub-01_ses-01_seg.nii.gz&#39;</span><span class="p">))</span>

        <span class="c1"># diffusion-weighted imaging data</span>
        <span class="n">dwi_folder</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dmriprep_folder</span><span class="p">,</span> <span class="s1">&#39;sub-01&#39;</span><span class="p">,</span> <span class="s1">&#39;ses-01&#39;</span><span class="p">,</span> <span class="s1">&#39;dwi&#39;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dwi_folder</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">dwi_img</span><span class="p">,</span> <span class="n">gtab</span> <span class="o">=</span> <span class="n">dpd</span><span class="o">.</span><span class="n">read_stanford_hardi</span><span class="p">()</span>
        <span class="n">nib</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">dwi_img</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dwi_folder</span><span class="p">,</span> <span class="s1">&#39;sub-01_ses-01_dwi.nii.gz&#39;</span><span class="p">))</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dwi_folder</span><span class="p">,</span> <span class="s1">&#39;sub-01_ses-01_dwi.bvec&#39;</span><span class="p">),</span> <span class="n">gtab</span><span class="o">.</span><span class="n">bvecs</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dwi_folder</span><span class="p">,</span> <span class="s1">&#39;sub-01_ses-01_dwi.bval&#39;</span><span class="p">),</span> <span class="n">gtab</span><span class="o">.</span><span class="n">bvals</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Dataset is already in place. If you want to fetch it &#39;</span>
                    <span class="o">+</span> <span class="s1">&#39;again please first remove the folder &#39;</span>
                    <span class="o">+</span> <span class="n">derivatives_path</span><span class="p">)</span>

    <span class="c1"># Dump out the description of the dataset</span>
    <span class="n">to_bids_description</span><span class="p">(</span><span class="n">bids_path</span><span class="p">,</span>
                        <span class="o">**</span><span class="p">{</span><span class="s2">&quot;Name&quot;</span><span class="p">:</span> <span class="s2">&quot;Stanford HARDI&quot;</span><span class="p">,</span> <span class="s2">&quot;Subjects&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;sub-01&quot;</span><span class="p">]})</span>

    <span class="c1"># And descriptions of the pipelines in the derivatives:</span>
    <span class="n">to_bids_description</span><span class="p">(</span><span class="n">dmriprep_folder</span><span class="p">,</span>
                        <span class="o">**</span><span class="p">{</span><span class="s2">&quot;Name&quot;</span><span class="p">:</span> <span class="s2">&quot;Stanford HARDI&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;PipelineDescription&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;Name&quot;</span><span class="p">:</span> <span class="s2">&quot;vistasoft&quot;</span><span class="p">}})</span>
    <span class="n">to_bids_description</span><span class="p">(</span><span class="n">freesurfer_folder</span><span class="p">,</span>
                        <span class="o">**</span><span class="p">{</span><span class="s2">&quot;Name&quot;</span><span class="p">:</span> <span class="s2">&quot;Stanford HARDI&quot;</span><span class="p">,</span>
                           <span class="s2">&quot;PipelineDescription&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;Name&quot;</span><span class="p">:</span> <span class="s2">&quot;freesurfer&quot;</span><span class="p">}})</span></div>


<span class="n">fetch_hcp_atlas_16_bundles</span> <span class="o">=</span> <span class="n">_make_fetcher</span><span class="p">(</span>
    <span class="s2">&quot;fetch_hcp_atlas_16_bundles&quot;</span><span class="p">,</span>
    <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">afq_home</span><span class="p">,</span>
            <span class="s1">&#39;hcp_atlas_16_bundles&#39;</span><span class="p">),</span>
    <span class="s1">&#39;https://ndownloader.figshare.com/files/&#39;</span><span class="p">,</span>
    <span class="p">[</span><span class="s2">&quot;11921522&quot;</span><span class="p">],</span>
    <span class="p">[</span><span class="s2">&quot;atlas_16_bundles.zip&quot;</span><span class="p">],</span>
    <span class="n">md5_list</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;b071f3e851f21ba1749c02fc6beb3118&quot;</span><span class="p">],</span>
    <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;Download minimal Recobundles atlas&quot;</span><span class="p">,</span>
    <span class="n">unzip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="n">fetch_hcp_atlas_80_bundles</span> <span class="o">=</span> <span class="n">_make_fetcher</span><span class="p">(</span>
    <span class="s2">&quot;fetch_hcp_atlas_80_bundles&quot;</span><span class="p">,</span>
    <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">afq_home</span><span class="p">,</span>
            <span class="s1">&#39;hcp_atlas_80_bundles&#39;</span><span class="p">),</span>
    <span class="s1">&#39;https://ndownloader.figshare.com/files/&#39;</span><span class="p">,</span>
    <span class="p">[</span><span class="s2">&quot;13638644&quot;</span><span class="p">],</span>
    <span class="p">[</span><span class="s2">&quot;Atlas_80_Bundles.zip&quot;</span><span class="p">],</span>
    <span class="n">md5_list</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;78331d527a10ec000d4f33bac472e099&quot;</span><span class="p">],</span>
    <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;Download 80-bundle Recobundles atlas&quot;</span><span class="p">,</span>
    <span class="n">unzip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">read_hcp_atlas</span><span class="p">(</span><span class="n">n_bundles</span><span class="o">=</span><span class="mi">16</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    n_bundles : int</span>
<span class="sd">        16 or 80, which selects among the two different</span>
<span class="sd">        atlases:</span>

<span class="sd">        https://figshare.com/articles/Simple_model_bundle_atlas_for_RecoBundles/6483614  #noqa</span>

<span class="sd">        https://figshare.com/articles/Advanced_Atlas_of_80_Bundles_in_MNI_space/7375883  #noqa</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">bundle_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">n_bundles</span> <span class="o">==</span> <span class="mi">16</span><span class="p">:</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">folder</span> <span class="o">=</span> <span class="n">fetch_hcp_atlas_16_bundles</span><span class="p">()</span>
        <span class="n">atlas_folder</span> <span class="o">=</span> <span class="s2">&quot;Atlas_in_MNI_Space_16_bundles&quot;</span>
    <span class="k">elif</span> <span class="n">n_bundles</span> <span class="o">==</span> <span class="mi">80</span><span class="p">:</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">folder</span> <span class="o">=</span> <span class="n">fetch_hcp_atlas_80_bundles</span><span class="p">()</span>
        <span class="n">atlas_folder</span> <span class="o">=</span> <span class="s2">&quot;Atlas_80_Bundles&quot;</span>

    <span class="n">whole_brain</span> <span class="o">=</span> <span class="n">load_tractogram</span><span class="p">(</span>
        <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">folder</span><span class="p">,</span>
            <span class="n">atlas_folder</span><span class="p">,</span>
            <span class="s1">&#39;whole_brain&#39;</span><span class="p">,</span>
            <span class="s1">&#39;whole_brain_MNI.trk&#39;</span><span class="p">),</span>
            <span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">bbox_valid_check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">streamlines</span>

    <span class="n">bundle_dict</span><span class="p">[</span><span class="s1">&#39;whole_brain&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">whole_brain</span>
    <span class="n">bundle_files</span> <span class="o">=</span> <span class="n">glob</span><span class="p">(</span>
        <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">folder</span><span class="p">,</span>
            <span class="n">atlas_folder</span><span class="p">,</span>
            <span class="s2">&quot;bundles&quot;</span><span class="p">,</span> <span class="s2">&quot;*.trk&quot;</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">bundle_file</span> <span class="ow">in</span> <span class="n">bundle_files</span><span class="p">:</span>
        <span class="n">bundle</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">bundle_file</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">bundle_dict</span><span class="p">[</span><span class="n">bundle</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">bundle_dict</span><span class="p">[</span><span class="n">bundle</span><span class="p">][</span><span class="s1">&#39;sl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_tractogram</span><span class="p">(</span>
            <span class="n">bundle_file</span><span class="p">,</span>
            <span class="s1">&#39;same&#39;</span><span class="p">,</span>
            <span class="n">bbox_valid_check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">streamlines</span>

        <span class="n">feature</span> <span class="o">=</span> <span class="n">ResampleFeature</span><span class="p">(</span><span class="n">nb_points</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
        <span class="n">metric</span> <span class="o">=</span> <span class="n">AveragePointwiseEuclideanMetric</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>
        <span class="n">qb</span> <span class="o">=</span> <span class="n">QuickBundles</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="n">metric</span><span class="p">)</span>
        <span class="n">cluster</span> <span class="o">=</span> <span class="n">qb</span><span class="o">.</span><span class="n">cluster</span><span class="p">(</span><span class="n">bundle_dict</span><span class="p">[</span><span class="n">bundle</span><span class="p">][</span><span class="s1">&#39;sl&#39;</span><span class="p">])</span>
        <span class="n">bundle_dict</span><span class="p">[</span><span class="n">bundle</span><span class="p">][</span><span class="s1">&#39;centroid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">centroids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># For some reason, this file-name has a 0 in it, instead of an O:</span>
    <span class="n">bundle_dict</span><span class="p">[</span><span class="s2">&quot;IFOF_R&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bundle_dict</span><span class="p">[</span><span class="s2">&quot;IF0F_R&quot;</span><span class="p">]</span>
    <span class="c1"># In the 80-bundle case, there are two files, and both have identical</span>
    <span class="c1"># content, so this is fine:</span>
    <span class="k">del</span> <span class="n">bundle_dict</span><span class="p">[</span><span class="s2">&quot;IF0F_R&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">bundle_dict</span>


<span class="n">fetch_aal_atlas</span> <span class="o">=</span> <span class="n">_make_fetcher</span><span class="p">(</span>
    <span class="s2">&quot;fetch_aal_atlas&quot;</span><span class="p">,</span>
    <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">afq_home</span><span class="p">,</span>
            <span class="s1">&#39;aal_atlas&#39;</span><span class="p">),</span>
    <span class="s1">&#39;https://digital.lib.washington.edu&#39;</span> <span class="o">+</span> <span class="s1">&#39;/researchworks&#39;</span>
    <span class="o">+</span> <span class="s1">&#39;/bitstream/handle/1773/44951/&#39;</span><span class="p">,</span>
    <span class="p">[</span><span class="s2">&quot;MNI_AAL_AndMore.nii.gz&quot;</span><span class="p">,</span>
     <span class="s2">&quot;MNI_AAL.txt&quot;</span><span class="p">],</span>
    <span class="p">[</span><span class="s2">&quot;MNI_AAL_AndMore.nii.gz&quot;</span><span class="p">,</span>
     <span class="s2">&quot;MNI_AAL.txt&quot;</span><span class="p">],</span>
    <span class="n">md5_list</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;69395b75a16f00294a80eb9428bf7855&quot;</span><span class="p">,</span>
              <span class="s2">&quot;59fd3284b17de2fbe411ca1c7afe8c65&quot;</span><span class="p">],</span>
    <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;Download the AAL atlas&quot;</span><span class="p">,</span>
    <span class="n">unzip</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">read_aal_atlas</span><span class="p">(</span><span class="n">resample_to</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads the AAL atlas [1]_.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    template : nib.Nifti1Image class instance, optional</span>
<span class="sd">        If provided, this is the template used and AAL atlas should be</span>
<span class="sd">        registered and aligned to this template</span>


<span class="sd">    .. [1] Tzourio-Mazoyer N, Landeau B, Papathanassiou D, Crivello F, Etard O,</span>
<span class="sd">           Delcroix N, Mazoyer B, Joliot M. (2002). Automated anatomical</span>
<span class="sd">           labeling of activations in SPM using a macroscopic anatomical</span>
<span class="sd">           parcellation of the MNI MRI single-subject brain. Neuroimage. 2002;</span>
<span class="sd">           15(1):273-89.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">file_dict</span><span class="p">,</span> <span class="n">folder</span> <span class="o">=</span> <span class="n">fetch_aal_atlas</span><span class="p">()</span>
    <span class="n">out_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">file_dict</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.txt&#39;</span><span class="p">):</span>
            <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;atlas&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">resample_to</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;atlas&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>
        <span class="n">oo</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">oo</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">resample</span><span class="p">(</span>
                <span class="n">data</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">ii</span><span class="p">],</span>
                <span class="n">resample_to</span><span class="p">,</span>
                <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;atlas&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">affine</span><span class="p">,</span>
                <span class="n">resample_to</span><span class="o">.</span><span class="n">affine</span><span class="p">)</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">())</span>
        <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;atlas&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">Nifti1Image</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">oo</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                                            <span class="n">resample_to</span><span class="o">.</span><span class="n">affine</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out_dict</span>


<span class="k">def</span> <span class="nf">aal_to_regions</span><span class="p">(</span><span class="n">regions</span><span class="p">,</span> <span class="n">atlas</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Queries for large regions containing multiple AAL ROIs</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    regions : string or list of strings</span>
<span class="sd">        The name of the requested region. This can either be an AAL-defined ROI</span>
<span class="sd">        name (e.g, &#39;Occipital_Sup_L&#39;) or one of:</span>
<span class="sd">        {&#39;leftfrontal&#39; | &#39;leftoccipital&#39; | &#39;lefttemporal&#39; | &#39;leftparietal&#39;</span>
<span class="sd">        | &#39;leftanttemporal&#39; | &#39;leftparietal&#39; | &#39;leftanttemporal&#39;</span>
<span class="sd">        | &#39;leftuncinatefront&#39; | &#39;leftifoffront&#39; | &#39;leftinfparietal&#39;</span>
<span class="sd">        | &#39;cerebellum&#39; | &#39;leftarcfrontal&#39; | &#39;leftarctemp&#39; | &#39;leftcingpost&#39;}</span>
<span class="sd">        each of which there is an equivalent &#39;right&#39; region for. In addition,</span>
<span class="sd">        there are a few bilateral regions: {&#39;occipital&#39; | &#39;temporal&#39;}, which</span>
<span class="sd">        encompass both the right and left region of this name, as well as:</span>
<span class="sd">        {&#39;cstinferior&#39; | &#39;cstsuperior&#39;}</span>

<span class="sd">    atlas : 4D array</span>
<span class="sd">       Contains the AAL atlas in the correct coordinate frame with additional</span>
<span class="sd">       volumes for CST and cingulate ROIs (&quot;AAL and more&quot;).</span>

<span class="sd">    Returns</span>
<span class="sd">    ------</span>
<span class="sd">    3D indices to the requested region in the atlas volume</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Several regions can be referred to by multiple names:</span>
<span class="sd">           &#39;leftuncinatetemp&#39; = &#39;leftilftemp&#39;= &#39;leftanttemporal&#39;</span>
<span class="sd">           &#39;rightuncinatetemp&#39; = &#39;rightilftemp&#39; = &#39;rightanttemporal&#39;</span>
<span class="sd">           &#39;leftslfpar&#39;] = &#39;leftinfparietal&#39;</span>
<span class="sd">           &#39;rightslfpar&#39; = &#39;rightinfparietal&#39;</span>
<span class="sd">           &#39;leftslffrontal&#39; = &#39;leftarcfrontal&#39;</span>
<span class="sd">           &#39;rightslffrontal&#39; = &#39;rightarcfrontal&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">atlas</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">atlas</span> <span class="o">=</span> <span class="n">read_aal_atlas</span><span class="p">()[</span><span class="s1">&#39;atlas&#39;</span><span class="p">]</span>
    <span class="n">atlas_vals</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;leftfrontal&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                  <span class="c1"># Occipital regions do not include fusiform:</span>
                  <span class="s1">&#39;leftoccipital&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">43</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                  <span class="c1"># Temporal regions include fusiform:</span>
                  <span class="s1">&#39;lefttemporal&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">37</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                                                  <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">55</span><span class="p">]),</span>
                                                  <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">79</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">2</span><span class="p">)]),</span>
                  <span class="s1">&#39;leftparietal&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">57</span><span class="p">,</span> <span class="mi">67</span><span class="p">,</span> <span class="mi">2</span><span class="p">]),</span>
                  <span class="s1">&#39;leftanttemporal&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">41</span><span class="p">,</span> <span class="mi">83</span><span class="p">,</span> <span class="mi">87</span><span class="p">]),</span>
                  <span class="s1">&#39;leftuncinatefront&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">5</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">25</span><span class="p">]),</span>
                  <span class="s1">&#39;leftifoffront&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">25</span><span class="p">]),</span>
                  <span class="s1">&#39;leftinfparietal&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">61</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">65</span><span class="p">]),</span>
                  <span class="s1">&#39;cerebellum&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">91</span><span class="p">,</span> <span class="mi">117</span><span class="p">),</span>
                  <span class="s1">&#39;leftarcfrontal&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">13</span><span class="p">]),</span>
                  <span class="s1">&#39;leftarctemp&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">79</span><span class="p">,</span> <span class="mi">81</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">89</span><span class="p">]),</span>
                  <span class="p">}</span>

    <span class="c1"># Right symmetrical is off by one:</span>
    <span class="n">atlas_vals</span><span class="p">[</span><span class="s1">&#39;rightfrontal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">atlas_vals</span><span class="p">[</span><span class="s1">&#39;leftfrontal&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">atlas_vals</span><span class="p">[</span><span class="s1">&#39;rightoccipital&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">atlas_vals</span><span class="p">[</span><span class="s1">&#39;leftoccipital&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">atlas_vals</span><span class="p">[</span><span class="s1">&#39;righttemporal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">atlas_vals</span><span class="p">[</span><span class="s1">&#39;lefttemporal&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">atlas_vals</span><span class="p">[</span><span class="s1">&#39;rightparietal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">atlas_vals</span><span class="p">[</span><span class="s1">&#39;leftparietal&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">atlas_vals</span><span class="p">[</span><span class="s1">&#39;rightanttemporal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">atlas_vals</span><span class="p">[</span><span class="s1">&#39;leftanttemporal&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">atlas_vals</span><span class="p">[</span><span class="s1">&#39;rightuncinatefront&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">atlas_vals</span><span class="p">[</span><span class="s1">&#39;leftuncinatefront&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">atlas_vals</span><span class="p">[</span><span class="s1">&#39;rightifoffront&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">atlas_vals</span><span class="p">[</span><span class="s1">&#39;leftifoffront&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">atlas_vals</span><span class="p">[</span><span class="s1">&#39;rightinfparietal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">atlas_vals</span><span class="p">[</span><span class="s1">&#39;leftinfparietal&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">atlas_vals</span><span class="p">[</span><span class="s1">&#39;rightarcfrontal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">atlas_vals</span><span class="p">[</span><span class="s1">&#39;leftarcfrontal&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">atlas_vals</span><span class="p">[</span><span class="s1">&#39;rightarctemp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">atlas_vals</span><span class="p">[</span><span class="s1">&#39;leftarctemp&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="c1"># Multiply named regions:</span>
    <span class="n">atlas_vals</span><span class="p">[</span><span class="s1">&#39;leftuncinatetemp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">atlas_vals</span><span class="p">[</span><span class="s1">&#39;leftilftemp&#39;</span><span class="p">]</span> <span class="o">=</span>\
        <span class="n">atlas_vals</span><span class="p">[</span><span class="s1">&#39;leftanttemporal&#39;</span><span class="p">]</span>
    <span class="n">atlas_vals</span><span class="p">[</span><span class="s1">&#39;rightuncinatetemp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">atlas_vals</span><span class="p">[</span><span class="s1">&#39;rightilftemp&#39;</span><span class="p">]</span> <span class="o">=</span>\
        <span class="n">atlas_vals</span><span class="p">[</span><span class="s1">&#39;rightanttemporal&#39;</span><span class="p">]</span>
    <span class="n">atlas_vals</span><span class="p">[</span><span class="s1">&#39;leftslfpar&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">atlas_vals</span><span class="p">[</span><span class="s1">&#39;leftinfparietal&#39;</span><span class="p">]</span>
    <span class="n">atlas_vals</span><span class="p">[</span><span class="s1">&#39;rightslfpar&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">atlas_vals</span><span class="p">[</span><span class="s1">&#39;rightinfparietal&#39;</span><span class="p">]</span>
    <span class="n">atlas_vals</span><span class="p">[</span><span class="s1">&#39;leftslffrontal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">atlas_vals</span><span class="p">[</span><span class="s1">&#39;leftarcfrontal&#39;</span><span class="p">]</span>
    <span class="n">atlas_vals</span><span class="p">[</span><span class="s1">&#39;rightslffrontal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">atlas_vals</span><span class="p">[</span><span class="s1">&#39;rightarcfrontal&#39;</span><span class="p">]</span>

    <span class="c1"># Bilateral regions:</span>
    <span class="n">atlas_vals</span><span class="p">[</span><span class="s1">&#39;occipital&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">union1d</span><span class="p">(</span><span class="n">atlas_vals</span><span class="p">[</span><span class="s1">&#39;leftoccipital&#39;</span><span class="p">],</span>
                                         <span class="n">atlas_vals</span><span class="p">[</span><span class="s1">&#39;rightoccipital&#39;</span><span class="p">])</span>
    <span class="n">atlas_vals</span><span class="p">[</span><span class="s1">&#39;temporal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">union1d</span><span class="p">(</span><span class="n">atlas_vals</span><span class="p">[</span><span class="s1">&#39;lefttemporal&#39;</span><span class="p">],</span>
                                        <span class="n">atlas_vals</span><span class="p">[</span><span class="s1">&#39;righttemporal&#39;</span><span class="p">])</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">regions</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">regions</span> <span class="o">=</span> <span class="p">[</span><span class="n">regions</span><span class="p">]</span>

    <span class="n">idxes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">regions</span><span class="p">:</span>
        <span class="n">region</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>  <span class="c1"># Just to be sure</span>
        <span class="k">if</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">atlas_vals</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">vol_idx</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="n">atlas_vals</span><span class="p">[</span><span class="n">region</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">region</span> <span class="o">==</span> <span class="s1">&#39;cstinferior&#39;</span><span class="p">:</span>
            <span class="n">vol_idx</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">region</span> <span class="o">==</span> <span class="s1">&#39;cstsuperior&#39;</span><span class="p">:</span>
            <span class="n">vol_idx</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">region</span> <span class="o">==</span> <span class="s1">&#39;leftcingpost&#39;</span><span class="p">:</span>
            <span class="n">vol_idx</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">region</span> <span class="o">==</span> <span class="s1">&#39;rightcingpost&#39;</span><span class="p">:</span>
            <span class="n">vol_idx</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># Broadcast vals, to test for equality over all three dimensions:</span>
        <span class="n">is_in</span> <span class="o">=</span> <span class="n">atlas</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">vol_idx</span><span class="p">]</span> <span class="o">==</span> <span class="n">vals</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="c1"># Then collapse the 4th dimension (each val), to get the 3D array:</span>
        <span class="n">is_in</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">is_in</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">idxes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">is_in</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">idxes</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">bundles_to_aal</span><span class="p">(</span><span class="n">bundles</span><span class="p">,</span> <span class="n">atlas</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a sequence of AFQ bundle names, give back a sequence of lists</span>
<span class="sd">    with [target0, target1] being each NX3 arrays of the endpoint indices</span>
<span class="sd">    for the first and last node of the streamlines in this bundle.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">atlas</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">atlas</span> <span class="o">=</span> <span class="n">read_aal_atlas</span><span class="p">()[</span><span class="s1">&#39;atlas&#39;</span><span class="p">]</span>

    <span class="n">endpoint_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;ATR_L&quot;</span><span class="p">:</span> <span class="p">[[</span><span class="s1">&#39;leftfrontal&#39;</span><span class="p">],</span> <span class="kc">None</span><span class="p">],</span>
        <span class="s2">&quot;ATR_R&quot;</span><span class="p">:</span> <span class="p">[[</span><span class="s1">&#39;rightfrontal&#39;</span><span class="p">],</span> <span class="kc">None</span><span class="p">],</span>
        <span class="s2">&quot;CST_L&quot;</span><span class="p">:</span> <span class="p">[[</span><span class="s1">&#39;cstinferior&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;cstsuperior&#39;</span><span class="p">]],</span>
        <span class="s2">&quot;CST_R&quot;</span><span class="p">:</span> <span class="p">[[</span><span class="s1">&#39;cstinferior&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;cstsuperior&#39;</span><span class="p">]],</span>
        <span class="s2">&quot;CGC_L&quot;</span><span class="p">:</span> <span class="p">[[</span><span class="s1">&#39;leftcingpost&#39;</span><span class="p">],</span> <span class="kc">None</span><span class="p">],</span>
        <span class="s2">&quot;CGC_R&quot;</span><span class="p">:</span> <span class="p">[[</span><span class="s1">&#39;rightcingpost&#39;</span><span class="p">],</span> <span class="kc">None</span><span class="p">],</span>
        <span class="s2">&quot;HCC_L&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
        <span class="s2">&quot;HCC_R&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
        <span class="s2">&quot;FP&quot;</span><span class="p">:</span> <span class="p">[[</span><span class="s1">&#39;rightoccipital&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;leftoccipital&#39;</span><span class="p">]],</span>
        <span class="s2">&quot;FA&quot;</span><span class="p">:</span> <span class="p">[[</span><span class="s1">&#39;rightfrontal&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;leftfrontal&#39;</span><span class="p">]],</span>
        <span class="s2">&quot;IFO_L&quot;</span><span class="p">:</span> <span class="p">[[</span><span class="s1">&#39;leftoccipital&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;leftifoffront&#39;</span><span class="p">]],</span>
        <span class="s2">&quot;IFO_R&quot;</span><span class="p">:</span> <span class="p">[[</span><span class="s1">&#39;rightoccipital&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;rightifoffront&#39;</span><span class="p">]],</span>
        <span class="s2">&quot;ILF_L&quot;</span><span class="p">:</span> <span class="p">[[</span><span class="s1">&#39;leftoccipital&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;leftilftemp&#39;</span><span class="p">]],</span>
        <span class="s2">&quot;ILF_R&quot;</span><span class="p">:</span> <span class="p">[[</span><span class="s1">&#39;rightoccipital&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;rightilftemp&#39;</span><span class="p">]],</span>
        <span class="s2">&quot;SLF_L&quot;</span><span class="p">:</span> <span class="p">[[</span><span class="s1">&#39;leftslffrontal&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;leftinfparietal&#39;</span><span class="p">]],</span>
        <span class="s2">&quot;SLF_R&quot;</span><span class="p">:</span> <span class="p">[[</span><span class="s1">&#39;rightslffrontal&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;rightinfparietal&#39;</span><span class="p">]],</span>
        <span class="s2">&quot;UNC_L&quot;</span><span class="p">:</span> <span class="p">[[</span><span class="s1">&#39;leftanttemporal&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;leftuncinatefront&#39;</span><span class="p">]],</span>
        <span class="s2">&quot;UNC_R&quot;</span><span class="p">:</span> <span class="p">[[</span><span class="s1">&#39;rightanttemporal&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;rightuncinatefront&#39;</span><span class="p">]],</span>
        <span class="s2">&quot;ARC_L&quot;</span><span class="p">:</span> <span class="p">[[</span><span class="s1">&#39;leftfrontal&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;leftarctemp&#39;</span><span class="p">]],</span>
        <span class="s2">&quot;ARC_R&quot;</span><span class="p">:</span> <span class="p">[[</span><span class="s1">&#39;rightfrontal&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;rightarctemp&#39;</span><span class="p">]],</span>
        <span class="s2">&quot;AntFrontal&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
        <span class="s2">&quot;Motor&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
        <span class="s2">&quot;Occipital&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
        <span class="s2">&quot;Orbital&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
        <span class="s2">&quot;PostParietal&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
        <span class="s2">&quot;SupFrontal&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
        <span class="s2">&quot;SupParietal&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
        <span class="s2">&quot;Temporal&quot;</span><span class="p">:</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]}</span>

    <span class="n">targets</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">bundle</span> <span class="ow">in</span> <span class="n">bundles</span><span class="p">:</span>
        <span class="n">targets</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">endpoint_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">bundle</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">region</span> <span class="ow">in</span> <span class="n">endpoint_dict</span><span class="p">[</span><span class="n">bundle</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">region</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">targets</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">targets</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aal_to_regions</span><span class="p">(</span><span class="n">region</span><span class="p">,</span> <span class="n">atlas</span><span class="o">=</span><span class="n">atlas</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;AFQ.data&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Segmentation end points undefined for </span><span class="si">{</span><span class="n">bundle</span><span class="si">}</span><span class="s2">,&quot;</span>
                           <span class="o">+</span> <span class="s2">&quot; continuing without end points&quot;</span><span class="p">)</span>
            <span class="n">targets</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">targets</span>


<span class="k">def</span> <span class="nf">s3fs_nifti_write</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write a nifti file straight to S3</span>

<span class="sd">    Paramters</span>
<span class="sd">    ---------</span>
<span class="sd">    img : nib.Nifti1Image class instance</span>
<span class="sd">        The image containing data to be written into S3</span>
<span class="sd">    fname : string</span>
<span class="sd">        Full path (including bucket name and extension) to the S3 location</span>
<span class="sd">        where the file is to be saved.</span>
<span class="sd">    fs : an s3fs.S3FileSystem class instance, optional</span>
<span class="sd">        A file-system to refer to. Default to create a new file-system</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">fs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="n">s3fs</span><span class="o">.</span><span class="n">S3FileSystem</span><span class="p">()</span>

    <span class="n">bio</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>
    <span class="n">file_map</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">make_file_map</span><span class="p">({</span><span class="s1">&#39;image&#39;</span><span class="p">:</span> <span class="n">bio</span><span class="p">,</span> <span class="s1">&#39;header&#39;</span><span class="p">:</span> <span class="n">bio</span><span class="p">})</span>
    <span class="n">img</span><span class="o">.</span><span class="n">to_file_map</span><span class="p">(</span><span class="n">file_map</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">gzip</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">bio</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
    <span class="k">with</span> <span class="n">fs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ff</span><span class="p">:</span>
        <span class="n">ff</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">s3fs_nifti_read</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">anon</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Lazily reads a nifti image from S3.</span>

<span class="sd">    Paramters</span>
<span class="sd">    ---------</span>
<span class="sd">    fname : string</span>
<span class="sd">        Full path (including bucket name and extension) to the S3 location</span>
<span class="sd">        of the file to be read.</span>
<span class="sd">    fs : an s3fs.S3FileSystem class instance, optional</span>
<span class="sd">        A file-system to refer to. Default to create a new file-system.</span>
<span class="sd">    anon : bool</span>
<span class="sd">        Whether to use anonymous connection (public buckets only).</span>
<span class="sd">        If False, uses the key/secret given, or botos credential</span>
<span class="sd">        resolver (client_kwargs, environment, variables, config files,</span>
<span class="sd">        EC2 IAM server, in that order). Default: True</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    nib.Nifti1Image class instance</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Because the image is lazily loaded, data stored in the file</span>
<span class="sd">    is not transferred until `get_fdata` is called.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">fs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="n">s3fs</span><span class="o">.</span><span class="n">S3FileSystem</span><span class="p">(</span><span class="n">anon</span><span class="o">=</span><span class="n">anon</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">fs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span> <span class="k">as</span> <span class="n">ff</span><span class="p">:</span>
        <span class="n">zz</span> <span class="o">=</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">ff</span><span class="p">)</span>
        <span class="n">rr</span> <span class="o">=</span> <span class="n">zz</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">bb</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">(</span><span class="n">rr</span><span class="p">)</span>
        <span class="n">fh</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">FileHolder</span><span class="p">(</span><span class="n">fileobj</span><span class="o">=</span><span class="n">bb</span><span class="p">)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">Nifti1Image</span><span class="o">.</span><span class="n">from_file_map</span><span class="p">({</span><span class="s1">&#39;header&#39;</span><span class="p">:</span> <span class="n">fh</span><span class="p">,</span> <span class="s1">&#39;image&#39;</span><span class="p">:</span> <span class="n">fh</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">img</span>


<span class="k">def</span> <span class="nf">write_json</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write data to JSON file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fname : str</span>
<span class="sd">        Full path to the file to write.</span>

<span class="sd">    data : dict</span>
<span class="sd">        A dict containing the data to write.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ff</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ff</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="k">lambda</span> <span class="n">obj</span><span class="p">:</span> <span class="s2">&quot;Not Serializable&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">read_json</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read data from a JSON file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fname : str</span>
<span class="sd">        Full path to the data-containing file</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ff</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">ff</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>


<span class="k">def</span> <span class="nf">s3fs_json_read</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">anon</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads json directly from S3</span>

<span class="sd">    Paramters</span>
<span class="sd">    ---------</span>
<span class="sd">    fname : str</span>
<span class="sd">        Full path (including bucket name and extension) to the file on S3.</span>
<span class="sd">    fs : an s3fs.S3FileSystem class instance, optional</span>
<span class="sd">        A file-system to refer to. Default to create a new file-system.</span>
<span class="sd">    anon : bool</span>
<span class="sd">        Whether to use anonymous connection (public buckets only).</span>
<span class="sd">        If False, uses the key/secret given, or botos credential</span>
<span class="sd">        resolver (client_kwargs, environment, variables, config files,</span>
<span class="sd">        EC2 IAM server, in that order). Default: True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">fs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="n">s3fs</span><span class="o">.</span><span class="n">S3FileSystem</span><span class="p">(</span><span class="n">anon</span><span class="o">=</span><span class="n">anon</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">fs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span> <span class="k">as</span> <span class="n">ff</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">ff</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data</span>


<span class="k">def</span> <span class="nf">s3fs_json_write</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Writes json from a dict directly into S3</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : dict</span>
<span class="sd">        The json to be written out</span>
<span class="sd">    fname : str</span>
<span class="sd">        Full path (including bucket name and extension) to the file to</span>
<span class="sd">        be written out on S3</span>
<span class="sd">    fs : an s3fs.S3FileSystem class instance, optional</span>
<span class="sd">        A file-system to refer to. Default to create a new file-system.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">fs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="n">s3fs</span><span class="o">.</span><span class="n">S3FileSystem</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">fs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ff</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ff</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_apply_mask</span><span class="p">(</span><span class="n">template_img</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper function, gets MNI brain mask and applies it to template_img.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    template_img : nib.Nifti1Image</span>
<span class="sd">        Unmasked template</span>
<span class="sd">    resolution : int, optional</span>
<span class="sd">        Resolution of mask. Default: 1</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Masked template as nib.Nifti1Image</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mask_img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">tflow</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;MNI152NLin2009cAsym&#39;</span><span class="p">,</span>
                                      <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">,</span>
                                      <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;brain&#39;</span><span class="p">,</span>
                                      <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;mask&#39;</span><span class="p">)))</span>

    <span class="n">template_data</span> <span class="o">=</span> <span class="n">template_img</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>
    <span class="n">mask_data</span> <span class="o">=</span> <span class="n">mask_img</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">mask_data</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">template_data</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
        <span class="n">mask_img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">Nifti1Image</span><span class="p">(</span>
            <span class="n">resample</span><span class="p">(</span>
                <span class="n">mask_data</span><span class="p">,</span>
                <span class="n">template_data</span><span class="p">,</span>
                <span class="n">mask_img</span><span class="o">.</span><span class="n">affine</span><span class="p">,</span>
                <span class="n">template_img</span><span class="o">.</span><span class="n">affine</span><span class="p">)</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">(),</span>
            <span class="n">template_img</span><span class="o">.</span><span class="n">affine</span><span class="p">)</span>
        <span class="n">mask_data</span> <span class="o">=</span> <span class="n">mask_img</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>

    <span class="n">out_data</span> <span class="o">=</span> <span class="n">template_data</span> <span class="o">*</span> <span class="n">mask_data</span>
    <span class="k">return</span> <span class="n">nib</span><span class="o">.</span><span class="n">Nifti1Image</span><span class="p">(</span><span class="n">out_data</span><span class="p">,</span> <span class="n">template_img</span><span class="o">.</span><span class="n">affine</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">read_mni_template</span><span class="p">(</span><span class="n">resolution</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s2">&quot;T2w&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Reads the MNI T1w or T2w template</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    resolution : int, optional.</span>
<span class="sd">        Either 1 or 2, the resolution in mm of the voxels. Default: 1.</span>

<span class="sd">    mask : bool, optional</span>
<span class="sd">        Whether to mask the data with a brain-mask before returning the image.</span>
<span class="sd">        Default : True</span>

<span class="sd">    weight: str, optional</span>
<span class="sd">        Which relaxation technique to use.</span>
<span class="sd">        Should be either &quot;T2w&quot; or &quot;T1w&quot;.</span>
<span class="sd">        Default : &quot;T2w&quot;</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    nib.Nifti1Image class instance</span>
<span class="sd">    containing masked or unmasked T1w or template.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">template_img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">tflow</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;MNI152NLin2009cAsym&#39;</span><span class="p">,</span>
                                          <span class="n">desc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                          <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">,</span>
                                          <span class="n">suffix</span><span class="o">=</span><span class="n">weight</span><span class="p">,</span>
                                          <span class="n">extension</span><span class="o">=</span><span class="s1">&#39;nii.gz&#39;</span><span class="p">)))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">mask</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">template_img</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_apply_mask</span><span class="p">(</span><span class="n">template_img</span><span class="p">,</span> <span class="n">resolution</span><span class="p">)</span>


<span class="n">fetch_biobank_templates</span> <span class="o">=</span> \
    <span class="n">_make_fetcher</span><span class="p">(</span>
        <span class="s2">&quot;fetch_biobank_templates&quot;</span><span class="p">,</span>
        <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">afq_home</span><span class="p">,</span>
                <span class="s1">&#39;biobank_templates&#39;</span><span class="p">),</span>
        <span class="s2">&quot;http://biobank.ctsu.ox.ac.uk/showcase/showcase/docs/&quot;</span><span class="p">,</span>
        <span class="p">[</span><span class="s2">&quot;bmri_group_means.zip&quot;</span><span class="p">],</span>
        <span class="p">[</span><span class="s2">&quot;bmri_group_means.zip&quot;</span><span class="p">],</span>
        <span class="n">data_size</span><span class="o">=</span><span class="s2">&quot;1.1 GB&quot;</span><span class="p">,</span>
        <span class="n">doc</span><span class="o">=</span><span class="s2">&quot;Download UK Biobank templates&quot;</span><span class="p">,</span>
        <span class="n">unzip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">read_ukbb_fa_template</span><span class="p">(</span><span class="n">mask</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads the UK Biobank FA template</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mask : bool, optional</span>
<span class="sd">        Whether to mask the data with a brain-mask before returning the image.</span>
<span class="sd">        Default : True</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    nib.Nifti1Image class instance containing the FA template.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fa_folder</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">afq_home</span><span class="p">,</span>
        <span class="s1">&#39;biobank_templates&#39;</span><span class="p">,</span>
        <span class="s1">&#39;UKBiobank_BrainImaging_GroupMeanTemplates&#39;</span>
    <span class="p">)</span>
    <span class="n">fa_path</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">fa_folder</span><span class="p">,</span>
        <span class="s1">&#39;dti_FA.nii.gz&#39;</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">op</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fa_path</span><span class="p">):</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;AFQ.data&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s2">&quot;Downloading brain MRI group mean statistics from UK Biobank. &quot;</span>
            <span class="o">+</span> <span class="s2">&quot;This download is approximately 1.1 GB. &quot;</span>
            <span class="o">+</span> <span class="s2">&quot;It is currently necessary to access the FA template.&quot;</span><span class="p">)</span>

        <span class="n">files</span><span class="p">,</span> <span class="n">folder</span> <span class="o">=</span> <span class="n">fetch_biobank_templates</span><span class="p">()</span>

        <span class="c1"># remove zip</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>

        <span class="c1"># remove non-FA related directories</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">fa_folder</span><span class="p">):</span>
            <span class="n">full_path</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fa_folder</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">full_path</span> <span class="o">!=</span> <span class="n">fa_path</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">full_path</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">full_path</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">full_path</span><span class="p">)</span>

    <span class="n">template_img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fa_path</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">mask</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">template_img</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_apply_mask</span><span class="p">(</span><span class="n">template_img</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>

              </div>
              
              
              <div class='prev-next-bottom'>
                

              </div>
              
          </main>
          

      </div>
    </div>

    
  <script src="../../_static/js/index.1e043a052b0af929e4d8.js"></script>


    
<footer class="footer mt-5 mt-md-0">
  <div class="container">
    <p>
          &copy; Copyright 2018, Ariel Rokem.<br/>
        Created using <a href="http://sphinx-doc.org/">Sphinx</a> 3.5.3.<br/>
    </p>
  </div>
</footer>
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
var pageTracker = _gat._getTracker("UA-156363454-2");
pageTracker._trackPageview();
} catch(err) {}</script>

  </body>
</html>